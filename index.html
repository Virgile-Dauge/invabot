<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-05-04 mer. 16:42 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Invabot</title>
<meta name="author" content="Virgile" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<style type="text/css">
 pre.src {background-color: #263238; color: #EEFFFF;}</style>
<style type="text/css">
 pre.src {background-color: #263238; color: #EEFFFF;}</style>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Invabot</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org0762198">1. Algorithme d'attribution des rôles</a>
<ul>
<li><a href="#orgb86ec5b">1.1. Principe</a></li>
<li><a href="#org09c063d">1.2. Licence</a></li>
<li><a href="#org7f8b971">1.3. Dépendances</a></li>
<li><a href="#org63fb33b">1.4. Données d'entrée</a>
<ul>
<li><a href="#orgc4011c7">1.4.1. Données de test</a></li>
</ul>
</li>
<li><a href="#org63e2d66">1.5. Identification des rôles à attribuer</a></li>
<li><a href="#org40ab7ce">1.6. Matrice de coûts</a></li>
<li><a href="#org02ce758">1.7. Résolution</a></li>
<li><a href="#org51ebf05">1.8. Exploitation des résultats</a></li>
<li><a href="#org6385db1">1.9. Processus complet</a></li>
<li><a href="#orgfc4804b">1.10. Test algorithme</a></li>
</ul>
</li>
<li><a href="#org82be758">2. Bot</a>
<ul>
<li><a href="#org0f43023">2.1. Concept :</a></li>
<li><a href="#org2368134">2.2. Configuration</a></li>
<li><a href="#org69e31db">2.3. Utilitaires</a>
<ul>
<li><a href="#orgd461532">2.3.1. Licence</a></li>
<li><a href="#org3250796">2.3.2. Dépendances</a></li>
<li><a href="#org54666e5">2.3.3. Chargement de la configuration du bot</a></li>
<li><a href="#org4468b29">2.3.4. Chargement du token</a></li>
<li><a href="#orgdf32c16">2.3.5. Identifier de manière unique les utilisateurs</a></li>
<li><a href="#org2586b12">2.3.6. Récupération du roster</a></li>
<li><a href="#orgf5ef944">2.3.7. Récupération de la strat</a></li>
</ul>
</li>
<li><a href="#org42a65be">2.4. Corp</a></li>
<li><a href="#org8b3aa55">2.5. Slash commands</a>
<ul>
<li><a href="#org1190aa6">2.5.1. Commande invasion</a></li>
<li><a href="#orgd2b7a39">2.5.2. Commande verif</a></li>
<li><a href="#org368bc71">2.5.3. Commande transfert</a></li>
<li><a href="#org7997f21">2.5.4. Commande Instance</a></li>
<li><a href="#org3759d32">2.5.5. Commande event</a></li>
</ul>
</li>
<li><a href="#orgca8720e">2.6. Gestion des réactions aux messages</a>
<ul>
<li><a href="#orge0b57cb">2.6.1. On reaction add</a></li>
<li><a href="#org30ecf2d">2.6.2. On reaction remove</a></li>
<li><a href="#orgb8276b4">2.6.3. On s'assure que le joueur soit enregistré</a></li>
<li><a href="#org2b85d7a">2.6.4. Gestion ajout réaction message Instance</a></li>
<li><a href="#orgc22fb9d">2.6.5. Gestion annulation réaction message Instance</a></li>
</ul>
</li>
<li><a href="#org293cd9c">2.7. Gestion des changement d'état vocaux</a></li>
</ul>
</li>
<li><a href="#org1a82c7b">3. Test ui</a>
<ul>
<li><a href="#orgf30487c">3.1. Modal (sorte de formulaire)</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
This file is part of Invabot.
</p>

<p>
Invabot is free software: you can redistribute it
and/or modify it under the terms of the GNU General
Public License as published by the Free Software
Foundation, either version 3 of the License, or
any later version.
</p>

<p>
Invabot is distributed in the hope that it will be
useful, but WITHOUT ANY WARRANTY; without even the
implied warranty of MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE. See the GNU General Public License
for more details.
</p>

<p>
You should have received a copy of the GNU General
Public License along with Invabot. If not, see
<a href="https://www.gnu.org/licenses/">https://www.gnu.org/licenses/</a>
</p>

<div id="outline-container-org0762198" class="outline-2">
<h2 id="org0762198"><span class="section-number-2">1.</span> Algorithme d'attribution des rôles</h2>
<div class="outline-text-2" id="text-1">
<p>
Cette section définit l'algorithme d'attribution des rôles, qui est
indépendant de <i>Discord</i>.
</p>
</div>

<div id="outline-container-orgb86ec5b" class="outline-3">
<h3 id="orgb86ec5b"><span class="section-number-3">1.1.</span> Principe</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Attribuer un rôle à chaque joueur, en optimisant la pertinence totale
des attributions.
</p>
</div>
</div>
<div id="outline-container-org09c063d" class="outline-3">
<h3 id="org09c063d"><span class="section-number-3">1.2.</span> Licence</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #556369;"># </span><span style="color: #556369;">This file is part of Invabot.</span>

<span style="color: #556369;"># </span><span style="color: #556369;">Invabot is free software: you can redistribute it</span>
<span style="color: #556369;"># </span><span style="color: #556369;">and/or modify it under the terms of the GNU General</span>
<span style="color: #556369;"># </span><span style="color: #556369;">Public License as published by the Free Software</span>
<span style="color: #556369;"># </span><span style="color: #556369;">Foundation, either version 3 of the License, or</span>
<span style="color: #556369;"># </span><span style="color: #556369;">any later version.</span>

<span style="color: #556369;"># </span><span style="color: #556369;">Invabot is distributed in the hope that it will be</span>
<span style="color: #556369;"># </span><span style="color: #556369;">useful, but WITHOUT ANY WARRANTY; without even the</span>
<span style="color: #556369;"># </span><span style="color: #556369;">implied warranty of MERCHANTABILITY or FITNESS FOR A</span>
<span style="color: #556369;"># </span><span style="color: #556369;">PARTICULAR PURPOSE. See the GNU General Public License</span>
<span style="color: #556369;"># </span><span style="color: #556369;">for more details.</span>

<span style="color: #556369;"># </span><span style="color: #556369;">You should have received a copy of the GNU General</span>
<span style="color: #556369;"># </span><span style="color: #556369;">Public License along with Invabot. If not, see</span>
<span style="color: #556369;"># </span><span style="color: #556369;"><a href="https://www.gnu.org/licenses/">&lt;https://www.gnu.org/licenses/&gt;</a></span>

</pre>
</div>
</div>
</div>

<div id="outline-container-org7f8b971" class="outline-3">
<h3 id="org7f8b971"><span class="section-number-3">1.3.</span> Dépendances</h3>
<div class="outline-text-3" id="text-1-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">import</span> numpy <span style="color: #89DDFF;">as</span> np
<span style="color: #89DDFF;">import</span> pandas <span style="color: #89DDFF;">as</span> pd
<span style="color: #89DDFF;">from</span> scipy.optimize <span style="color: #89DDFF;">import</span> linear_sum_assignment

<span style="color: #89DDFF;">from</span> typing <span style="color: #89DDFF;">import</span> Dict, List, Tuple
<span style="color: #89DDFF;">import</span> numpy.typing <span style="color: #89DDFF;">as</span> npt

<span style="color: #ffcb6b;">NDArrayInt</span> = npt.NDArray<span style="color: #c792ea;">[</span>np.int_<span style="color: #c792ea;">]</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org63fb33b" class="outline-3">
<h3 id="org63fb33b"><span class="section-number-3">1.4.</span> Données d'entrée</h3>
<div class="outline-text-3" id="text-1-4">
<p>
Les données d'entrées sont :
</p>
<dl class="org-dl">
<dt>un roster</dt><dd>un ensemble de joueurs représenté par une
<a href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.html">DataFrame</a>. Chaque ligne de cette structure représente un joueur
ainsi que sa compétence (un entier) pour chaque rôle prédéfini.</dd>

<dt>une stratégie</dt><dd>un ensemble de rôles à attribuer,
représenté par une <a href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.html">DataFrame</a>, et structuré sous forme de groupes.</dd>
</dl>
</div>

<div id="outline-container-orgc4011c7" class="outline-4">
<h4 id="orgc4011c7"><span class="section-number-4">1.4.1.</span> Données de test</h4>
<div class="outline-text-4" id="text-1-4-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">get_test_roster</span><span style="color: #c792ea;">()</span>:
    <span style="color: #ffcb6b;">url</span> = <span style="color: #c3e88d;">"https://docs.google.com/spreadsheets/d/1FgtMvUQbLxP7qvXt2tnVwFFyX9KWnuREHu7o0RtX13M/gviz/tq?tqx=out:csv&amp;sheet=Roster"</span>
    <span style="color: #89DDFF;">return</span> pd.read_csv<span style="color: #c792ea;">(</span>url<span style="color: #c792ea;">)</span>.set_index<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'dtag'</span><span style="color: #c792ea;">)</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">get_test_strat</span><span style="color: #c792ea;">()</span>:
    <span style="color: #ffcb6b;">url</span> = <span style="color: #c3e88d;">"https://docs.google.com/spreadsheets/d/1FgtMvUQbLxP7qvXt2tnVwFFyX9KWnuREHu7o0RtX13M/gviz/tq?tqx=out:csv&amp;sheet=Strat_principale"</span>
    <span style="color: #ffcb6b;">page</span> = pd.read_csv<span style="color: #c792ea;">(</span>url<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">return</span> page.iloc<span style="color: #c792ea;">[</span>0:5, 0:10<span style="color: #c792ea;">]</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org63e2d66" class="outline-3">
<h3 id="org63e2d66"><span class="section-number-3">1.5.</span> Identification des rôles à attribuer</h3>
<div class="outline-text-3" id="text-1-5">
<p>
La première étape consiste à extraire, depuis la stratégie d'entrée,
les rôles à attribuer.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">extraction_roles</span><span style="color: #c792ea;">(</span>strat: pd.DataFrame<span style="color: #c792ea;">)</span> -&gt; <span style="color: #ffcb6b;">Dict</span><span style="color: #c792ea;">[</span><span style="color: #82aaff;">str</span>, <span style="color: #82aaff;">int</span><span style="color: #c792ea;">]</span>:
    roles = <span style="color: #c792ea;">{}</span>
    <span style="color: #89DDFF;">for</span> index, row <span style="color: #89DDFF;">in</span> strat.iterrows<span style="color: #c792ea;">()</span>:
        <span style="color: #89DDFF;">for</span> v <span style="color: #89DDFF;">in</span> <span style="color: #ffcb6b;">row</span>:
            v = v.split<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">' '</span><span style="color: #c792ea;">)[</span>0<span style="color: #c792ea;">]</span>
            <span style="color: #89DDFF;">if</span> v <span style="color: #89DDFF;">in</span> <span style="color: #ffcb6b;">roles</span>:
                roles<span style="color: #c792ea;">[</span><span style="color: #ffcb6b;">v</span><span style="color: #c792ea;">]</span> += 1
            <span style="color: #89DDFF;">else</span>:
                roles<span style="color: #c792ea;">[</span><span style="color: #ffcb6b;">v</span><span style="color: #c792ea;">]</span> = 1
    <span style="color: #89DDFF;">return</span> roles
</pre>
</div>
</div>
</div>

<div id="outline-container-org40ab7ce" class="outline-3">
<h3 id="org40ab7ce"><span class="section-number-3">1.6.</span> Matrice de coûts</h3>
<div class="outline-text-3" id="text-1-6">
<p>
Maintenant que les rôles sont déterminés, l'objectif est d'affecter
pour chacun un joueur. C'est un classique d'optimisation combinatoire,
connu sous le terme de problème d'<a href="https://en.wikipedia.org/wiki/Assignment_problem">affectation</a>.
</p>

<p>
La programmation linéaire est une technique éprouvée pour résoudre ce
problème. L'idée est de représenter le problème par une matrice \(C\) de
pertinence (ou de coût si minimisation), où chaque élément \(C_{i,j}\)
représente la pertinence d'attribuer le rôle \(i\) au joueur \(j\).
</p>

<p>
Nous avons besoin de créer la matrice \(C\) ainsi que des labels de
lignes <i>rows</i> et de colonnes <i>cols</i> faisant le lien entre les index
\(i\) et \(j\) et les noms de rôles/joueurs.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org06d8b97"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">matrice_cout</span><span style="color: #c792ea;">(</span>roles: pd.DataFrame, roster: pd.DataFrame<span style="color: #c792ea;">)</span> -&gt; Tuple<span style="color: #c792ea;">[</span>List<span style="color: #f78c6c;">[</span><span style="color: #82aaff;">str</span><span style="color: #f78c6c;">]</span>, List<span style="color: #f78c6c;">[</span><span style="color: #82aaff;">str</span><span style="color: #f78c6c;">]</span>, NDArrayInt<span style="color: #c792ea;">]</span>:
    <span style="color: #ffcb6b;">cols</span> = <span style="color: #c792ea;">[</span>k <span style="color: #89DDFF;">for</span> k, v <span style="color: #89DDFF;">in</span> roles.items<span style="color: #f78c6c;">()</span> <span style="color: #89DDFF;">for</span> _ <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">range</span><span style="color: #f78c6c;">(</span>v<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">]</span>
    <span style="color: #ffcb6b;">rows</span> = roster.index

    <span style="color: #ffcb6b;">C</span> = np.zeros<span style="color: #c792ea;">(</span><span style="color: #f78c6c;">(</span><span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>rows<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>cols<span style="color: #c3e88d;">)</span><span style="color: #f78c6c;">)</span>, dtype=<span style="color: #82aaff;">int</span><span style="color: #c792ea;">)</span>

    <span style="color: #89DDFF;">for</span> i, r <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">enumerate</span><span style="color: #c792ea;">(</span>rows<span style="color: #c792ea;">)</span>:
        <span style="color: #89DDFF;">for</span> j, c <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">enumerate</span><span style="color: #c792ea;">(</span>cols<span style="color: #c792ea;">)</span>:
            C<span style="color: #c792ea;">[</span><span style="color: #ffcb6b;">i</span>, <span style="color: #ffcb6b;">j</span><span style="color: #c792ea;">]</span> = <span style="color: #82aaff;">int</span><span style="color: #c792ea;">(</span>roster.at<span style="color: #f78c6c;">[</span>r, c<span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">return</span> rows, cols, C
</pre>
</div>
</div>
</div>

<div id="outline-container-org02ce758" class="outline-3">
<h3 id="org02ce758"><span class="section-number-3">1.7.</span> Résolution</h3>
<div class="outline-text-3" id="text-1-7">
<p>
Puis, il faut trouver la matrice d'assignation \(X\) qui va maximiser la
pertinence totale de la manière suivante :
</p>

<p>
\[max \sum_{i} \sum_{j} C_{i,j} X_{i,j}\]
</p>

<p>
Nous utiliserons pour cela la fonction <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.linear_sum_assignment.html">linear_sum_assignment</a> de
<a href="https://docs.scipy.org/doc/scipy/index.html">Scipy</a>. Ensuite, nous créons un dictionnaire avec les assignations
choisies.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">solve</span><span style="color: #c792ea;">(</span>rows: List<span style="color: #f78c6c;">[</span><span style="color: #82aaff;">str</span><span style="color: #f78c6c;">]</span>, cols: List<span style="color: #f78c6c;">[</span><span style="color: #82aaff;">str</span><span style="color: #f78c6c;">]</span>, C: NDArrayInt<span style="color: #c792ea;">)</span> -&gt; <span style="color: #ffcb6b;">Dict</span><span style="color: #c792ea;">[</span><span style="color: #82aaff;">str</span>, <span style="color: #82aaff;">str</span><span style="color: #c792ea;">]</span>:
    <span style="color: #ffcb6b;">row_ind</span>, <span style="color: #ffcb6b;">X</span> = linear_sum_assignment<span style="color: #c792ea;">(</span>C, maximize=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>
    <span style="color: #556369;"># </span><span style="color: #556369;">score = C[row_ind, X].sum()</span>
    <span style="color: #89DDFF;">return</span> <span style="color: #c792ea;">{</span>p: cols<span style="color: #f78c6c;">[</span>t<span style="color: #f78c6c;">]</span> <span style="color: #89DDFF;">for</span> p, t <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">zip</span><span style="color: #f78c6c;">(</span>rows, X<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org51ebf05" class="outline-3">
<h3 id="org51ebf05"><span class="section-number-3">1.8.</span> Exploitation des résultats</h3>
<div class="outline-text-3" id="text-1-8">
<p>
Remplissage de la composition des groupes en fonciton des assignations
calculées.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">creation_compo</span><span style="color: #c792ea;">(</span>assignations: Dict<span style="color: #f78c6c;">[</span><span style="color: #82aaff;">str</span>, <span style="color: #82aaff;">str</span><span style="color: #f78c6c;">]</span>, strat: pd.DataFrame, roster: pd.DataFrame<span style="color: #c792ea;">)</span> -&gt; pd.<span style="color: #ffcb6b;">DataFrame</span>:
    filed_roles = <span style="color: #c792ea;">{}</span>
    <span style="color: #89DDFF;">for</span> k, v <span style="color: #89DDFF;">in</span> assignations.items<span style="color: #c792ea;">()</span>:
        <span style="color: #89DDFF;">if</span> v <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> <span style="color: #ffcb6b;">filed_roles</span>:
            filed_roles<span style="color: #c792ea;">[</span><span style="color: #ffcb6b;">v</span><span style="color: #c792ea;">]</span> = <span style="color: #c792ea;">[</span>k<span style="color: #c792ea;">]</span>
        <span style="color: #89DDFF;">else</span>:
            filed_roles<span style="color: #c792ea;">[</span><span style="color: #ffcb6b;">v</span><span style="color: #c792ea;">]</span> += <span style="color: #c792ea;">[</span>k<span style="color: #c792ea;">]</span>

    <span style="color: #ffcb6b;">max_roles</span> = <span style="color: #c792ea;">{</span><span style="color: #ffcb6b;">k</span>: v.<span style="color: #82aaff;">max</span><span style="color: #f78c6c;">()</span> <span style="color: #89DDFF;">for</span> k,v <span style="color: #89DDFF;">in</span> roster.iteritems<span style="color: #f78c6c;">()</span><span style="color: #c792ea;">}</span>

    comp = strat.copy<span style="color: #c792ea;">()</span>
    <span style="color: #89DDFF;">for</span> i, row <span style="color: #89DDFF;">in</span> comp.iterrows<span style="color: #c792ea;">()</span>:
        <span style="color: #89DDFF;">for</span> j, v <span style="color: #89DDFF;">in</span> row.items<span style="color: #c792ea;">()</span>:
            <span style="color: #ffcb6b;">label</span> = <span style="color: #c3e88d;">''</span>
            <span style="color: #89DDFF;">if</span> <span style="color: #82aaff;">len</span><span style="color: #c792ea;">(</span>v.split<span style="color: #f78c6c;">(</span><span style="color: #c3e88d;">' '</span><span style="color: #f78c6c;">)</span><span style="color: #c792ea;">)</span> &gt; 1:
                <span style="color: #ffcb6b;">v</span>, <span style="color: #ffcb6b;">label</span> = v.split<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">' '</span><span style="color: #c792ea;">)</span>
            <span style="color: #89DDFF;">if</span> v <span style="color: #89DDFF;">in</span> filed_roles <span style="color: #89DDFF;">and</span> <span style="color: #ffcb6b;">filed_roles</span><span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span>:
                p = filed_roles<span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span>.pop<span style="color: #c792ea;">()</span>
                <span style="color: #ffcb6b;">role_txt</span> = f<span style="color: #c3e88d;">"[</span>{comp.at[i, j]}<span style="color: #c3e88d;">](</span>{config['doc']['url']}<span style="color: #c3e88d;">)"</span>
                comp.<span style="color: #ffcb6b;">at</span><span style="color: #c792ea;">[</span><span style="color: #ffcb6b;">i</span>, <span style="color: #ffcb6b;">j</span><span style="color: #c792ea;">]</span> = f<span style="color: #c3e88d;">'</span>{p}<span style="color: #c3e88d;"> *</span>{role_txt}<span style="color: #c3e88d;">* </span>{roster.at[p, v] / max_roles[v]:.1f}<span style="color: #c3e88d;">'</span>
    <span style="color: #89DDFF;">return</span> comp
</pre>
</div>
</div>
</div>
<div id="outline-container-org6385db1" class="outline-3">
<h3 id="org6385db1"><span class="section-number-3">1.9.</span> Processus complet</h3>
<div class="outline-text-3" id="text-1-9">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">build_comp</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">roster</span>: pd.DataFrame, strat: pd.DataFrame, config<span style="color: #c792ea;">)</span>:
    roles = extraction_roles<span style="color: #c792ea;">(</span>strat<span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">assignation</span> = solve<span style="color: #c792ea;">(</span>*matrice_cout<span style="color: #f78c6c;">(</span>roles, roster<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">return</span> creation_compo<span style="color: #c792ea;">(</span>assignation, strat, roster<span style="color: #c792ea;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfc4804b" class="outline-3">
<h3 id="orgfc4804b"><span class="section-number-3">1.10.</span> Test algorithme</h3>
<div class="outline-text-3" id="text-1-10">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">import</span> json
&lt;&lt;config&gt;&gt;
<span style="color: #89DDFF;">if</span> <span style="color: #82aaff;">__name__</span> == <span style="color: #c3e88d;">'__main__'</span>:
    <span style="color: #89DDFF;">with</span> <span style="color: #82aaff;">open</span><span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'config.json'</span>, <span style="color: #c3e88d;">'r'</span><span style="color: #c792ea;">)</span> <span style="color: #89DDFF;">as</span> datafile:
        config = json.load<span style="color: #c792ea;">(</span>datafile<span style="color: #c792ea;">)</span>
    roster = get_test_roster<span style="color: #c792ea;">()</span>
    roster.to_csv<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'roster.csv'</span><span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">print</span><span style="color: #c792ea;">(</span>roster<span style="color: #c792ea;">)</span>
    strat = get_test_strat<span style="color: #c792ea;">()</span>
    strat.to_csv<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'strat.csv'</span><span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">print</span><span style="color: #c792ea;">(</span>strat<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">print</span><span style="color: #c792ea;">(</span>build_comp<span style="color: #f78c6c;">(</span>roster, strat, config<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">)</span>
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-org82be758" class="outline-2">
<h2 id="org82be758"><span class="section-number-2">2.</span> Bot</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org0f43023" class="outline-3">
<h3 id="org0f43023"><span class="section-number-3">2.1.</span> Concept :</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Le bot à pour objectif de générer une composition d'armée à partir des
50 joueurs sélectionnés aléatoirement par le jeu.
</p>
</div>
</div>

<div id="outline-container-org2368134" class="outline-3">
<h3 id="org2368134"><span class="section-number-3">2.2.</span> Configuration</h3>
<div class="outline-text-3" id="text-2-2">
<p>
La configuration du bot passera par un fichier json unique, contenant
le corps des différents messages à transmettre ainsi que les adresses
des Gdoc à lire.
</p>
<div class="org-src-container">
<pre class="src src-json"><span style="color: #c792ea;">{</span>
<span style="color: #89DDFF;">"ids"</span>: <span style="color: #f78c6c;">{</span>
    <span style="color: #89DDFF;">"role"</span>: <span style="color: #f78c6c;">917546013248606238</span>,
    <span style="color: #89DDFF;">"leads"</span>: <span style="color: #f78c6c;">928316217297612810</span>
<span style="color: #f78c6c;">}</span>,
<span style="color: #89DDFF;">"doc"</span>:<span style="color: #f78c6c;">{</span>
    <span style="color: #89DDFF;">"url"</span>: <span style="color: #c3e88d;">"https://virgile-dauge.github.io/invabot/"</span>
<span style="color: #f78c6c;">}</span>,
<span style="color: #89DDFF;">"imgs"</span>: <span style="color: #f78c6c;">{</span>
    <span style="color: #89DDFF;">"layout"</span>: <span style="color: #c3e88d;">"https://cdn.discordapp.com/attachments/917547596640296990/922901028519706674/layout.png"</span>
<span style="color: #f78c6c;">}</span>,
<span style="color: #89DDFF;">"embeds"</span>: <span style="color: #f78c6c;">{</span>
    <span style="color: #89DDFF;">"panneau"</span>: <span style="color: #c3e88d;">{</span>
        <span style="color: #89DDFF;">"title"</span>: <span style="color: #c3e88d;">"Confirme ta s&#233;l&#233;ction &#224; l'invasion de"</span>,
        <span style="color: #89DDFF;">"color"</span>: <span style="color: #f78c6c;">2003199</span>,
        <span style="color: #89DDFF;">"description"</span>: <span style="color: #c3e88d;">"R&#233;agis avec :ballot_box_with_check: &#224; ce message **uniquement si tu es d&#233;j&#224; dans le fort**. Attention, retourne vite en jeu, l'auto-AFK kick est rapide (2min). \n\n Si tu as r&#233;agi par erreur, merci de d&#233;cocher ta r&#233;action. :wink: \n\n*(Et si vous aussi vous pensez que bakhu est la meilleure guilde)*"</span>
    <span style="color: #c3e88d;">}</span>,
    <span style="color: #89DDFF;">"dm"</span>: <span style="color: #c3e88d;">{</span>
        <span style="color: #89DDFF;">"title"</span>: <span style="color: #c3e88d;">"Dis nous tout !"</span>,
        <span style="color: #89DDFF;">"color"</span>: <span style="color: #f78c6c;">2003199</span>,
        <span style="color: #89DDFF;">"description"</span>: <span style="color: #c3e88d;">"Tu es inscrit en invasion, mais tu n'as pas renseign&#233; **les r&#244;les** que tu peux jouer. Il n'est donc par cons&#233;quent pas possible de t'assigner un poste automatiquement. Allez, file remplir [ce document]("</span>
    <span style="color: #c3e88d;">}</span>,
    <span style="color: #89DDFF;">"change"</span>: <span style="color: #c3e88d;">{</span>
        <span style="color: #89DDFF;">"title"</span>: <span style="color: #c3e88d;">"Tu as chang&#233; ton discord TAG :/"</span>,
        <span style="color: #89DDFF;">"color"</span>: <span style="color: #f78c6c;">2003199</span>,
        <span style="color: #89DDFF;">"description"</span>: <span style="color: #c3e88d;">"Il faut mettre &#224; jour tes infos. Allez, file remplir [ce document]("</span>
    <span style="color: #c3e88d;">}</span>,
    <span style="color: #89DDFF;">"help"</span>: <span style="color: #c3e88d;">{</span>
        <span style="color: #89DDFF;">"title"</span>: <span style="color: #c3e88d;">"Manuel d'utilisation d'invabot"</span>,
        <span style="color: #89DDFF;">"color"</span>: <span style="color: #f78c6c;">2003199</span>,
        <span style="color: #89DDFF;">"fields"</span>: <span style="color: #89DDFF;">[</span><span style="color: #bb80b3;">{</span><span style="color: #89DDFF;">"name"</span>: <span style="color: #c3e88d;">"Blue Team"</span>, <span style="color: #89DDFF;">"value"</span>: <span style="color: #c3e88d;">"Something"</span>, <span style="color: #89DDFF;">"inline"</span> : <span style="color: #c3e88d;">"True"</span><span style="color: #bb80b3;">}</span><span style="color: #89DDFF;">]</span>
    <span style="color: #c3e88d;">}</span>
<span style="color: #f78c6c;">}</span>,
<span style="color: #89DDFF;">"gdoc"</span>: <span style="color: #f78c6c;">{</span>
    <span style="color: #89DDFF;">"url"</span>: <span style="color: #c3e88d;">"https://docs.google.com/spreadsheets/d/1FgtMvUQbLxP7qvXt2tnVwFFyX9KWnuREHu7o0RtX13M/"</span>,
    <span style="color: #89DDFF;">"strats"</span>: <span style="color: #c3e88d;">{</span>
        <span style="color: #89DDFF;">"Principale"</span>: <span style="color: #c3e88d;">"Strat_principale"</span>,
        <span style="color: #89DDFF;">"Secours"</span>: <span style="color: #c3e88d;">"Strat_secours"</span>
    <span style="color: #c3e88d;">}</span>,
    <span style="color: #89DDFF;">"page_roster"</span>: <span style="color: #c3e88d;">"Roster"</span>,
    <span style="color: #89DDFF;">"form"</span>: <span style="color: #c3e88d;">"https://forms.gle/G9LizybajjVxCw6JA"</span>
<span style="color: #f78c6c;">}</span>
<span style="color: #c792ea;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org69e31db" class="outline-3">
<h3 id="org69e31db"><span class="section-number-3">2.3.</span> Utilitaires</h3>
<div class="outline-text-3" id="text-2-3">
</div>
<div id="outline-container-orgd461532" class="outline-4">
<h4 id="orgd461532"><span class="section-number-4">2.3.1.</span> Licence</h4>
<div class="outline-text-4" id="text-2-3-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #556369;"># </span><span style="color: #556369;">This file is part of Invabot.</span>

<span style="color: #556369;"># </span><span style="color: #556369;">Invabot is free software: you can redistribute it</span>
<span style="color: #556369;"># </span><span style="color: #556369;">and/or modify it under the terms of the GNU General</span>
<span style="color: #556369;"># </span><span style="color: #556369;">Public License as published by the Free Software</span>
<span style="color: #556369;"># </span><span style="color: #556369;">Foundation, either version 3 of the License, or</span>
<span style="color: #556369;"># </span><span style="color: #556369;">any later version.</span>

<span style="color: #556369;"># </span><span style="color: #556369;">Invabot is distributed in the hope that it will be</span>
<span style="color: #556369;"># </span><span style="color: #556369;">useful, but WITHOUT ANY WARRANTY; without even the</span>
<span style="color: #556369;"># </span><span style="color: #556369;">implied warranty of MERCHANTABILITY or FITNESS FOR A</span>
<span style="color: #556369;"># </span><span style="color: #556369;">PARTICULAR PURPOSE. See the GNU General Public License</span>
<span style="color: #556369;"># </span><span style="color: #556369;">for more details.</span>

<span style="color: #556369;"># </span><span style="color: #556369;">You should have received a copy of the GNU General</span>
<span style="color: #556369;"># </span><span style="color: #556369;">Public License along with Invabot. If not, see</span>
<span style="color: #556369;"># </span><span style="color: #556369;"><a href="https://www.gnu.org/licenses/">&lt;https://www.gnu.org/licenses/&gt;</a></span>

</pre>
</div>
</div>
</div>
<div id="outline-container-org3250796" class="outline-4">
<h4 id="org3250796"><span class="section-number-4">2.3.2.</span> Dépendances</h4>
<div class="outline-text-4" id="text-2-3-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">import</span> json
<span style="color: #89DDFF;">import</span> pandas <span style="color: #89DDFF;">as</span> pd
<span style="color: #89DDFF;">from</span> algo <span style="color: #89DDFF;">import</span> build_comp
</pre>
</div>
</div>
</div>
<div id="outline-container-org54666e5" class="outline-4">
<h4 id="org54666e5"><span class="section-number-4">2.3.3.</span> Chargement de la configuration du bot</h4>
<div class="outline-text-4" id="text-2-3-3">
<p>
Le chargement de cette config se fera pour l'instant une seule fois au
démarrage du bot.
</p>
<div class="org-src-container">
<pre class="src src-python" id="org8033725"><span style="color: #89DDFF;">with</span> <span style="color: #82aaff;">open</span><span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'config.json'</span>, <span style="color: #c3e88d;">'r'</span><span style="color: #c792ea;">)</span> <span style="color: #89DDFF;">as</span> <span style="color: #ffcb6b;">datafile</span>:
    config = json.load<span style="color: #c792ea;">(</span>datafile<span style="color: #c792ea;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4468b29" class="outline-4">
<h4 id="org4468b29"><span class="section-number-4">2.3.4.</span> Chargement du token</h4>
<div class="outline-text-4" id="text-2-3-4">
<p>
Le <i>token discord</i> est nécessaire pour lier le programme à l'identité
<i>Discord</i> du bot. Il est évidemment privé et <b>ne dois jamais</b> être
inclus dans le dépôt Git.
</p>
<div class="org-src-container">
<pre class="src src-python" id="orgc0565bb"><span style="color: #556369;"># </span><span style="color: #556369;">Chargement du token</span>
<span style="color: #89DDFF;">with</span> <span style="color: #82aaff;">open</span><span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'bot.token'</span>, <span style="color: #c3e88d;">'r'</span><span style="color: #c792ea;">)</span> <span style="color: #89DDFF;">as</span> <span style="color: #ffcb6b;">datafile</span>:
    token = datafile.read<span style="color: #c792ea;">()</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgdf32c16" class="outline-4">
<h4 id="orgdf32c16"><span class="section-number-4">2.3.5.</span> Identifier de manière unique les utilisateurs</h4>
<div class="outline-text-4" id="text-2-3-5">
<p>
Il est nécessaire d'avoir un identifiant unique entre discord et le
gdoc pour faire le lien. Discord gère les identifiants sous forme d'un
entier appelé <i>snowflake</i>. Toutefois, il est difficilement accessible
pour les joueurs, et ce sont les joueurs qui vont devoir renseigner
leur identifiant unique sur le gdoc. Il est donc plus simple
d'utiliser ici le <b>discord tag</b>, par exemple `Virgile#1234`.
</p>

<p>
Je propose ici une rapide fonction d'aide pour récupérer le dtag
depuis un objet <i>discord.User</i> :
</p>
<div class="org-src-container">
<pre class="src src-python" id="org884ae18"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">dtag</span><span style="color: #c792ea;">(</span>user<span style="color: #c792ea;">)</span>:
    <span style="color: #89DDFF;">return</span> f<span style="color: #c3e88d;">'</span>{user.name}<span style="color: #c3e88d;">#</span>{user.discriminator}<span style="color: #c3e88d;">'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org2586b12" class="outline-4">
<h4 id="org2586b12"><span class="section-number-4">2.3.6.</span> Récupération du roster</h4>
<div class="outline-text-4" id="text-2-3-6">
<div class="org-src-container">
<pre class="src src-python" id="org548d865"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">get_roster</span><span style="color: #c792ea;">(</span>config<span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">url</span> = f<span style="color: #c3e88d;">"</span>{config['gdoc']['url']}<span style="color: #c3e88d;">gviz/tq?tqx=out:csv&amp;sheet=</span>{config['gdoc']['page_roster']}<span style="color: #c3e88d;">"</span>
    <span style="color: #556369;">#</span><span style="color: #556369;">return pd.read_csv(url).iloc[1:, 0:6].dropna().set_index('dtag')</span>
    <span style="color: #89DDFF;">return</span> pd.read_csv<span style="color: #c792ea;">(</span>url<span style="color: #c792ea;">)</span>.set_index<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'dtag'</span><span style="color: #c792ea;">)</span>
</pre>
</div>

<pre class="example" id="org52e31aa">
                Pseudo             0           1     2           3
dtag
Chopekk#1234   Chopekk    DPS-Debuff    Mousquet  Heal  Anti-trash
Virgile#2345  virgilio      Mousquet  Anti-trash  Répa        Arti
Virgile#3456     Tezig  Lance-flamme  Anti-trash   Arc        Arti
Carlito#4567      Slua    Anti-trash        Arti  Répa       Aucun
</pre>
</div>
</div>
<div id="outline-container-orgf5ef944" class="outline-4">
<h4 id="orgf5ef944"><span class="section-number-4">2.3.7.</span> Récupération de la strat</h4>
<div class="outline-text-4" id="text-2-3-7">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">get_strat</span><span style="color: #c792ea;">(</span>config, strat=<span style="color: #f78c6c;">None</span><span style="color: #c792ea;">)</span>:
    <span style="color: #89DDFF;">if</span> strat <span style="color: #89DDFF;">is</span> <span style="color: #f78c6c;">None</span>:
        url = f<span style="color: #c3e88d;">"</span>{config['gdoc']['url']}<span style="color: #c3e88d;">gviz/tq?tqx=out:csv&amp;sheet=</span>{config['gdoc']['page_strat']}<span style="color: #c3e88d;">"</span>
    <span style="color: #89DDFF;">else</span>:
        url = f<span style="color: #c3e88d;">"</span>{config['gdoc']['url']}<span style="color: #c3e88d;">gviz/tq?tqx=out:csv&amp;sheet=</span>{config['gdoc']['page_strat']}<span style="color: #c3e88d;">"</span>
    <span style="color: #89DDFF;">return</span> pd.read_csv<span style="color: #c792ea;">(</span>url<span style="color: #c792ea;">)</span>.iloc<span style="color: #c792ea;">[</span>0:5, 0:12<span style="color: #c792ea;">]</span>
</pre>
</div>

<pre class="example" id="org3768511">
     Groupe 1 Groupe 2    Groupe 3 Groupe 4    Groupe 5    Groupe 6    Groupe 7    Groupe 8 Groupe 9     Groupe 10
0  Anti-Trash      Arc  Anti-Trash      Arc  Anti-Trash    Mousquet  Anti-Trash    Mousquet     Répa  Lance-flamme
1        Heal      Arc        Heal      Arc        Heal    Mousquet        Heal    Mousquet     Répa  Lance-flamme
2  DPS-Debuff      Arc  DPS-Debuff      Arc  DPS-Debuff    Mousquet  DPS-Debuff    Mousquet     Répa  Lance-flamme
3  DPS-Debuff      Arc  DPS-Debuff      Arc  DPS-Debuff  DPS-Debuff  DPS-Debuff  DPS-Debuff     Répa  Lance-flamme
4        Arti     Arti        Arti     Arti        Arti        Arti        Arti        Arti     Répa  Lance-flamme
</pre>
</div>
</div>
</div>


<div id="outline-container-org42a65be" class="outline-3">
<h3 id="org42a65be"><span class="section-number-3">2.4.</span> Corp</h3>
<div class="outline-text-3" id="text-2-4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">import</span> pandas <span style="color: #89DDFF;">as</span> pd
<span style="color: #89DDFF;">from</span> algo <span style="color: #89DDFF;">import</span> build_comp

<span style="color: #89DDFF;">import</span> disnake
<span style="color: #89DDFF;">from</span> disnake.ext <span style="color: #89DDFF;">import</span> commands
<span style="color: #89DDFF;">from</span> disnake <span style="color: #89DDFF;">import</span> Embed, Emoji

<span style="color: #89DDFF;">import</span> re


&lt;&lt;dtag&gt;&gt;
&lt;&lt;get_roster&gt;&gt;
&lt;&lt;config&gt;&gt;
<span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">list_to_field</span><span style="color: #c792ea;">(</span>l<span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">f</span> = <span style="color: #c3e88d;">'aucun'</span>
    <span style="color: #89DDFF;">if</span> <span style="color: #ffcb6b;">l</span>:
        f = <span style="color: #c3e88d;">''</span>
        <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> <span style="color: #ffcb6b;">l</span>:
            f += u + <span style="color: #c3e88d;">'\n'</span>
        <span style="color: #89DDFF;">if</span> <span style="color: #82aaff;">len</span><span style="color: #c792ea;">(</span>f<span style="color: #c792ea;">)</span>&gt;1023:
            <span style="color: #89DDFF;">return</span> f<span style="color: #c792ea;">[</span>:1000<span style="color: #c792ea;">]</span>+<span style="color: #c3e88d;">'...'</span>
        <span style="color: #89DDFF;">return</span> f

<span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">unique</span><span style="color: #c792ea;">(</span>l<span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">u</span> = <span style="color: #c792ea;">[]</span>
    <span style="color: #89DDFF;">for</span> r <span style="color: #89DDFF;">in</span> <span style="color: #ffcb6b;">l</span>:
        <span style="color: #89DDFF;">if</span> r <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> u:
            u +=<span style="color: #c792ea;">[</span>r<span style="color: #c792ea;">]</span>
    <span style="color: #89DDFF;">return</span> u

<span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span>:
    <span style="color: #ffcb6b;">bot</span> = commands.Bot<span style="color: #c792ea;">(</span>
        intents=disnake.Intents<span style="color: #f78c6c;">()</span>.<span style="color: #82aaff;">all</span><span style="color: #f78c6c;">()</span>,
        test_guilds=<span style="color: #f78c6c;">[</span>906630964703289434<span style="color: #f78c6c;">]</span>, <span style="color: #556369;"># </span><span style="color: #556369;">Optional</span>
        sync_commands_debug=<span style="color: #f78c6c;">True</span>
    <span style="color: #c792ea;">)</span>
    &lt;&lt;data&gt;&gt;

    &lt;&lt;slash_transfert&gt;&gt;
    &lt;&lt;slash_invasion&gt;&gt;
    &lt;&lt;slash_instance&gt;&gt;
    &lt;&lt;slash_verif&gt;&gt;
    &lt;&lt;slash_collecte&gt;&gt;

    &lt;&lt;check_user&gt;&gt;
    &lt;&lt;update_instance_add&gt;&gt;
    &lt;&lt;update_instance_rm&gt;&gt;
    &lt;&lt;on_reaction&gt;&gt;
    &lt;&lt;on_reaction_rm&gt;&gt;
    &lt;&lt;on_voice_state_update&gt;&gt;
    bot.run<span style="color: #c792ea;">(</span>token=<span style="color: #82aaff;">open</span><span style="color: #f78c6c;">(</span><span style="color: #c3e88d;">"bot.token"</span><span style="color: #f78c6c;">)</span>.read<span style="color: #f78c6c;">()[</span>:-1<span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">if</span> <span style="color: #82aaff;">__name__</span> == <span style="color: #c3e88d;">"__main__"</span>:
    main<span style="color: #c792ea;">()</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org8b3aa55" class="outline-3">
<h3 id="org8b3aa55"><span class="section-number-3">2.5.</span> Slash commands</h3>
<div class="outline-text-3" id="text-2-5">
</div>
<div id="outline-container-org1190aa6" class="outline-4">
<h4 id="org1190aa6"><span class="section-number-4">2.5.1.</span> Commande invasion</h4>
<div class="outline-text-4" id="text-2-5-1">
<div class="org-src-container">
<pre class="src src-python" id="org0d1341d"><span style="color: #ffcb6b;">villes</span> = <span style="color: #c792ea;">[</span><span style="color: #c3e88d;">"Bief de N&#233;r&#233;caille"</span>, <span style="color: #c3e88d;">"Boisclair"</span>, <span style="color: #c3e88d;">"Eaux F&#233;tides"</span>, <span style="color: #c3e88d;">"Gr&#233; du vent"</span>,
          <span style="color: #c3e88d;">"Ile des Lames"</span>, <span style="color: #c3e88d;">"Levant"</span>, <span style="color: #c3e88d;">"Haute-Chute"</span>, <span style="color: #c3e88d;">"Marais des Trames"</span>,
          <span style="color: #c3e88d;">"Rive tourment&#233;e"</span>, <span style="color: #c3e88d;">"Val des Larmes"</span>, <span style="color: #c3e88d;">"Falaise du roy"</span><span style="color: #c792ea;">]</span>

<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">autocomp_villes</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">inter</span>: disnake.ApplicationCommandInteraction, user_input: <span style="color: #82aaff;">str</span><span style="color: #c792ea;">)</span>:
    <span style="color: #89DDFF;">return</span> <span style="color: #c792ea;">[</span>ville <span style="color: #89DDFF;">for</span> ville <span style="color: #89DDFF;">in</span> villes <span style="color: #89DDFF;">if</span> ville.lower<span style="color: #f78c6c;">()</span>.startswith<span style="color: #f78c6c;">(</span>user_input.lower<span style="color: #c3e88d;">()</span><span style="color: #f78c6c;">)</span><span style="color: #c792ea;">]</span>

<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">tags_from_id</span><span style="color: #c792ea;">(</span>ctx, msg_id<span style="color: #c792ea;">)</span>:
    msg = <span style="color: #89DDFF;">await</span> ctx.channel.fetch_message<span style="color: #c792ea;">(</span>msg_id<span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">selected</span> = <span style="color: #89DDFF;">await</span> msg.reactions<span style="color: #c792ea;">[</span>0<span style="color: #c792ea;">]</span>.users<span style="color: #c792ea;">()</span>.flatten<span style="color: #c792ea;">()</span>
    <span style="color: #89DDFF;">return</span> <span style="color: #c792ea;">[</span>dtag<span style="color: #f78c6c;">(</span>u<span style="color: #f78c6c;">)</span> <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> selected<span style="color: #c792ea;">][</span>1:<span style="color: #c792ea;">]</span>

<span style="color: #89DDFF;">class</span> <span style="color: #c792ea;">CompTrigger</span><span style="color: #c792ea;">(</span>disnake.ui.View<span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">options</span> = <span style="color: #c792ea;">[</span>disnake.SelectOption<span style="color: #f78c6c;">(</span>label=k, value=v<span style="color: #f78c6c;">)</span> <span style="color: #89DDFF;">for</span> k, v <span style="color: #89DDFF;">in</span> config<span style="color: #f78c6c;">[</span><span style="color: #c3e88d;">'gdoc'</span><span style="color: #f78c6c;">][</span><span style="color: #c3e88d;">'strats'</span><span style="color: #f78c6c;">]</span>.items<span style="color: #f78c6c;">()</span><span style="color: #c792ea;">]</span>
    options<span style="color: #c792ea;">[</span>0<span style="color: #c792ea;">]</span>.default = <span style="color: #f78c6c;">True</span>
    <span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">__init__</span><span style="color: #c792ea;">(</span><span style="color: #89DDFF;">self</span>, origin, **kwargs<span style="color: #c792ea;">)</span>:
        <span style="color: #82aaff;">super</span><span style="color: #c792ea;">()</span>.__init__<span style="color: #c792ea;">(</span>**kwargs<span style="color: #c792ea;">)</span>
        <span style="color: #89DDFF;">self</span>.origin = origin
        <span style="color: #89DDFF;">self</span>.strat = config<span style="color: #c792ea;">[</span><span style="color: #c3e88d;">'gdoc'</span><span style="color: #c792ea;">][</span><span style="color: #c3e88d;">'strats'</span><span style="color: #c792ea;">][</span><span style="color: #c3e88d;">'Principale'</span><span style="color: #c792ea;">]</span>

    <span style="color: #c792ea;">@disnake.ui.select</span><span style="color: #c792ea;">(</span>options=options<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">compo</span><span style="color: #c792ea;">(</span><span style="color: #89DDFF;">self</span>, select: disnake.ui.Select, inter: disnake.MessageInteraction<span style="color: #c792ea;">)</span>:
        <span style="color: #89DDFF;">self</span>.strat=select.values<span style="color: #c792ea;">[</span>0<span style="color: #c792ea;">]</span>
        <span style="color: #89DDFF;">await</span> inter.response.defer<span style="color: #c792ea;">()</span>

    <span style="color: #c792ea;">@disnake.ui.button</span><span style="color: #c792ea;">(</span>label=<span style="color: #c3e88d;">'Composition'</span>, style=disnake.ButtonStyle.blurple<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">trigger</span><span style="color: #c792ea;">(</span><span style="color: #89DDFF;">self</span>, button: disnake.ui.Button, inter: disnake.MessageInteraction<span style="color: #c792ea;">)</span>:
        <span style="color: #556369;">#</span><span style="color: #556369;">await interaction.delete_original_message()</span>
        <span style="color: #89DDFF;">await</span> inter.response.defer<span style="color: #c792ea;">()</span>
        <span style="color: #89DDFF;">self</span>.stop<span style="color: #c792ea;">()</span>


<span style="color: #c792ea;">@bot.slash_command</span><span style="color: #c792ea;">(</span>
    scope=906630964703289434,
<span style="color: #c792ea;">)</span>
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">invasion</span><span style="color: #c792ea;">(</span>
        ctx: disnake.ApplicationCommandInteraction,
        ville: <span style="color: #82aaff;">str</span>=commands.Param<span style="color: #f78c6c;">(</span>autocomplete=autocomp_villes<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">)</span>:
    <span style="color: #556369;">""" G&#233;n&#233;re un tableau d'inscription dans le channel actuel</span>

<span style="color: #556369;">        Parameters</span>
<span style="color: #556369;">        ----------</span>
<span style="color: #556369;">        ville: La ville o&#249; se d&#233;roule l'invasion</span>
<span style="color: #556369;">    """</span>

    embed = Embed<span style="color: #c792ea;">(</span>
        title=f<span style="color: #c3e88d;">'Invasion de </span>{ville}<span style="color: #c3e88d;">'</span>,
        color=2003199,
        description=<span style="color: #c3e88d;">"R&#233;agis avec :ballot_box_with_check: &#224; ce message **uniquement si tu es d&#233;j&#224; dans le fort**. Attention, retourne vite en jeu, l'auto-AFK kick est rapide (2min). \n\n Si tu as r&#233;agi par erreur, merci de d&#233;cocher ta r&#233;action. :wink:"</span>,
    <span style="color: #c792ea;">)</span>
    embed.set_footer<span style="color: #c792ea;">(</span>text=<span style="color: #c3e88d;">'Invasion'</span><span style="color: #c792ea;">)</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">Envoi du message et ajout de la r&#233;action</span>
    <span style="color: #89DDFF;">await</span> ctx.send<span style="color: #c792ea;">(</span>embed=embed<span style="color: #c792ea;">)</span>
    msg = <span style="color: #89DDFF;">await</span> ctx.original_message<span style="color: #c792ea;">()</span>
    <span style="color: #89DDFF;">await</span> msg.add_reaction<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'&#9745;'</span><span style="color: #c792ea;">)</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">Cr&#233;ation du vocal</span>
    invasions_cat = 906648457824051252
    category = disnake.utils.find<span style="color: #c792ea;">(</span><span style="color: #89DDFF;">lambda</span> c: c.<span style="color: #82aaff;">id</span> == invasions_cat, ctx.guild.categories<span style="color: #c792ea;">)</span>

    <span style="color: #89DDFF;">await</span> category.create_voice_channel<span style="color: #c792ea;">(</span>f<span style="color: #c3e88d;">'&#128297; R&#233;parations </span>{ville}<span style="color: #c3e88d;">'</span><span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">await</span> category.create_voice_channel<span style="color: #c792ea;">(</span>f<span style="color: #c3e88d;">'</span>{ville}<span style="color: #c3e88d;">'</span>, user_limit=99<span style="color: #c792ea;">)</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">Envoi d'un message cach&#233; &#224; l'invocateur</span>
    trigger = CompTrigger<span style="color: #c792ea;">(</span>msg.<span style="color: #82aaff;">id</span>, timeout=10*60<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">await</span> ctx.send<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">"Calcul"</span>, view=trigger, ephemeral=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">Attente du d&#233;clanchement pas l'invocateur</span>
    <span style="color: #89DDFF;">await</span> trigger.wait<span style="color: #c792ea;">()</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">R&#233;cup&#233;ration du message originel complet</span>
    msg = <span style="color: #89DDFF;">await</span> ctx.channel.fetch_message<span style="color: #c792ea;">(</span>msg.<span style="color: #82aaff;">id</span><span style="color: #c792ea;">)</span>

    selected = <span style="color: #89DDFF;">await</span> msg.reactions<span style="color: #c792ea;">[</span>0<span style="color: #c792ea;">]</span>.users<span style="color: #c792ea;">()</span>.flatten<span style="color: #c792ea;">()</span>

    selected_tags = <span style="color: #c792ea;">[</span>dtag<span style="color: #f78c6c;">(</span>u<span style="color: #f78c6c;">)</span> <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> selected <span style="color: #89DDFF;">if</span> dtag<span style="color: #f78c6c;">(</span>u<span style="color: #f78c6c;">)</span> != <span style="color: #c3e88d;">'Invasion#5489'</span><span style="color: #c792ea;">]</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">R&#233;cup&#233;ration des don&#233;nes du Gdoc roster</span>
    roster = get_roster<span style="color: #c792ea;">(</span>config<span style="color: #c792ea;">)</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">Joueurs s&#233;l&#233;ctionn&#233;s n'ayant pas rempli le Gdoc</span>
    not_registered = <span style="color: #c792ea;">[</span>u <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> selected_tags <span style="color: #89DDFF;">if</span> u <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> roster.index<span style="color: #c792ea;">]</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">Filtrage du roster avec les joueurs s&#233;l&#233;ctionn&#233;s</span>
    roster = roster.<span style="color: #82aaff;">filter</span><span style="color: #c792ea;">(</span>items=selected_tags, axis=0<span style="color: #c792ea;">)</span>.set_index<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'Pseudo IG'</span><span style="color: #c792ea;">)</span>

    strat=trigger.strat

    <span style="color: #556369;"># </span><span style="color: #556369;">R&#233;cup&#233;ration de la strat</span>
    url = f<span style="color: #c3e88d;">"</span>{config['gdoc']['url']}<span style="color: #c3e88d;">gviz/tq?tqx=out:csv&amp;sheet=</span>{strat}<span style="color: #c3e88d;">"</span>

    page = pd.read_csv<span style="color: #c792ea;">(</span>url<span style="color: #c792ea;">)</span>
    strat_df = page.iloc<span style="color: #c792ea;">[</span>0:5, 0:10<span style="color: #c792ea;">]</span>
    img_url = page.iat<span style="color: #c792ea;">[</span>5, 1<span style="color: #c792ea;">]</span>

    comp = build_comp<span style="color: #c792ea;">(</span>roster, strat_df, config<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">gen_embed</span><span style="color: #c792ea;">(</span>comp<span style="color: #c792ea;">)</span>:
        e = Embed<span style="color: #c792ea;">(</span>title=<span style="color: #c3e88d;">"Composition d'arm&#233;e"</span><span style="color: #c792ea;">)</span>
        <span style="color: #89DDFF;">for</span> k, v <span style="color: #89DDFF;">in</span> comp.iteritems<span style="color: #c792ea;">()</span>:
            f = <span style="color: #c3e88d;">''</span>
            <span style="color: #89DDFF;">for</span> p <span style="color: #89DDFF;">in</span> v.to_list<span style="color: #c792ea;">()</span>:
                f += <span style="color: #82aaff;">str</span><span style="color: #c792ea;">(</span>p<span style="color: #c792ea;">)</span> + <span style="color: #c3e88d;">'\n'</span>
            e.add_field<span style="color: #c792ea;">(</span>name=k, value=f, inline=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>
        <span style="color: #89DDFF;">return</span> e

    embed = gen_embed<span style="color: #c792ea;">(</span>comp<span style="color: #c792ea;">)</span>
    embed.title = f<span style="color: #c3e88d;">"Invasion de </span>{ville}<span style="color: #c3e88d;">, </span>{strat}<span style="color: #c3e88d;"> :"</span>
    <span style="color: #556369;">#</span><span style="color: #556369;">embed.set_footer(text=ctx.author.name, icon_url = ctx.author.avatar_url)</span>
    embed.color = 2003199
    embed.set_thumbnail<span style="color: #c792ea;">(</span>url=img_url<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">await</span> ctx.send<span style="color: #c792ea;">(</span>embed=embed, delete_after=60*25<span style="color: #c792ea;">)</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-orgd2b7a39" class="outline-4">
<h4 id="orgd2b7a39"><span class="section-number-4">2.5.2.</span> Commande verif</h4>
<div class="outline-text-4" id="text-2-5-2">
<div class="org-src-container">
<pre class="src src-python" id="org85c4c12"><span style="color: #c792ea;">@bot.slash_command</span><span style="color: #c792ea;">(</span>
    description=<span style="color: #c3e88d;">"V&#233;rification du Gdoc et mise &#224; jour des r&#244;les"</span>,
    scope=906630964703289434,
<span style="color: #c792ea;">)</span>
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">verif</span><span style="color: #c792ea;">(</span>ctx<span style="color: #c792ea;">)</span>:
    <span style="color: #556369;">""" Attribue les r&#244;les</span>
<span style="color: #556369;">    """</span>

    guild = ctx.guild
    lead_role = guild.get_role<span style="color: #c792ea;">(</span>config<span style="color: #f78c6c;">[</span><span style="color: #c3e88d;">"ids"</span><span style="color: #f78c6c;">][</span><span style="color: #c3e88d;">"leads"</span><span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">R&#233;cup&#233;ration des don&#233;nes du Gdoc roster</span>
    roster_df = get_roster<span style="color: #c792ea;">(</span>config<span style="color: #c792ea;">)</span>
    roster = <span style="color: #82aaff;">list</span><span style="color: #c792ea;">(</span>roster_df.index<span style="color: #c792ea;">)</span>

    members = <span style="color: #c792ea;">{</span>dtag<span style="color: #f78c6c;">(</span>m<span style="color: #f78c6c;">)</span>: m <span style="color: #89DDFF;">for</span> m <span style="color: #89DDFF;">in</span> guild.members<span style="color: #c792ea;">}</span>

    role = guild.get_role<span style="color: #c792ea;">(</span>config<span style="color: #f78c6c;">[</span><span style="color: #c3e88d;">"ids"</span><span style="color: #f78c6c;">][</span><span style="color: #c3e88d;">"role"</span><span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>
    verified = <span style="color: #c792ea;">[</span>dtag<span style="color: #f78c6c;">(</span>m<span style="color: #f78c6c;">)</span> <span style="color: #89DDFF;">for</span> m <span style="color: #89DDFF;">in</span> role.members<span style="color: #c792ea;">]</span>

    added = <span style="color: #c792ea;">[]</span>
    wrong = <span style="color: #c792ea;">[]</span>
    <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> roster:
       <span style="color: #89DDFF;">if</span> u <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> members:
           wrong += <span style="color: #c792ea;">[</span>u<span style="color: #c792ea;">]</span>
       <span style="color: #89DDFF;">elif</span> u <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> verified:
           <span style="color: #89DDFF;">if</span> role <span style="color: #89DDFF;">is</span> <span style="color: #f78c6c;">None</span>:
               <span style="color: #556369;"># </span><span style="color: #556369;">Make sure the role still exists and is valid.</span>
               <span style="color: #89DDFF;">return</span>

           <span style="color: #89DDFF;">try</span>:
               <span style="color: #556369;"># </span><span style="color: #556369;">Finally, add the role.</span>
               <span style="color: #89DDFF;">await</span> members<span style="color: #c792ea;">[</span>u<span style="color: #c792ea;">]</span>.add_roles<span style="color: #c792ea;">(</span>role<span style="color: #c792ea;">)</span>
               added += <span style="color: #c792ea;">[</span>u<span style="color: #c792ea;">]</span>
           <span style="color: #89DDFF;">except</span> disnake.HTTPException:
               <span style="color: #556369;"># </span><span style="color: #556369;">If we want to do something in case of errors we'd do it here.</span>
               <span style="color: #89DDFF;">pass</span>

    removed = <span style="color: #c792ea;">[]</span>
    <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> verified:
        <span style="color: #89DDFF;">if</span> u <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> roster:
            <span style="color: #89DDFF;">try</span>:
                <span style="color: #556369;"># </span><span style="color: #556369;">Finally, remove the role.</span>
                <span style="color: #89DDFF;">await</span> members<span style="color: #c792ea;">[</span>u<span style="color: #c792ea;">]</span>.remove_roles<span style="color: #c792ea;">(</span>role<span style="color: #c792ea;">)</span>
                removed += <span style="color: #c792ea;">[</span>u<span style="color: #c792ea;">]</span>

                <span style="color: #556369;"># </span><span style="color: #556369;">Send DM to user</span>
                embed = Embed.from_dict<span style="color: #c792ea;">(</span>config<span style="color: #f78c6c;">[</span><span style="color: #c3e88d;">"embeds"</span><span style="color: #f78c6c;">][</span><span style="color: #c3e88d;">"change"</span><span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>
                embed.description += f<span style="color: #c3e88d;">'</span>{config["gdoc"]["form"]}<span style="color: #c3e88d;">) ***!***'</span>
                <span style="color: #89DDFF;">await</span> members<span style="color: #c792ea;">[</span>u<span style="color: #c792ea;">]</span>.send<span style="color: #c792ea;">(</span>embed=embed<span style="color: #c792ea;">)</span>
            <span style="color: #89DDFF;">except</span> disnake.HTTPException:
                <span style="color: #556369;"># </span><span style="color: #556369;">If we want to do something in case of errors we'd do it here.</span>
                <span style="color: #89DDFF;">pass</span>

    <span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">add_IG</span><span style="color: #c792ea;">(</span>l, roster_df<span style="color: #c792ea;">)</span>:
        <span style="color: #89DDFF;">return</span> <span style="color: #c792ea;">[</span>f<span style="color: #c3e88d;">"</span>{i}<span style="color: #c3e88d;"> | </span>{roster_df.loc[i]['Pseudo IG']}<span style="color: #c3e88d;">"</span> <span style="color: #89DDFF;">for</span> i <span style="color: #89DDFF;">in</span> l<span style="color: #c792ea;">]</span>
    wrong = add_IG<span style="color: #c792ea;">(</span>wrong, roster_df<span style="color: #c792ea;">)</span>
    added = add_IG<span style="color: #c792ea;">(</span>added, roster_df<span style="color: #c792ea;">)</span>
    embed = Embed<span style="color: #c792ea;">()</span>
    embed.title = f<span style="color: #c3e88d;">'V&#233;rification du gdoc'</span>
    embed.color = 2003199
    <span style="color: #556369;">#</span><span style="color: #556369;">embed.set_footer(text=ctx.author.name, icon_url = ctx.author.avatar_url)</span>

    embed.add_field<span style="color: #c792ea;">(</span>name=<span style="color: #c3e88d;">"Joueurs nouvellement v&#233;rifi&#233;s"</span>, value=list_to_field<span style="color: #f78c6c;">(</span>added<span style="color: #f78c6c;">)</span>, inline=<span style="color: #f78c6c;">False</span><span style="color: #c792ea;">)</span>
    embed.add_field<span style="color: #c792ea;">(</span>name=<span style="color: #c3e88d;">"Discord tag dans le Gdoc ne correspondant &#224; aucun membre du discord"</span>, value=list_to_field<span style="color: #f78c6c;">(</span>wrong<span style="color: #f78c6c;">)</span>, inline=<span style="color: #f78c6c;">False</span><span style="color: #c792ea;">)</span>
    embed.add_field<span style="color: #c792ea;">(</span>name=f<span style="color: #c3e88d;">"Joueurs ayant chang&#233; de Discord tag (r&#244;le </span>{role}<span style="color: #c3e88d;"> supprim&#233;)"</span>, value=list_to_field<span style="color: #f78c6c;">(</span>removed<span style="color: #f78c6c;">)</span>, inline=<span style="color: #f78c6c;">False</span><span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">await</span> ctx.channel.send<span style="color: #c792ea;">(</span>embed=embed, delete_after=20*60<span style="color: #c792ea;">)</span>
    <span style="color: #556369;">#</span><span style="color: #556369;">print(added, wrong)</span>


</pre>
</div>
</div>
</div>
<div id="outline-container-org368bc71" class="outline-4">
<h4 id="org368bc71"><span class="section-number-4">2.5.3.</span> Commande transfert</h4>
<div class="outline-text-4" id="text-2-5-3">
<div class="org-src-container">
<pre class="src src-python" id="org818b7b8">
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">autocomp_sources</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">ctx</span>: disnake.ApplicationCommandInteraction, user_input: <span style="color: #82aaff;">str</span><span style="color: #c792ea;">)</span>:
    voices = <span style="color: #c792ea;">[</span>v <span style="color: #89DDFF;">for</span> v <span style="color: #89DDFF;">in</span> ctx.guild.voice_channels <span style="color: #89DDFF;">if</span> v.members<span style="color: #c792ea;">]</span>
    <span style="color: #89DDFF;">return</span> <span style="color: #c792ea;">[</span>v.name <span style="color: #89DDFF;">for</span> v <span style="color: #89DDFF;">in</span> voices <span style="color: #89DDFF;">if</span> v.name.lower<span style="color: #f78c6c;">()</span>.startswith<span style="color: #f78c6c;">(</span>user_input.lower<span style="color: #c3e88d;">()</span><span style="color: #f78c6c;">)</span><span style="color: #c792ea;">]</span>

<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">autocomp_destinations</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">ctx</span>: disnake.ApplicationCommandInteraction, user_input: <span style="color: #82aaff;">str</span><span style="color: #c792ea;">)</span>:
    voices = ctx.guild.voice_channels
    <span style="color: #89DDFF;">return</span> <span style="color: #c792ea;">[</span>v.name <span style="color: #89DDFF;">for</span> v <span style="color: #89DDFF;">in</span> voices <span style="color: #89DDFF;">if</span> v.name.lower<span style="color: #f78c6c;">()</span>.startswith<span style="color: #f78c6c;">(</span>user_input.lower<span style="color: #c3e88d;">()</span><span style="color: #f78c6c;">)</span><span style="color: #c792ea;">]</span>
    <span style="color: #556369;">#</span><span style="color: #556369;">return [ville for ville in villes if user_input.lower() in ville]</span>
<span style="color: #c792ea;">@bot.slash_command</span><span style="color: #c792ea;">()</span>
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">transfert</span><span style="color: #c792ea;">(</span>ctx: disnake.ApplicationCommandInteraction,
                    source: <span style="color: #82aaff;">str</span>=commands.Param<span style="color: #f78c6c;">(</span>autocomplete=autocomp_sources<span style="color: #f78c6c;">)</span>,
                    destination: <span style="color: #82aaff;">str</span>=commands.Param<span style="color: #f78c6c;">(</span>autocomplete=autocomp_destinations<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">)</span>:
    <span style="color: #556369;">"""D&#233;place les joueurs d'un salon vocal source &#224; un salon destinatoin</span>

<span style="color: #556369;">        Parameters</span>
<span style="color: #556369;">        ----------</span>
<span style="color: #556369;">        source: La ville o&#249; se d&#233;roule l'invasion</span>
<span style="color: #556369;">        destination: La ville o&#249; se d&#233;roule l'invasion</span>
<span style="color: #556369;">    """</span>
    voices = <span style="color: #c792ea;">{</span>v.name: v <span style="color: #89DDFF;">for</span> v <span style="color: #89DDFF;">in</span> ctx.guild.voice_channels<span style="color: #c792ea;">}</span>
    dest = voices<span style="color: #c792ea;">[</span>destination<span style="color: #c792ea;">]</span>
    users = voices<span style="color: #c792ea;">[</span>source<span style="color: #c792ea;">]</span>.members
    <span style="color: #89DDFF;">await</span> ctx.send<span style="color: #c792ea;">(</span>content=f<span style="color: #c3e88d;">'</span>{<span style="color: #82aaff;">len</span>(users)}<span style="color: #c3e88d;"> Utilisateurs vont &#234;tre d&#233;plac&#233;s dans le salon ***</span>{destination}<span style="color: #c3e88d;">***'</span>, ephemeral=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>
    <span style="color: #c792ea;">[</span><span style="color: #89DDFF;">await</span> u.move_to<span style="color: #f78c6c;">(</span>dest<span style="color: #f78c6c;">)</span> <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> users<span style="color: #c792ea;">]</span>


</pre>
</div>
</div>
</div>

<div id="outline-container-org7997f21" class="outline-4">
<h4 id="org7997f21"><span class="section-number-4">2.5.4.</span> Commande Instance</h4>
<div class="outline-text-4" id="text-2-5-4">
<div class="org-src-container">
<pre class="src src-python" id="orgfdabef7"><span style="color: #ffcb6b;">donjons</span> = <span style="color: #c792ea;">[</span><span style="color: #c3e88d;">"Lazarus"</span>, <span style="color: #c3e88d;">"G&#232;nese"</span>, <span style="color: #c3e88d;">"Dynastie"</span>, <span style="color: #c3e88d;">"Etoile"</span>, <span style="color: #c3e88d;">"Profondeur"</span>, <span style="color: #c3e88d;">"Amrine"</span>, <span style="color: #c3e88d;">"Temp&#234;te"</span><span style="color: #c792ea;">]</span>
<span style="color: #ffcb6b;">zones_elites</span> = <span style="color: #c792ea;">[</span><span style="color: #c3e88d;">"Sir&#232;ne"</span>, <span style="color: #c3e88d;">"Palais"</span>, <span style="color: #c3e88d;">"Mines"</span>, <span style="color: #c3e88d;">"Myrk"</span>, <span style="color: #c3e88d;">"Malveillance"</span><span style="color: #c792ea;">]</span>
<span style="color: #ffcb6b;">lieux</span> = donjons + zones_elites
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">autocomp_lieux</span><span style="color: #c792ea;">(</span>inter: disnake.ApplicationCommandInteraction, user_input: <span style="color: #82aaff;">str</span><span style="color: #c792ea;">)</span>:
    <span style="color: #89DDFF;">return</span> <span style="color: #c792ea;">[</span>l <span style="color: #89DDFF;">for</span> l <span style="color: #89DDFF;">in</span> lieux <span style="color: #89DDFF;">if</span> l.lower<span style="color: #f78c6c;">()</span>.startswith<span style="color: #f78c6c;">(</span>user_input.lower<span style="color: #c3e88d;">()</span><span style="color: #f78c6c;">)</span><span style="color: #c792ea;">]</span>

<span style="color: #c792ea;">@bot.slash_command</span><span style="color: #c792ea;">()</span>
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">instance</span><span style="color: #c792ea;">(</span>ctx: disnake.ApplicationCommandInteraction,
                   lieu: <span style="color: #82aaff;">str</span>=commands.Param<span style="color: #f78c6c;">(</span>autocomplete=autocomp_lieux<span style="color: #f78c6c;">)</span>,
                   heure: <span style="color: #82aaff;">str</span>=commands.Param<span style="color: #f78c6c;">(</span>default=<span style="color: #f78c6c;">None</span><span style="color: #f78c6c;">)</span>,
                   prix: <span style="color: #82aaff;">str</span>=commands.Param<span style="color: #f78c6c;">(</span>default=<span style="color: #f78c6c;">None</span><span style="color: #f78c6c;">)</span>,
                   tanks: <span style="color: #82aaff;">int</span>=commands.Param<span style="color: #f78c6c;">(</span>default=<span style="color: #f78c6c;">None</span><span style="color: #f78c6c;">)</span>,
                   dps: <span style="color: #82aaff;">int</span>=commands.Param<span style="color: #f78c6c;">(</span>default=<span style="color: #f78c6c;">None</span><span style="color: #f78c6c;">)</span>,
                   heals: <span style="color: #82aaff;">int</span>=commands.Param<span style="color: #f78c6c;">(</span>default=<span style="color: #f78c6c;">None</span><span style="color: #f78c6c;">)</span>,
                   mutation: <span style="color: #82aaff;">int</span>=commands.Param<span style="color: #f78c6c;">(</span>default=<span style="color: #f78c6c;">None</span><span style="color: #f78c6c;">)</span><span style="color: #c792ea;">)</span>:
    <span style="color: #556369;">"""Cr&#233;e un panneau d'inscription &#224; une instance</span>

<span style="color: #556369;">        Parameters</span>
<span style="color: #556369;">        ----------</span>
<span style="color: #556369;">        lieu: La ville o&#249; se d&#233;roule l'instance</span>
<span style="color: #556369;">        heure: L'heure &#224; laquelle se d&#233;roule l'instance</span>
<span style="color: #556369;">        prix: Le prix par personne, gratuit c'est cool aussi ;)</span>
<span style="color: #556369;">        tanks: Le nombre de tanks attendus</span>
<span style="color: #556369;">        dps: Le nombre de dps attendus</span>
<span style="color: #556369;">        heals: Le nombre de heals attendus</span>
<span style="color: #556369;">        mutation: Le niveau de mutation (si mutation)</span>
<span style="color: #556369;">    """</span>
    embed = Embed<span style="color: #c792ea;">()</span>
    embed.title = f<span style="color: #c3e88d;">'Instance </span>{lieu}<span style="color: #c3e88d;">'</span>
    <span style="color: #89DDFF;">if</span> mutation:
        embed.title += f<span style="color: #c3e88d;">' M</span>{mutation}<span style="color: #c3e88d;">'</span>
    embed.description = <span style="color: #c3e88d;">''</span>
    <span style="color: #89DDFF;">if</span> heure:
        embed.description += f<span style="color: #c3e88d;">' &#128336; </span>{heure}<span style="color: #c3e88d;">\n'</span>
    <span style="color: #89DDFF;">if</span> prix:
        embed.description += f<span style="color: #c3e88d;">' &#128176; </span>{prix}<span style="color: #c3e88d;">\n'</span>
    embed.description += f<span style="color: #c3e88d;">'Propos&#233;e par </span>{ctx.user.mention}<span style="color: #c3e88d;">\n'</span>
    embed.color = 2003199

    <span style="color: #556369;"># </span><span style="color: #556369;">Si nombre custom</span>
    <span style="color: #89DDFF;">if</span> tanks <span style="color: #89DDFF;">or</span> dps <span style="color: #89DDFF;">or</span> heals:
        <span style="color: #89DDFF;">if</span> <span style="color: #89DDFF;">not</span> tanks:
            tanks = 1
        <span style="color: #89DDFF;">if</span> <span style="color: #89DDFF;">not</span> dps:
            dps = 3
        <span style="color: #89DDFF;">if</span> <span style="color: #89DDFF;">not</span> heals:
            heals = 1
        roles = <span style="color: #c792ea;">[</span><span style="color: #c3e88d;">'&#128737;'</span><span style="color: #c792ea;">]</span>*tanks + <span style="color: #c792ea;">[</span><span style="color: #c3e88d;">'&#9876;'</span><span style="color: #c792ea;">]</span>*dps + <span style="color: #c792ea;">[</span><span style="color: #c3e88d;">'&#9937;'</span><span style="color: #c792ea;">]</span>*heals
    <span style="color: #89DDFF;">else</span>:
        roles = <span style="color: #c792ea;">[</span><span style="color: #c3e88d;">'&#128737;'</span>, <span style="color: #c3e88d;">'&#9876;'</span>, <span style="color: #c3e88d;">'&#9876;'</span>, <span style="color: #c3e88d;">'&#9876;'</span>,<span style="color: #c3e88d;">'&#9937;'</span><span style="color: #c792ea;">]</span>

    players = <span style="color: #c792ea;">[</span><span style="color: #c3e88d;">'libre'</span><span style="color: #c792ea;">]</span>*<span style="color: #82aaff;">len</span><span style="color: #c792ea;">(</span>roles<span style="color: #c792ea;">)</span>
    embed.add_field<span style="color: #c792ea;">(</span>name=<span style="color: #c3e88d;">"R&#244;les"</span>, value=list_to_field<span style="color: #f78c6c;">(</span>roles<span style="color: #f78c6c;">)</span>, inline=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>
    embed.add_field<span style="color: #c792ea;">(</span>name=<span style="color: #c3e88d;">"Joueurs"</span>, value=list_to_field<span style="color: #f78c6c;">(</span>players<span style="color: #f78c6c;">)</span>, inline=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>
    embed.set_footer<span style="color: #c792ea;">(</span>text=<span style="color: #c3e88d;">'Instance'</span><span style="color: #c792ea;">)</span>
    <span style="color: #556369;"># </span><span style="color: #556369;">Envoi du message et ajout de la r&#233;action</span>
    <span style="color: #89DDFF;">await</span> ctx.send<span style="color: #c792ea;">(</span>embed=embed<span style="color: #c792ea;">)</span>
    msg = <span style="color: #89DDFF;">await</span> ctx.original_message<span style="color: #c792ea;">()</span>


    <span style="color: #89DDFF;">for</span> r <span style="color: #89DDFF;">in</span> unique<span style="color: #c792ea;">(</span>roles<span style="color: #c792ea;">)</span>:
        <span style="color: #89DDFF;">await</span> msg.add_reaction<span style="color: #c792ea;">(</span>r<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">await</span> msg.add_reaction<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'&#9989;'</span><span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">await</span> msg.add_reaction<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'&#10060;'</span><span style="color: #c792ea;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org3759d32" class="outline-4">
<h4 id="org3759d32"><span class="section-number-4">2.5.5.</span> Commande event</h4>
<div class="outline-text-4" id="text-2-5-5">
<div class="org-src-container">
<pre class="src src-python" id="orge3e8d74"><span style="color: #89DDFF;">import</span> math
<span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">progress_bar</span><span style="color: #c792ea;">(</span>percent, full=<span style="color: #c3e88d;">'&#129001;'</span>, empty=<span style="color: #c3e88d;">'&#11036;'</span><span style="color: #c792ea;">)</span>:
    done = math.floor<span style="color: #c792ea;">(</span>percent*10<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">return</span> full* done + empty*<span style="color: #c792ea;">(</span>10-done<span style="color: #c792ea;">)</span> + <span style="color: #c3e88d;">' '</span> + f<span style="color: #c3e88d;">'</span>{percent*100:.1f}<span style="color: #c3e88d;">%'</span>

<span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">display_progress</span><span style="color: #c792ea;">(</span>actuel, objectif<span style="color: #c792ea;">)</span>:
    <span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">display_num</span><span style="color: #c792ea;">(</span>n<span style="color: #c792ea;">)</span>:
        s = <span style="color: #82aaff;">str</span><span style="color: #c792ea;">(</span>n<span style="color: #c792ea;">)</span>
        <span style="color: #89DDFF;">if</span> s.endswith<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'000'</span><span style="color: #c792ea;">)</span>:
            s = s<span style="color: #c792ea;">[</span>:-3<span style="color: #c792ea;">]</span> + <span style="color: #c3e88d;">'k'</span>
        <span style="color: #89DDFF;">return</span> s
    <span style="color: #89DDFF;">return</span> display_num<span style="color: #c792ea;">(</span>actuel<span style="color: #c792ea;">)</span>+ <span style="color: #c3e88d;">' &#824; '</span> + display_num<span style="color: #c792ea;">(</span>objectif<span style="color: #c792ea;">)</span> + <span style="color: #c3e88d;">' '</span> + progress_bar<span style="color: #c792ea;">(</span>actuel/objectif, full=<span style="color: #c3e88d;">'&#9606;'</span>, empty=<span style="color: #c3e88d;">'&#9601;'</span><span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">progress_embed</span><span style="color: #c792ea;">(</span>title, actuel, objectif, contrib=<span style="color: #f78c6c;">{}</span>, top=5<span style="color: #c792ea;">)</span>:
    embed = disnake.Embed<span style="color: #c792ea;">()</span>
    embed.title = title
    embed.description = display_progress<span style="color: #c792ea;">(</span>actuel, objectif<span style="color: #c792ea;">)</span>

    contrib_str=<span style="color: #c3e88d;">''</span>
    <span style="color: #89DDFF;">if</span> contrib:
        s = <span style="color: #82aaff;">dict</span><span style="color: #c792ea;">(</span><span style="color: #82aaff;">sorted</span><span style="color: #f78c6c;">(</span>contrib.items<span style="color: #c3e88d;">()</span>, key=<span style="color: #89DDFF;">lambda</span> item: item<span style="color: #c3e88d;">[</span>1<span style="color: #c3e88d;">]</span>, reverse=<span style="color: #f78c6c;">True</span><span style="color: #f78c6c;">)</span><span style="color: #c792ea;">)</span>
        <span style="color: #89DDFF;">for</span> k, v <span style="color: #89DDFF;">in</span> s.items<span style="color: #c792ea;">()</span>:
            contrib_str += f<span style="color: #c3e88d;">'</span>{k}<span style="color: #c3e88d;">  </span>{v}<span style="color: #c3e88d;">\n'</span>
        embed.add_field<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'Contributeurs'</span>, contrib_str<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">return</span> embed

<span style="color: #89DDFF;">class</span> <span style="color: #c792ea;">Dropdown</span><span style="color: #c792ea;">(</span>disnake.ui.Select<span style="color: #c792ea;">)</span>:
  <span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">__init__</span><span style="color: #c792ea;">(</span><span style="color: #89DDFF;">self</span>, **kwargs<span style="color: #c792ea;">)</span>:

      <span style="color: #556369;"># </span><span style="color: #556369;">Set the options that will be presented inside the dropdown</span>
      options = <span style="color: #c792ea;">[</span>
          disnake.SelectOption<span style="color: #f78c6c;">(</span>
              label=<span style="color: #c3e88d;">"1"</span>,
          <span style="color: #f78c6c;">)</span>,
          disnake.SelectOption<span style="color: #f78c6c;">(</span>
              label=<span style="color: #c3e88d;">"10"</span>,
          <span style="color: #f78c6c;">)</span>,
          disnake.SelectOption<span style="color: #f78c6c;">(</span>
              label=<span style="color: #c3e88d;">"100"</span>,
          <span style="color: #f78c6c;">)</span>,
          disnake.SelectOption<span style="color: #f78c6c;">(</span>
              label=<span style="color: #c3e88d;">"1000"</span>,
          <span style="color: #f78c6c;">)</span>,
      <span style="color: #c792ea;">]</span>

      <span style="color: #556369;"># </span><span style="color: #556369;">The placeholder is what will be shown when no option is chosen</span>
      <span style="color: #556369;"># </span><span style="color: #556369;">The min and max values indicate we can only pick one of the three options</span>
      <span style="color: #556369;"># </span><span style="color: #556369;">The options parameter defines the dropdown options. We defined this above</span>
      <span style="color: #82aaff;">super</span><span style="color: #c792ea;">()</span>.__init__<span style="color: #c792ea;">(</span>
          placeholder=<span style="color: #c3e88d;">"Valeur"</span>,
          min_values=1,
          max_values=1,
          options=options,
          **kwargs
      <span style="color: #c792ea;">)</span>

  <span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">callback</span><span style="color: #c792ea;">(</span><span style="color: #89DDFF;">self</span>, interaction: disnake.MessageInteraction<span style="color: #c792ea;">)</span>:
      <span style="color: #89DDFF;">await</span> interaction.response.defer<span style="color: #c792ea;">()</span>

<span style="color: #89DDFF;">class</span> <span style="color: #c792ea;">ProgressView</span><span style="color: #c792ea;">(</span>disnake.ui.View<span style="color: #c792ea;">)</span>:
    <span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">__init__</span><span style="color: #c792ea;">(</span><span style="color: #89DDFF;">self</span>, title, objectif<span style="color: #c792ea;">)</span>:
        <span style="color: #82aaff;">super</span><span style="color: #c792ea;">()</span>.__init__<span style="color: #c792ea;">(</span>timeout=<span style="color: #f78c6c;">None</span><span style="color: #c792ea;">)</span>
        <span style="color: #89DDFF;">self</span>.title = title
        <span style="color: #89DDFF;">self</span>.actual = 0
        <span style="color: #89DDFF;">self</span>.objectif = objectif
        <span style="color: #89DDFF;">self</span>.contributors = <span style="color: #c792ea;">{}</span>
        <span style="color: #556369;">#</span><span style="color: #556369;">self.add_item(disnake.ui.Button(style=disnake.ButtonStyle.secondary,</span>
        <span style="color: #556369;">#                                </span><span style="color: #556369;">label=display_progress(0, objectif),</span>
        <span style="color: #556369;">#                                </span><span style="color: #556369;">row=0, disabled=True))</span>
        <span style="color: #556369;">#</span><span style="color: #556369;">self.add_item(Dropdown(row=0))</span>

    <span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">update</span><span style="color: #c792ea;">(</span><span style="color: #89DDFF;">self</span>, val, interaction: disnake.MessageInteraction<span style="color: #c792ea;">)</span>:
        <span style="color: #556369;">#</span><span style="color: #556369;">self.actual = self.actual + int(self.children[-1].values[0])</span>
        <span style="color: #89DDFF;">self</span>.actual = <span style="color: #89DDFF;">self</span>.actual + val
        author = interaction.author.mention
        <span style="color: #89DDFF;">if</span> author <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> <span style="color: #89DDFF;">self</span>.contributors:
            <span style="color: #89DDFF;">self</span>.contributors<span style="color: #c792ea;">[</span><span style="color: #ffcb6b;">author</span><span style="color: #c792ea;">]</span> = val
        <span style="color: #89DDFF;">else</span>:
            <span style="color: #89DDFF;">self</span>.contributors<span style="color: #c792ea;">[</span><span style="color: #ffcb6b;">author</span><span style="color: #c792ea;">]</span> += val
        <span style="color: #89DDFF;">await</span> interaction.response.edit_message<span style="color: #c792ea;">(</span>embed=progress_embed<span style="color: #f78c6c;">(</span><span style="color: #89DDFF;">self</span>.title,
                                                                     <span style="color: #89DDFF;">self</span>.actual,
                                                                     <span style="color: #89DDFF;">self</span>.objectif,
                                                                     <span style="color: #89DDFF;">self</span>.contributors<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">)</span>

    <span style="color: #c792ea;">@disnake.ui.button</span><span style="color: #c792ea;">(</span>label=<span style="color: #c3e88d;">"+1"</span>, style=disnake.ButtonStyle.green, row=0<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">ajout1</span><span style="color: #c792ea;">(</span><span style="color: #89DDFF;">self</span>, button: disnake.ui.Button, interaction: disnake.MessageInteraction<span style="color: #c792ea;">)</span>:
        <span style="color: #89DDFF;">await</span> <span style="color: #89DDFF;">self</span>.update<span style="color: #c792ea;">(</span>1, interaction<span style="color: #c792ea;">)</span>

    <span style="color: #c792ea;">@disnake.ui.button</span><span style="color: #c792ea;">(</span>label=<span style="color: #c3e88d;">"+10"</span>, style=disnake.ButtonStyle.green, row=0<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">ajout10</span><span style="color: #c792ea;">(</span><span style="color: #89DDFF;">self</span>, button: disnake.ui.Button, interaction: disnake.MessageInteraction<span style="color: #c792ea;">)</span>:
        <span style="color: #89DDFF;">await</span> <span style="color: #89DDFF;">self</span>.update<span style="color: #c792ea;">(</span>10, interaction<span style="color: #c792ea;">)</span>

    <span style="color: #c792ea;">@disnake.ui.button</span><span style="color: #c792ea;">(</span>label=<span style="color: #c3e88d;">"+100"</span>, style=disnake.ButtonStyle.green, row=0<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">ajout100</span><span style="color: #c792ea;">(</span><span style="color: #89DDFF;">self</span>, button: disnake.ui.Button, interaction: disnake.MessageInteraction<span style="color: #c792ea;">)</span>:
        <span style="color: #89DDFF;">await</span> <span style="color: #89DDFF;">self</span>.update<span style="color: #c792ea;">(</span>100, interaction<span style="color: #c792ea;">)</span>

    <span style="color: #c792ea;">@disnake.ui.button</span><span style="color: #c792ea;">(</span>label=<span style="color: #c3e88d;">"+1000"</span>, style=disnake.ButtonStyle.green, row=0<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">ajout1000</span><span style="color: #c792ea;">(</span><span style="color: #89DDFF;">self</span>, button: disnake.ui.Button, interaction: disnake.MessageInteraction<span style="color: #c792ea;">)</span>:
        <span style="color: #89DDFF;">await</span> <span style="color: #89DDFF;">self</span>.update<span style="color: #c792ea;">(</span>1000, interaction<span style="color: #c792ea;">)</span>

<span style="color: #c792ea;">@bot.slash_command</span><span style="color: #c792ea;">()</span>
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">collecte</span><span style="color: #c792ea;">(</span>ctx: disnake.CommandInteraction,
                   item: <span style="color: #82aaff;">str</span>,
                   objectif: <span style="color: #82aaff;">int</span><span style="color: #c792ea;">)</span>:
    <span style="color: #556369;">"""Cr&#233;&#233; un &#233;v&#233;nement</span>

<span style="color: #556369;">       Parameters</span>
<span style="color: #556369;">       ----------</span>
<span style="color: #556369;">       item: Item d&#233;sir&#233;</span>
<span style="color: #556369;">       objectif: Qauntit&#233; totale d&#233;sir&#233;e</span>
<span style="color: #556369;">    """</span>
    title = f<span style="color: #c3e88d;">'Collecte de </span>{item}<span style="color: #c3e88d;">'</span>
    <span style="color: #556369;">#</span><span style="color: #556369;">await ctx.send('coucou', view=ProgressView(objectif=objectif))</span>
    <span style="color: #89DDFF;">await</span> ctx.send<span style="color: #c792ea;">(</span>embed=progress_embed<span style="color: #f78c6c;">(</span>title, 0, objectif<span style="color: #f78c6c;">)</span>, view=ProgressView<span style="color: #f78c6c;">(</span>title=title, objectif=objectif<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgca8720e" class="outline-3">
<h3 id="orgca8720e"><span class="section-number-3">2.6.</span> Gestion des réactions aux messages</h3>
<div class="outline-text-3" id="text-2-6">
<p>
CertainP des messages issus des commandes du bot nécessitent une
analyse des réactions des utilisateurs.
</p>

<p>
Les réactions aux messages sont centralisées, et un <b>callback</b> unique
est appelé dès qu'une utilisateur réagit, indépendamment du
message. Or,nous ne voulons pas analyser les réactions aux messages
qui ne sont pas issus d'une commande du bot.
</p>

<p>
Il nous faut donc un mécanisme pour identifier si le message attaché
est d'un type intéressant et si oui, comment l'analyser. Il serait
possible de stocker en mémoire tous les messages issus de commandes
envoyés, mais pour me simplifier la vie je préfére embarquer cette
information dans les messages.
</p>

<p>
Malheureusement, je n'ai pas trouvé de champ non utilisé dans la
classe message. J'ai donc décidé de stocker le type directement dans
le contenu du message. Plus particulièrement dans le <b>footer</b> de
l'embed du message.
</p>
</div>
<div id="outline-container-orge0b57cb" class="outline-4">
<h4 id="orge0b57cb"><span class="section-number-4">2.6.1.</span> On reaction add</h4>
<div class="outline-text-4" id="text-2-6-1">
<div class="org-src-container">
<pre class="src src-python" id="org2a29b67"><span style="color: #c792ea;">@bot.event</span>
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">on_reaction_add</span><span style="color: #c792ea;">(</span>reaction, user<span style="color: #c792ea;">)</span>:
     <span style="color: #89DDFF;">if</span> user == bot.user:
         <span style="color: #89DDFF;">return</span>
     <span style="color: #89DDFF;">if</span> <span style="color: #89DDFF;">not</span> reaction.message.embeds:
         <span style="color: #89DDFF;">return</span>
     msg_type = reaction.message.embeds<span style="color: #c792ea;">[</span>-1<span style="color: #c792ea;">]</span>.footer.text

     <span style="color: #89DDFF;">if</span> msg_type == <span style="color: #c3e88d;">'Invasion'</span>:
         <span style="color: #89DDFF;">await</span> check_user_role<span style="color: #c792ea;">(</span>reaction, user<span style="color: #c792ea;">)</span>
         <span style="color: #89DDFF;">return</span>
     <span style="color: #89DDFF;">if</span> msg_type == <span style="color: #c3e88d;">'Instance'</span>:
         <span style="color: #89DDFF;">await</span> update_instance<span style="color: #c792ea;">(</span>reaction, user<span style="color: #c792ea;">)</span>
         <span style="color: #89DDFF;">return</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-org30ecf2d" class="outline-4">
<h4 id="org30ecf2d"><span class="section-number-4">2.6.2.</span> On reaction remove</h4>
<div class="outline-text-4" id="text-2-6-2">
<div class="org-src-container">
<pre class="src src-python" id="org88ac635"><span style="color: #c792ea;">@bot.event</span>
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">on_reaction_remove</span><span style="color: #c792ea;">(</span>reaction, user<span style="color: #c792ea;">)</span>:
     <span style="color: #89DDFF;">if</span> user == bot.user:
         <span style="color: #89DDFF;">return</span>
     <span style="color: #89DDFF;">if</span> <span style="color: #89DDFF;">not</span> reaction.message.embeds:
         <span style="color: #89DDFF;">return</span>
     msg_type = reaction.message.embeds<span style="color: #c792ea;">[</span>-1<span style="color: #c792ea;">]</span>.footer.text
     <span style="color: #89DDFF;">if</span> msg_type == <span style="color: #c3e88d;">'Invasion'</span>:
         <span style="color: #89DDFF;">await</span> update_invasion<span style="color: #c792ea;">(</span>reaction<span style="color: #c792ea;">)</span>
         <span style="color: #89DDFF;">return</span>
     <span style="color: #89DDFF;">if</span> msg_type == <span style="color: #c3e88d;">'Instance'</span>:
         <span style="color: #89DDFF;">await</span> update_instance_rm<span style="color: #c792ea;">(</span>reaction, user<span style="color: #c792ea;">)</span>
         <span style="color: #89DDFF;">return</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-orgb8276b4" class="outline-4">
<h4 id="orgb8276b4"><span class="section-number-4">2.6.3.</span> On s'assure que le joueur soit enregistré</h4>
<div class="outline-text-4" id="text-2-6-3">
<div class="org-src-container">
<pre class="src src-python" id="org72b2210"><span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">update_invasion</span><span style="color: #c792ea;">(</span>reaction<span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">selected</span> = <span style="color: #89DDFF;">await</span> reaction.message.reactions<span style="color: #c792ea;">[</span>0<span style="color: #c792ea;">]</span>.users<span style="color: #c792ea;">()</span>.flatten<span style="color: #c792ea;">()</span>
    <span style="color: #ffcb6b;">embed</span> = reaction.message.embeds<span style="color: #c792ea;">[</span>-1<span style="color: #c792ea;">]</span>
    embed.clear_fields<span style="color: #c792ea;">()</span>
    embed.add_field<span style="color: #c792ea;">(</span>name=<span style="color: #c3e88d;">"Enregistr&#233;s :"</span>, value=<span style="color: #82aaff;">len</span><span style="color: #f78c6c;">(</span>selected<span style="color: #f78c6c;">)</span>-1, inline=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">await</span> reaction.message.edit<span style="color: #c792ea;">(</span>embed=embed<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">check_user_role</span><span style="color: #c792ea;">(</span>reaction, user<span style="color: #c792ea;">)</span>:
    <span style="color: #556369;"># </span><span style="color: #556369;">R&#233;cup&#233;ration des don&#233;nes du Gdoc roster</span>
    df = get_roster<span style="color: #c792ea;">(</span>config<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">if</span> dtag<span style="color: #c792ea;">(</span>user<span style="color: #c792ea;">)</span> <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> df.index:
        embed = Embed.from_dict<span style="color: #c792ea;">(</span>config<span style="color: #f78c6c;">[</span><span style="color: #c3e88d;">"embeds"</span><span style="color: #f78c6c;">][</span><span style="color: #c3e88d;">"dm"</span><span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>
        embed.description += f<span style="color: #c3e88d;">'</span>{config["gdoc"]["form"]}<span style="color: #c3e88d;">) ***!***'</span>
        <span style="color: #89DDFF;">try</span>:
            <span style="color: #89DDFF;">await</span> user.send<span style="color: #c792ea;">(</span>embed=embed<span style="color: #c792ea;">)</span>
        <span style="color: #89DDFF;">except</span> disnake.errors.HTTPException <span style="color: #89DDFF;">as</span> e:
            <span style="color: #89DDFF;">pass</span>
    <span style="color: #89DDFF;">else</span>:
        guild = reaction.message.guild
        role = guild.get_role<span style="color: #c792ea;">(</span>config<span style="color: #f78c6c;">[</span><span style="color: #c3e88d;">"ids"</span><span style="color: #f78c6c;">][</span><span style="color: #c3e88d;">"role"</span><span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>

        <span style="color: #89DDFF;">await</span> update_invasion<span style="color: #c792ea;">(</span>reaction<span style="color: #c792ea;">)</span>

        <span style="color: #89DDFF;">await</span> user.edit<span style="color: #c792ea;">(</span>nick=df.at<span style="color: #f78c6c;">[</span>dtag<span style="color: #c3e88d;">(</span>user<span style="color: #c3e88d;">)</span>, <span style="color: #c3e88d;">"Pseudo IG"</span><span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>
        <span style="color: #89DDFF;">if</span> role <span style="color: #89DDFF;">is</span> <span style="color: #f78c6c;">None</span>:
            <span style="color: #556369;"># </span><span style="color: #556369;">Make sure the role still exists and is valid.</span>
            <span style="color: #89DDFF;">return</span>
        <span style="color: #89DDFF;">try</span>:
            <span style="color: #556369;"># </span><span style="color: #556369;">Finally, add the role.</span>
            <span style="color: #89DDFF;">await</span> user.add_roles<span style="color: #c792ea;">(</span>role<span style="color: #c792ea;">)</span>
        <span style="color: #89DDFF;">except</span> disnake.HTTPException:
            <span style="color: #556369;"># </span><span style="color: #556369;">If we want to do something in case of errors we'd do it here.</span>
            ...
</pre>
</div>
</div>
</div>

<div id="outline-container-org2b85d7a" class="outline-4">
<h4 id="org2b85d7a"><span class="section-number-4">2.6.4.</span> Gestion ajout réaction message Instance</h4>
<div class="outline-text-4" id="text-2-6-4">
<div class="org-src-container">
<pre class="src src-python" id="org64ddafe"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">instance_data</span><span style="color: #c792ea;">(</span>reaction<span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">fields</span> = <span style="color: #c792ea;">{</span>e.name: e.value.split<span style="color: #f78c6c;">(</span><span style="color: #c3e88d;">'\n'</span><span style="color: #f78c6c;">)</span> <span style="color: #89DDFF;">for</span> e <span style="color: #89DDFF;">in</span> reaction.message.embeds<span style="color: #f78c6c;">[</span>-1<span style="color: #f78c6c;">]</span>.fields<span style="color: #c792ea;">}</span>
    <span style="color: #89DDFF;">return</span> fields<span style="color: #c792ea;">[</span><span style="color: #c3e88d;">'R&#244;les'</span><span style="color: #c792ea;">]</span>, fields<span style="color: #c792ea;">[</span><span style="color: #c3e88d;">'Joueurs'</span><span style="color: #c792ea;">]</span>

<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">update_instance_embed</span><span style="color: #c792ea;">(</span>reaction, roles, joueurs<span style="color: #c792ea;">)</span>:
    <span style="color: #556369;"># </span><span style="color: #556369;">R&#233;cup&#233;ration et mise &#224; jour du message initial</span>
    <span style="color: #ffcb6b;">embed</span> = reaction.message.embeds<span style="color: #c792ea;">[</span>-1<span style="color: #c792ea;">]</span>
    embed.clear_fields<span style="color: #c792ea;">()</span>
    embed.add_field<span style="color: #c792ea;">(</span>name=<span style="color: #c3e88d;">"R&#244;les"</span>, value=list_to_field<span style="color: #f78c6c;">(</span>roles<span style="color: #f78c6c;">)</span>, inline=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>
    embed.add_field<span style="color: #c792ea;">(</span>name=<span style="color: #c3e88d;">"Joueurs"</span>, value=list_to_field<span style="color: #f78c6c;">(</span>joueurs<span style="color: #f78c6c;">)</span>, inline=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">await</span> reaction.message.edit<span style="color: #c792ea;">(</span>embed=embed<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">update_instance</span><span style="color: #c792ea;">(</span>reaction, user, add=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>:
    message = reaction.message
    cmd_author = message.interaction.user

    roles, joueurs = instance_data<span style="color: #c792ea;">(</span>reaction<span style="color: #c792ea;">)</span>

    <span style="color: #89DDFF;">if</span> reaction.emoji == <span style="color: #c3e88d;">'&#9989;'</span>:
        <span style="color: #89DDFF;">if</span> user == cmd_author:
            <span style="color: #556369;"># </span><span style="color: #556369;">Create vocal and swap users</span>

            categories = message.guild.categories
            category = disnake.utils.find<span style="color: #c792ea;">(</span><span style="color: #89DDFF;">lambda</span> c: c.<span style="color: #82aaff;">id</span> == 948167052722573322, categories<span style="color: #c792ea;">)</span>
            voice = <span style="color: #89DDFF;">await</span> category.create_voice_channel<span style="color: #c792ea;">(</span>f<span style="color: #c3e88d;">'Instance de </span>{user.display_name}<span style="color: #c3e88d;">'</span><span style="color: #c792ea;">)</span>

            ids = <span style="color: #c792ea;">[</span><span style="color: #82aaff;">int</span><span style="color: #f78c6c;">(</span>re.sub<span style="color: #c3e88d;">(</span><span style="color: #c3e88d;">"[^0-9]"</span>, <span style="color: #c3e88d;">""</span>, j<span style="color: #c3e88d;">)</span><span style="color: #f78c6c;">)</span> <span style="color: #89DDFF;">for</span> j <span style="color: #89DDFF;">in</span> joueurs <span style="color: #89DDFF;">if</span> j != <span style="color: #c3e88d;">'libre'</span><span style="color: #c792ea;">]</span>

            users = <span style="color: #89DDFF;">await</span> message.guild.getch_members<span style="color: #c792ea;">(</span>ids<span style="color: #c792ea;">)</span>

            <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> users:
                <span style="color: #89DDFF;">if</span> u.voice:
                    <span style="color: #89DDFF;">await</span> u.move_to<span style="color: #c792ea;">(</span>voice<span style="color: #c792ea;">)</span>
                <span style="color: #89DDFF;">else</span>:
                    invite = <span style="color: #89DDFF;">await</span> voice.create_invite<span style="color: #c792ea;">()</span>
                    <span style="color: #89DDFF;">await</span> u.send<span style="color: #c792ea;">(</span>f<span style="color: #c3e88d;">"L'instance a d&#233;marr&#233;, rejoins ici : </span>{invite}<span style="color: #c3e88d;"> "</span>, embed=message.embeds<span style="color: #f78c6c;">[</span>-1<span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>
            <span style="color: #89DDFF;">await</span> message.delete<span style="color: #c792ea;">(</span>delay=60<span style="color: #c792ea;">)</span>
            <span style="color: #89DDFF;">return</span>

    <span style="color: #89DDFF;">if</span> reaction.emoji == <span style="color: #c3e88d;">'&#10060;'</span>:
        <span style="color: #89DDFF;">if</span> user == cmd_author:
            <span style="color: #89DDFF;">await</span> message.delete<span style="color: #c792ea;">()</span>
        <span style="color: #89DDFF;">return</span>

    <span style="color: #89DDFF;">if</span> user.mention <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> joueurs:
        <span style="color: #89DDFF;">for</span> i, r <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">enumerate</span><span style="color: #c792ea;">(</span>roles<span style="color: #c792ea;">)</span>:
            <span style="color: #89DDFF;">if</span> reaction.emoji == r <span style="color: #89DDFF;">and</span> joueurs<span style="color: #c792ea;">[</span>i<span style="color: #c792ea;">]</span> == <span style="color: #c3e88d;">'libre'</span>:
                joueurs<span style="color: #c792ea;">[</span>i<span style="color: #c792ea;">]</span> = user.mention
                <span style="color: #89DDFF;">break</span>

    <span style="color: #89DDFF;">await</span> update_instance_embed<span style="color: #c792ea;">(</span>reaction, roles, joueurs<span style="color: #c792ea;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc22fb9d" class="outline-4">
<h4 id="orgc22fb9d"><span class="section-number-4">2.6.5.</span> Gestion annulation réaction message Instance</h4>
<div class="outline-text-4" id="text-2-6-5">
<div class="org-src-container">
<pre class="src src-python" id="org169a80d"><span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">update_instance_rm</span><span style="color: #c792ea;">(</span>reaction, user<span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">roles</span>, <span style="color: #ffcb6b;">joueurs</span> = instance_data<span style="color: #c792ea;">(</span>reaction<span style="color: #c792ea;">)</span>
    <span style="color: #556369;"># </span><span style="color: #556369;">Le joueur est-il s&#233;l&#233;ctionn&#233; ?</span>
    <span style="color: #89DDFF;">if</span> user.mention <span style="color: #89DDFF;">in</span> joueurs:
        <span style="color: #556369;"># </span><span style="color: #556369;">On le supprime de la liste des joueurs en le remplacant par libre</span>
        <span style="color: #89DDFF;">for</span> i, r <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">enumerate</span><span style="color: #c792ea;">(</span>roles<span style="color: #c792ea;">)</span>:
            <span style="color: #89DDFF;">if</span> joueurs<span style="color: #c792ea;">[</span>i<span style="color: #c792ea;">]</span> == user.mention <span style="color: #89DDFF;">and</span> r==reaction.emoji:
                joueurs<span style="color: #c792ea;">[</span>i<span style="color: #c792ea;">]</span> = <span style="color: #c3e88d;">'libre'</span>
                <span style="color: #89DDFF;">break</span>

        <span style="color: #89DDFF;">for</span> i, r <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">enumerate</span><span style="color: #c792ea;">(</span>roles<span style="color: #c792ea;">)</span>:
            <span style="color: #89DDFF;">if</span> joueurs<span style="color: #c792ea;">[</span>i<span style="color: #c792ea;">]</span> == <span style="color: #c3e88d;">'libre'</span>:
                disponibles = <span style="color: #c792ea;">[</span>d <span style="color: #89DDFF;">for</span> d <span style="color: #89DDFF;">in</span> reaction.message.reactions <span style="color: #89DDFF;">if</span> d.emoji == r<span style="color: #c792ea;">][</span>-1<span style="color: #c792ea;">]</span>
                <span style="color: #556369;"># </span><span style="color: #556369;">On r&#233;cup&#233;re les utilisateurs en prennat soint de filtrer le bot</span>
                disponibles = <span style="color: #c792ea;">[</span>u <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> <span style="color: #89DDFF;">await</span> disponibles.users<span style="color: #f78c6c;">()</span>.flatten<span style="color: #f78c6c;">()</span> <span style="color: #89DDFF;">if</span> u != bot.user <span style="color: #89DDFF;">and</span> u.mention <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> joueurs<span style="color: #c792ea;">]</span>
                <span style="color: #89DDFF;">if</span> disponibles:
                    joueurs<span style="color: #c792ea;">[</span>i<span style="color: #c792ea;">]</span> = disponibles<span style="color: #c792ea;">[</span>0<span style="color: #c792ea;">]</span>.mention

    <span style="color: #89DDFF;">await</span> update_instance_embed<span style="color: #c792ea;">(</span>reaction, roles, joueurs<span style="color: #c792ea;">)</span>

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org293cd9c" class="outline-3">
<h3 id="org293cd9c"><span class="section-number-3">2.7.</span> Gestion des changement d'état vocaux</h3>
<div class="outline-text-3" id="text-2-7">
<p>
(aka quand un user change de channel vocal)
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgf540e0a"><span style="color: #c792ea;">@bot.event</span>
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">on_voice_state_update</span><span style="color: #c792ea;">(</span>member, before, after<span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">instances_cat</span> = 948167052722573322
    <span style="color: #ffcb6b;">invasions_cat</span> = 906648457824051252
    <span style="color: #ffcb6b;">to_purge</span> = <span style="color: #c792ea;">[</span>instances_cat, invasions_cat<span style="color: #c792ea;">]</span>

    <span style="color: #ffcb6b;">invasions_waiting</span> = 948204662086058076
    <span style="color: #ffcb6b;">instances_waiting</span> = 948198317983146034
    <span style="color: #ffcb6b;">protected</span> = <span style="color: #c792ea;">[</span>invasions_waiting, instances_waiting<span style="color: #c792ea;">]</span>
    <span style="color: #89DDFF;">if</span> before.channel <span style="color: #89DDFF;">and</span> before.channel.category_id <span style="color: #89DDFF;">in</span> to_purge:
        <span style="color: #89DDFF;">if</span> <span style="color: #89DDFF;">not</span> before.channel.members <span style="color: #89DDFF;">and</span> before.channel.<span style="color: #82aaff;">id</span> <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> protected:
            <span style="color: #89DDFF;">await</span> before.channel.delete<span style="color: #c792ea;">()</span>
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-org1a82c7b" class="outline-2">
<h2 id="org1a82c7b"><span class="section-number-2">3.</span> Test ui</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgf30487c" class="outline-3">
<h3 id="orgf30487c"><span class="section-number-3">3.1.</span> Modal (sorte de formulaire)</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">class</span> <span style="color: #c792ea;">MyModal</span><span style="color: #c792ea;">(</span>disnake.ui.Modal<span style="color: #c792ea;">)</span>:
    <span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">__init__</span><span style="color: #c792ea;">(</span><span style="color: #89DDFF;">self</span><span style="color: #c792ea;">)</span> -&gt; <span style="color: #f78c6c;">None</span>:
        components = <span style="color: #c792ea;">[</span>
            disnake.ui.TextInput<span style="color: #f78c6c;">(</span>
                label=<span style="color: #c3e88d;">"Name"</span>,
                placeholder=<span style="color: #c3e88d;">"The name of the tag"</span>,
                custom_id=<span style="color: #c3e88d;">"name"</span>,
                style=disnake.TextInputStyle.short,
                max_length=50,
            <span style="color: #f78c6c;">)</span>,
            disnake.ui.TextInput<span style="color: #f78c6c;">(</span>
                label=<span style="color: #c3e88d;">"Description"</span>,
                placeholder=<span style="color: #c3e88d;">"The description of the tag"</span>,
                custom_id=<span style="color: #c3e88d;">"description"</span>,
                style=disnake.TextInputStyle.short,
                min_length=5,
                max_length=50,
            <span style="color: #f78c6c;">)</span>,
            disnake.ui.TextInput<span style="color: #f78c6c;">(</span>
                label=<span style="color: #c3e88d;">"Content"</span>,
                placeholder=<span style="color: #c3e88d;">"The content of the tag"</span>,
                custom_id=<span style="color: #c3e88d;">"content"</span>,
                style=disnake.TextInputStyle.paragraph,
                min_length=5,
                max_length=1024,
            <span style="color: #f78c6c;">)</span>,
        <span style="color: #c792ea;">]</span>
        <span style="color: #82aaff;">super</span><span style="color: #c792ea;">()</span>.__init__<span style="color: #c792ea;">(</span>title=<span style="color: #c3e88d;">"Create Tag"</span>, custom_id=<span style="color: #c3e88d;">"create_tag"</span>, components=components<span style="color: #c792ea;">)</span>

    <span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">callback</span><span style="color: #c792ea;">(</span><span style="color: #89DDFF;">self</span>, inter: disnake.ModalInteraction<span style="color: #c792ea;">)</span> -&gt; <span style="color: #f78c6c;">None</span>:
        embed = disnake.Embed<span style="color: #c792ea;">(</span>title=<span style="color: #c3e88d;">"Tag Creation"</span><span style="color: #c792ea;">)</span>
        <span style="color: #89DDFF;">for</span> key, value <span style="color: #89DDFF;">in</span> inter.text_values.items<span style="color: #c792ea;">()</span>:
            embed.add_field<span style="color: #c792ea;">(</span>name=key.capitalize<span style="color: #f78c6c;">()</span>, value=value, inline=<span style="color: #f78c6c;">False</span><span style="color: #c792ea;">)</span>
        <span style="color: #89DDFF;">await</span> inter.response.send_message<span style="color: #c792ea;">(</span>embed=embed<span style="color: #c792ea;">)</span>

    <span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">on_error</span><span style="color: #c792ea;">(</span><span style="color: #89DDFF;">self</span>, error: <span style="color: #c792ea;">Exception</span>, inter: disnake.ModalInteraction<span style="color: #c792ea;">)</span> -&gt; <span style="color: #f78c6c;">None</span>:
        <span style="color: #89DDFF;">await</span> inter.response.send_message<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">"Oops, something went wrong."</span>, ephemeral=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>

<span style="color: #c792ea;">@bot.slash_command</span><span style="color: #c792ea;">()</span>
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">testmodal</span><span style="color: #c792ea;">(</span>ctx: disnake.CommandInteraction<span style="color: #c792ea;">)</span>:
    <span style="color: #556369;">"""Cr&#233;&#233; un &#233;v&#233;nement</span>

<span style="color: #556369;">       Parameters</span>
<span style="color: #556369;">       ----------</span>

<span style="color: #556369;">    """</span>
    <span style="color: #89DDFF;">await</span> ctx.response.send_modal<span style="color: #c792ea;">(</span>modal=MyModal<span style="color: #f78c6c;">()</span><span style="color: #c792ea;">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Virgile</p>
<p class="date">Created: 2022-05-04 mer. 16:42</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
