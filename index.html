<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-02-25 ven. 16:28 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Invabot</title>
<meta name="author" content="ipsum" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<style type="text/css">
 pre.src {background-color: #263238; color: #EEFFFF;}</style>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Invabot</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org2d51229">1. Documentation des rôles</a>
<ul>
<li><a href="#orgd5e27a7">1.1. Arc</a></li>
<li><a href="#org943d788">1.2. Mousquet</a></li>
<li><a href="#orga927242">1.3. Anti-Trash</a></li>
<li><a href="#org03b5481">1.4. DPS debuff</a></li>
<li><a href="#orgb01bd2c">1.5. Pustule boy</a></li>
<li><a href="#org9096513">1.6. Réparateur</a></li>
<li><a href="#org3ded03e">1.7. Artilleur</a></li>
<li><a href="#org09a74e3">1.8. Heal</a></li>
<li><a href="#org2040078">1.9. Mage AOE</a></li>
</ul>
</li>
<li><a href="#org8884904">2. Bot</a>
<ul>
<li><a href="#orgcdbb35a">2.1. Concept :</a></li>
<li><a href="#org1f6bbaa">2.2. Configuration</a></li>
<li><a href="#org7b7fd66">2.3. Utilitaires</a>
<ul>
<li><a href="#orgfe4483d">2.3.1. Dépendances</a></li>
<li><a href="#org03bca2c">2.3.2. Chargement de la config</a></li>
<li><a href="#orgfd88f69">2.3.3. Persistance</a></li>
<li><a href="#orgf60f325">2.3.4. Chargement du token</a></li>
<li><a href="#orga5133c2">2.3.5. Identifiant</a></li>
<li><a href="#org1d5af72">2.3.6. Récupération du roster</a></li>
<li><a href="#org46b8150">2.3.7. Récupération de la strat</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgeaf50fe">3. Algo</a>
<ul>
<li><a href="#org0e393bb">3.1. Test algo</a></li>
</ul>
</li>
<li><a href="#orgb6ac720">4. <span class="todo TODO">TODO</span> bot avec Disnake</a>
<ul>
<li><a href="#orgeccd582">4.1. Corp</a></li>
<li><a href="#org2160a08">4.2. Commande inva</a></li>
<li><a href="#orgd80f999">4.3. Commande verif</a></li>
<li><a href="#orgecd4efa">4.4. Commande transfert</a></li>
<li><a href="#org50ec56d">4.5. Commande Instance</a></li>
<li><a href="#org6fdafdd">4.6. Gestion des réactions aux messages</a>
<ul>
<li><a href="#org9ee38e8">4.6.1. On reaction add</a></li>
<li><a href="#org7722894">4.6.2. On reaction remove</a></li>
<li><a href="#org350506d">4.6.3. On s'assure que le joueur soit enregistré</a></li>
<li><a href="#org6fa1a0f">4.6.4. Gestion ajout réaction message Instance</a></li>
<li><a href="#org7db20d9">4.6.5. Gestion annulation réaction message Instance</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org2d51229" class="outline-2">
<h2 id="org2d51229"><span class="section-number-2">1.</span> Documentation des rôles</h2>
<div class="outline-text-2" id="text-1">
<script async src="https://nwdb.info/embed.js"></script>
<p>
Cette section a pour objectif de présenter les différents rôles utiles
en invasion. Chaque rôle comporte des composantes indispensables,
illustrées par le sigle suivant : <i>(obligatoire)</i>. Afin de mieux
maîtriser la répartition des rôles, il sera demandé aux joueurs
d'évaluer leur pertinence pour chacun de ces rôles.
</p>

<p>
Un joueur peut s'estimer :
</p>

<dl class="org-dl">
<dt>Capable</dt><dd>S'il répond à tous les critères tagués <b><i>(obligatoire)</i></b></dd>
<dt>Opti</dt><dd>S'il répond a tous les critères tagués <b><i>(obligatoire)</i></b> <b>ET</b> <b><i>(recommandé)</i></b>.</dd>
</dl>
</div>

<div id="outline-container-orgd5e27a7" class="outline-3">
<h3 id="orgd5e27a7"><span class="section-number-3">1.1.</span> Arc</h3>
<div class="outline-text-3" id="text-1-1">
<dl class="org-dl">
<dt><b>Objectif</b></dt><dd>DPS les <b>têtes</b>, les <b>boss</b>, les engins de sièges et
AoE les trashs, dans cet ordre de priorité.</dd>
<dt><b>Arme principale</b></dt><dd>Arc 580 GS min. <a href="https://nwdb.info/db/perk/perkid_weapon_dmgcorrupted">Corrupted Bane</a> <b><i>(obligatoire)</i></b> et <a href="https://nwdb.info/db/perk/perkid_weapon_empoweroncrit">Keenly
Empowered</a> <b><i>(recommandé)</i></b>. <a href="https://nwdb.info/build?skills=4-iw75uo-ngewxw">Build arc</a> <b><i>(recommandé)</i></b></dd>
<dt><b>Arme secondaire</b></dt><dd>Arme débuff distance comme la hachette ou la lance avec <a href="https://nwdb.info/db/perk/perkid_ability_spear_javelin">Sundering Javelin</a> sur pièce d'armure <b><i>(recommandé)</i></b></dd>
<dt><b>Armure et perks</b></dt><dd>Légère avec perks pour l'arc<a href="https://nwdb.info/db/perk/perkid_ability_bow_poisonshot"> Enfeebling Poison Shot</a> et <a href="https://nwdb.info/db/perk/perkid_ability_bow_rapidshot">Penetrating Rapid Shot</a> <b><i>(recommandé)</i></b></dd>
</dl>
<p>
<a href="https://nwdb.info/db/perk/perkid_ability_spear_javelin">      Sundering Javelin</a> <b><i>(recommandé si lance en secondaire)</i></b>
</p>
</div>
</div>

<div id="outline-container-org943d788" class="outline-3">
<h3 id="org943d788"><span class="section-number-3">1.2.</span> Mousquet</h3>
<div class="outline-text-3" id="text-1-2">
<dl class="org-dl">
<dt><b>Objectif</b></dt><dd>DPS les <b>têtes</b> et les <b>boss</b>, dans cet ordre de priorité.</dd>
<dt><b>Arme principale</b></dt><dd>Mousquet 570 GS min. <a href="https://nwdb.info/db/perk/perkid_weapon_dmgcorrupted">Corrupted Bane</a> <b><i>(obligatoire)</i></b> et
<a href="https://nwdb.info/db/perk/perkid_weapon_dmgbasic">Enchanted</a> <b><i>(recommandé)</i></b>  <a href="https://nwdb.info/build?skills=6-nm5y04-qtbfgg">Build Mousquet</a> <b><i>(recommandé)</i></b></dd>
<dt><b>Armure et perks</b></dt><dd>Légère avec perks pour le mousquet <a href="https://nwdb.info/db/perk/perkid_ability_musket_shootersstance">Empowering Shooter's
Stance</a> <b><i>(recommandé)</i></b>.</dd>
</dl>
</div>
</div>

<div id="outline-container-orga927242" class="outline-3">
<h3 id="orga927242"><span class="section-number-3">1.3.</span> Anti-Trash</h3>
<div class="outline-text-3" id="text-1-3">
<dl class="org-dl">
<dt><b>Objectif</b></dt><dd>Empêcher les <b>trash-mobs</b> d'atteindre les autres joueurs et les portes.</dd>
<dt><b>Arme principale</b></dt><dd>Hache double 580 GS min. <a href="https://nwdb.info/db/perk/perkid_weapon_dmgcorrupted">Corrupted Bane</a> <b><i>(obligatoire)</i></b>
<a href="https://nwdb.info/db/item/sapphirecutt4">Pristine Sapphire</a> <b><i>(obligatoire)</i></b> et [[<a href="https://nwdb.info/db/item/sapphirecutt4">https://nwdb.info/db/item/sapphirecutt4</a> <a href="https://nwdb.info/db/perk/perkid_weapon_empoweroncrit">Keenly Empowered</a> (recommandé).
<a href="https://nwdb.info/build?skills=8-j1mxog-kc3hhg">Build Hache double</a> <b><i>(obligatoire)</i></b></dd>
<dt><b>Arme secondaire</b></dt><dd>Arme CàC, Marteau pour le contrôle ?</dd>
<dt><b>Armure et perks</b></dt><dd>Lourde <b><i>(recommandé)</i></b> <a href="https://nwdb.info/db/perk/perkid_ability_greataxe_gravitywell">Insatiable Gravity Well</a>
<b><i>(obligatoire)*</i> <a href="https://nwdb.info/db/perk/perkid_ability_greataxe_maelstrom">Enfeebling Maelstrom</a> et <a href="https://nwdb.info/db/perk/perkid_ability_greataxe_whirlwind">Fortifying Whirlwind</a>
*/(recommandé)/</b> et pour de la survivabilité <a href="https://nwdb.info/db/perk/perkid_armor_defcorrupted">Corrupted Ward</a> sur
quelques pièces <b><i>(recommandé)</i></b></dd>
</dl>
</div>
</div>

<div id="outline-container-org03b5481" class="outline-3">
<h3 id="org03b5481"><span class="section-number-3">1.4.</span> DPS debuff</h3>
<div class="outline-text-3" id="text-1-4">
<dl class="org-dl">
<dt><b>Objectif</b></dt><dd>Appliquer <b><i>rend</i></b> et <b><i>weaken</i></b> aux boss et les DPS</dd>
<dt><b>Arme principale</b></dt><dd>Lance 580 GS min. <a href="https://nwdb.info/db/perk/perkid_weapon_dmgcorrupted">Corrupted Bane</a> <b><i>(obligatoire)</i></b> et
<a href="https://nwdb.info/db/perk/perkid_weapon_empoweroncrit">Keenly Empowered</a> ou <a href="https://nwdb.info/db/perk/perkid_weaponmelee_dmgback">Rogue</a> <b><i>(recommandé)</i></b>. <a href="https://nwdb.info/build?skills=10-l71p4w-tsmm2s">Build lance</a>
<b><i>(obligatoire)</i></b></dd>
<dt><b>Arme secondaire</b></dt><dd>Arc préféré, mais peut être une arme de CàC.</dd>
<dt><b>Armure</b></dt><dd>Légère avec perks <a href="https://nwdb.info/db/perk/perkid_ability_spear_javelin">Sundering Javelin</a> <b><i>(obligatoire)</i></b>
<a href="https://nwdb.info/db/perk/perkid_ability_spear_skewer">Enfeebling Skewer</a> <b><i>(obligatoire)</i></b> <a href="https://nwdb.info/db/perk/perkid_ability_spear_perforate">Fortifying Perforate</a> <b><i>(recommandé)</i></b>
et pour de la survivabilité <a href="https://nwdb.info/db/perk/perkid_armor_defcorrupted">Corrupted Ward</a> sur quelques pièces <b><i>(recommandé)</i></b></dd>
</dl>
</div>
</div>

<div id="outline-container-orgb01bd2c" class="outline-3">
<h3 id="orgb01bd2c"><span class="section-number-3">1.5.</span> Pustule boy</h3>
<div class="outline-text-3" id="text-1-5">
<dl class="org-dl">
<dt><b>Objectif</b></dt><dd>Tirer en <b>priorité sur les pustules</b> qui se forment
lors de l'impact d'un bison à l'intérieur du fort. Aider au centre.</dd>

<dt><b>Arme principale</b></dt><dd>Arme distante <b><i>(obligatoire)</i></b>, les armes
Néant/Arc/Feu <b><i>(recommandé)</i></b> sont plus efficaces dans ce rôle
grâce à une meilleure cadence de tir.</dd>
<dt><b>Arme secondaire</b></dt><dd>Arc/Mousquet <b><i>(recommandé)</i></b></dd>
</dl>
</div>
</div>

<div id="outline-container-org9096513" class="outline-3">
<h3 id="org9096513"><span class="section-number-3">1.6.</span> Réparateur</h3>
<div class="outline-text-3" id="text-1-6">
<dl class="org-dl">
<dt><b>Objectif</b></dt><dd>Gérer les ressources et <b>réparer les portes</b>.</dd>
<dt><b>Arme principale</b></dt><dd>Hachette avec <a href="https://nwdb.info/db/ability/ult_passive_hatchet_immortalwhen0hp">Defy Death</a> <b><i>(recommandé)</i></b></dd>
<dt><b>Arme secondaire</b></dt><dd>Arme avec mobilité <b><i>(recommandé)</i></b></dd>
</dl>

<p>
PS: Si vous n'avez jamais joué Hachette, il suffit de débloquer 12
points de compétence. C'est assez rapide et vous n'avez pas besoin
d'une arme haut niveau/particulière.
</p>
</div>
</div>

<div id="outline-container-org3ded03e" class="outline-3">
<h3 id="org3ded03e"><span class="section-number-3">1.7.</span> Artilleur</h3>
<div class="outline-text-3" id="text-1-7">
<dl class="org-dl">
<dt><b>Objectif</b></dt><dd>Tuer les bombers, les tireurs, les artilleries
ennemies et les trash mob, en respectant cet ordre de priorité.</dd>

<dt><b>Arme principale</b></dt><dd>Épée avec la compétence <a href="https://nwdb.info/db/ability/ultimate_sword_swordmaster">Leadership</a> <b><i>(obligatoire)</i></b></dd>
<dt><b>Arme secondaire</b></dt><dd>Bâton de feu/vie/hachette <b><i>(recommandé)</i></b></dd>
</dl>

<p>
PS: Si vous n'avez jamais joué l'épée, il suffit de débloquer 12
points de compétence. C'est assez rapide et vous n'avez pas besoin
d'une arme haut niveau/particulière.
</p>
</div>
</div>
<div id="outline-container-org09a74e3" class="outline-3">
<h3 id="org09a74e3"><span class="section-number-3">1.8.</span> Heal</h3>
<div class="outline-text-3" id="text-1-8">
<dl class="org-dl">
<dt><b>Objectif</b></dt><dd>Maintenir l'équipe <b>Anti-trash</b> en vie en priorité
puis empêcher les <b>trash-mobs</b> d'atteindre les autres joueurs et les
portes.</dd>
<dt><b>Arme principale</b></dt><dd>Bâton de vie 580 GS min <b><i>(obligatoire)</i></b> avec <a href="https://nwdb.info/db/perk/perkid_weaponlife_healoutgoing">Blessed</a>
<b><i>(recommandé)</i></b></dd>
<dt><b>Arme secondaire</b></dt><dd><p>
Hache double avec <a href="https://nwdb.info/db/perk/perkid_weapon_dmgcorrupted">Corrupted Bane</a> et <a href="https://nwdb.info/db/item/ambercutt4">Pristine
Amber</a> <b><i>(recommandé)</i></b> <a href="https://nwdb.info/build?skills=8-j1mxog-kc3hhg">Build Hache double</a> <b><i>(recommandé)</i></b>
</p>

<p>
OU
</p>

<p>
Gantelet du néant
</p></dd>

<dt><b>Armure</b></dt><dd><a href="https://nwdb.info/db/perk/perkid_armor_defcorrupted">Corrupted Ward</a> sur quelques pièces <b><i>(recommandé)</i></b></dd>
</dl>
</div>
</div>


<div id="outline-container-org2040078" class="outline-3">
<h3 id="org2040078"><span class="section-number-3">1.9.</span> Mage AOE</h3>
<div class="outline-text-3" id="text-1-9">
<dl class="org-dl">
<dt><b>Objectif</b></dt><dd>DPS les <b>boss</b> dans les phases de fin, quand ils
s'accumulent sur les portes.</dd>
<dt><b>Arme principale</b></dt><dd>Bâton de feu 580 GS min. <a href="https://nwdb.info/db/perk/perkid_weapon_dmgcorrupted">Corrupted Bane</a> avec <a href="https://nwdb.info/db/item/sapphirecutt4">Pristine Sapphire</a> <b><i>(obligatoire)</i></b>
et <a href="https://nwdb.info/db/perk/perkid_weapon_empoweroncrit">Keenly Empowered</a> <b><i>(recommandé)</i></b>.</dd>
<dt><b>Arme secondaire possible</b></dt><dd>Mousquet <a href="https://nwdb.info/db/perk/perkid_weapon_dmgcorrupted">Corrupted Bane</a> et <a href="https://nwdb.info/db/perk/perkid_weapon_dmgbasic">Enchanted</a> avec
<a href="https://nwdb.info/db/item/sapphirecutt4">Pristine Sapphire</a> <b><i>(recommandé)</i></b>
OU
Gantelet de glace pour bloquer les boss</dd>
<dt><b>Armure</b></dt><dd>Légère</dd>
</dl>
</div>
</div>
</div>


<div id="outline-container-org8884904" class="outline-2">
<h2 id="org8884904"><span class="section-number-2">2.</span> Bot</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgcdbb35a" class="outline-3">
<h3 id="orgcdbb35a"><span class="section-number-3">2.1.</span> Concept :</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Le bot à pour objectif de générer une composition d'armée à partir des
50 joueurs sélectionnés aléatoirement par le jeu.
</p>
</div>
</div>

<div id="outline-container-org1f6bbaa" class="outline-3">
<h3 id="org1f6bbaa"><span class="section-number-3">2.2.</span> Configuration</h3>
<div class="outline-text-3" id="text-2-2">
<p>
La configuration du bot passera par un fichier json unique, contenant
le corps des différents messages à transmettre ainsi que les adresses
des Gdoc à lire.
</p>
<div class="org-src-container">
<pre class="src src-json"><span style="color: #c792ea;">{</span>
<span style="color: #89DDFF;">"ids"</span>: <span style="color: #f78c6c;">{</span>
    <span style="color: #89DDFF;">"role"</span>: <span style="color: #f78c6c;">917546013248606238</span>,
    <span style="color: #89DDFF;">"leads"</span>: <span style="color: #f78c6c;">928316217297612810</span>
<span style="color: #f78c6c;">}</span>,
<span style="color: #89DDFF;">"doc"</span>:<span style="color: #f78c6c;">{</span>
    <span style="color: #89DDFF;">"url"</span>: <span style="color: #c3e88d;">"https://virgile-dauge.github.io/invabot/"</span>
<span style="color: #f78c6c;">}</span>,
<span style="color: #89DDFF;">"imgs"</span>: <span style="color: #f78c6c;">{</span>
    <span style="color: #89DDFF;">"layout"</span>: <span style="color: #c3e88d;">"https://cdn.discordapp.com/attachments/917547596640296990/922901028519706674/layout.png"</span>
<span style="color: #f78c6c;">}</span>,
<span style="color: #89DDFF;">"embeds"</span>: <span style="color: #f78c6c;">{</span>
    <span style="color: #89DDFF;">"panneau"</span>: <span style="color: #c3e88d;">{</span>
        <span style="color: #89DDFF;">"title"</span>: <span style="color: #c3e88d;">"Confirme ta s&#233;l&#233;ction &#224; l'invasion de"</span>,
        <span style="color: #89DDFF;">"color"</span>: <span style="color: #f78c6c;">2003199</span>,
        <span style="color: #89DDFF;">"description"</span>: <span style="color: #c3e88d;">"R&#233;agis avec :ballot_box_with_check: &#224; ce message **uniquement si tu es d&#233;j&#224; dans le fort**. Attention, retourne vite en jeu, l'auto-AFK kick est rapide (2min). \n\n Si tu as r&#233;agi par erreur, merci de d&#233;cocher ta r&#233;action. :wink: \n\n*(Et si vous aussi vous pensez que bakhu est la meilleure guilde)*"</span>
    <span style="color: #c3e88d;">}</span>,
    <span style="color: #89DDFF;">"dm"</span>: <span style="color: #c3e88d;">{</span>
        <span style="color: #89DDFF;">"title"</span>: <span style="color: #c3e88d;">"Dis nous tout !"</span>,
        <span style="color: #89DDFF;">"color"</span>: <span style="color: #f78c6c;">2003199</span>,
        <span style="color: #89DDFF;">"description"</span>: <span style="color: #c3e88d;">"Tu es inscrit en invasion, mais tu n'as pas renseign&#233; **les r&#244;les** que tu peux jouer. Il n'est donc par cons&#233;quent pas possible de t'assigner un poste automatiquement. Allez, file remplir [ce document]("</span>
    <span style="color: #c3e88d;">}</span>,
    <span style="color: #89DDFF;">"change"</span>: <span style="color: #c3e88d;">{</span>
        <span style="color: #89DDFF;">"title"</span>: <span style="color: #c3e88d;">"Tu as chang&#233; ton discord TAG :/"</span>,
        <span style="color: #89DDFF;">"color"</span>: <span style="color: #f78c6c;">2003199</span>,
        <span style="color: #89DDFF;">"description"</span>: <span style="color: #c3e88d;">"Il faut mettre &#224; jour tes infos. Allez, file remplir [ce document]("</span>
    <span style="color: #c3e88d;">}</span>,
    <span style="color: #89DDFF;">"help"</span>: <span style="color: #c3e88d;">{</span>
        <span style="color: #89DDFF;">"title"</span>: <span style="color: #c3e88d;">"Manuel d'utilisation d'invabot"</span>,
        <span style="color: #89DDFF;">"color"</span>: <span style="color: #f78c6c;">2003199</span>,
        <span style="color: #89DDFF;">"fields"</span>: <span style="color: #89DDFF;">[</span><span style="color: #bb80b3;">{</span><span style="color: #89DDFF;">"name"</span>: <span style="color: #c3e88d;">"Blue Team"</span>, <span style="color: #89DDFF;">"value"</span>: <span style="color: #c3e88d;">"Something"</span>, <span style="color: #89DDFF;">"inline"</span> : <span style="color: #c3e88d;">"True"</span><span style="color: #bb80b3;">}</span><span style="color: #89DDFF;">]</span>
    <span style="color: #c3e88d;">}</span>
<span style="color: #f78c6c;">}</span>,
<span style="color: #89DDFF;">"gdoc"</span>: <span style="color: #f78c6c;">{</span>
    <span style="color: #89DDFF;">"url"</span>: <span style="color: #c3e88d;">"https://docs.google.com/spreadsheets/d/1FgtMvUQbLxP7qvXt2tnVwFFyX9KWnuREHu7o0RtX13M/"</span>,
    <span style="color: #89DDFF;">"strats"</span>: <span style="color: #c3e88d;">{</span>
        <span style="color: #89DDFF;">"Principale"</span>: <span style="color: #c3e88d;">"Strat_principale"</span>,
        <span style="color: #89DDFF;">"Secours"</span>: <span style="color: #c3e88d;">"Strat_secours"</span>
    <span style="color: #c3e88d;">}</span>,
    <span style="color: #89DDFF;">"page_roster"</span>: <span style="color: #c3e88d;">"Roster"</span>,
    <span style="color: #89DDFF;">"form"</span>: <span style="color: #c3e88d;">"https://forms.gle/G9LizybajjVxCw6JA"</span>
<span style="color: #f78c6c;">}</span>
<span style="color: #c792ea;">}</span>
</pre>
</div>
</div>
</div>



<div id="outline-container-org7b7fd66" class="outline-3">
<h3 id="org7b7fd66"><span class="section-number-3">2.3.</span> Utilitaires</h3>
<div class="outline-text-3" id="text-2-3">
</div>
<div id="outline-container-orgfe4483d" class="outline-4">
<h4 id="orgfe4483d"><span class="section-number-4">2.3.1.</span> Dépendances</h4>
<div class="outline-text-4" id="text-2-3-1">
<div class="org-src-container">
<pre class="src src-python">
<span style="color: #89DDFF;">import</span> pandas <span style="color: #89DDFF;">as</span> pd
<span style="color: #89DDFF;">from</span> algo <span style="color: #89DDFF;">import</span> build_comp

</pre>
</div>
</div>
</div>
<div id="outline-container-org03bca2c" class="outline-4">
<h4 id="org03bca2c"><span class="section-number-4">2.3.2.</span> Chargement de la config</h4>
<div class="outline-text-4" id="text-2-3-2">
<p>
Le chargement de cette config se fera pour l'instant une seule fois au
démarrage du bot.
</p>
<div class="org-src-container">
<pre class="src src-python" id="orgb4030f9"><span style="color: #556369;"># </span><span style="color: #556369;">Chargement de la config du bot</span>
<span style="color: #89DDFF;">import</span> json
<span style="color: #89DDFF;">with</span> <span style="color: #82aaff;">open</span><span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'config.json'</span>, <span style="color: #c3e88d;">'r'</span><span style="color: #c792ea;">)</span> <span style="color: #89DDFF;">as</span> datafile:
    <span style="color: #ffcb6b;">config</span> = json.load<span style="color: #c792ea;">(</span>datafile<span style="color: #c792ea;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #556369;"># </span><span style="color: #556369;">Chargement de la config du bot</span>
<span style="color: #89DDFF;">import</span> json
<span style="color: #89DDFF;">with</span> <span style="color: #82aaff;">open</span><span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'config.json'</span>, <span style="color: #c3e88d;">'r'</span><span style="color: #c792ea;">)</span> <span style="color: #89DDFF;">as</span> datafile:
    <span style="color: #ffcb6b;">config</span> = json.load<span style="color: #c792ea;">(</span>datafile<span style="color: #c792ea;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfd88f69" class="outline-4">
<h4 id="orgfd88f69"><span class="section-number-4">2.3.3.</span> Persistance</h4>
<div class="outline-text-4" id="text-2-3-3">
<p>
Le chargement des données
</p>
<div class="org-src-container">
<pre class="src src-python" id="orgd3bb1bb"><span style="color: #556369;"># </span><span style="color: #556369;">Chargement de la config du bot</span>
<span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">load_data</span><span style="color: #c792ea;">(</span>path=<span style="color: #c3e88d;">'data.json'</span><span style="color: #c792ea;">)</span>:
    <span style="color: #89DDFF;">with</span> <span style="color: #82aaff;">open</span><span style="color: #c792ea;">(</span>path, <span style="color: #c3e88d;">'r'</span><span style="color: #c792ea;">)</span> <span style="color: #89DDFF;">as</span> datafile:
        <span style="color: #89DDFF;">return</span> json.load<span style="color: #c792ea;">(</span>datafile<span style="color: #c792ea;">)</span>
<span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">save_data</span><span style="color: #c792ea;">(</span>data, path=<span style="color: #c3e88d;">'data.json'</span><span style="color: #c792ea;">)</span>:
    <span style="color: #89DDFF;">with</span> <span style="color: #82aaff;">open</span><span style="color: #c792ea;">(</span>path, <span style="color: #c3e88d;">'w'</span><span style="color: #c792ea;">)</span> <span style="color: #89DDFF;">as</span> datafile:
        json.dump<span style="color: #c792ea;">(</span>data, datafile, sort_keys=<span style="color: #f78c6c;">True</span>, indent=4<span style="color: #c792ea;">)</span>
<span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">add_participation</span><span style="color: #c792ea;">(</span>participants<span style="color: #c792ea;">)</span>:
    <span style="color: #556369;">#</span><span style="color: #556369;">print(participants)</span>
    <span style="color: #ffcb6b;">data</span> = load_data<span style="color: #c792ea;">()</span>
    <span style="color: #89DDFF;">for</span> p <span style="color: #89DDFF;">in</span> participants:
        <span style="color: #89DDFF;">if</span> p <span style="color: #89DDFF;">in</span> data:
            <span style="color: #ffcb6b;">data</span><span style="color: #c792ea;">[</span>p<span style="color: #c792ea;">]</span> +=1
        <span style="color: #89DDFF;">else</span>:
            <span style="color: #ffcb6b;">data</span><span style="color: #c792ea;">[</span>p<span style="color: #c792ea;">]</span> = 1
    <span style="color: #556369;">#</span><span style="color: #556369;">print(data)</span>
    save_data<span style="color: #c792ea;">(</span>data<span style="color: #c792ea;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf60f325" class="outline-4">
<h4 id="orgf60f325"><span class="section-number-4">2.3.4.</span> Chargement du token</h4>
<div class="outline-text-4" id="text-2-3-4">
<div class="org-src-container">
<pre class="src src-python" id="org37a327b"><span style="color: #556369;"># </span><span style="color: #556369;">Chargement du token</span>
<span style="color: #89DDFF;">with</span> <span style="color: #82aaff;">open</span><span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'bot.token'</span>, <span style="color: #c3e88d;">'r'</span><span style="color: #c792ea;">)</span> <span style="color: #89DDFF;">as</span> datafile:
    <span style="color: #ffcb6b;">token</span> = datafile.read<span style="color: #c792ea;">()</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orga5133c2" class="outline-4">
<h4 id="orga5133c2"><span class="section-number-4">2.3.5.</span> Identifiant</h4>
<div class="outline-text-4" id="text-2-3-5">
<p>
Il est nécessaire d'avoir un identifiant unique entre discord et le
gdoc pour faire le lien. Discord gère les identifiants sous forme d'un
entier appelé <i>snowflake</i>. Toutefois, il est difficilement accessible
pour les joueurs, et ce sont les joueurs qui vont devoir renseigner
leur identifiant unique sur le gdoc. Il est donc plus simple
d'utiliser ici le <b>discord tag</b>, par exemple `Virgile#1234`.
</p>

<p>
Je propose ici une rapide fonction d'aide pour récupérer le dtag
depuis un objet <i>discord.User</i> :
</p>
<div class="org-src-container">
<pre class="src src-python" id="org8d7efa4"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">dtag</span><span style="color: #c792ea;">(</span>user<span style="color: #c792ea;">)</span>:
    <span style="color: #89DDFF;">return</span> f<span style="color: #c3e88d;">'{user.name}#{user.discriminator}'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1d5af72" class="outline-4">
<h4 id="org1d5af72"><span class="section-number-4">2.3.6.</span> Récupération du roster</h4>
<div class="outline-text-4" id="text-2-3-6">
<div class="org-src-container">
<pre class="src src-python" id="orgda6e90a"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">get_roster</span><span style="color: #c792ea;">(</span>config<span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">url</span> = f<span style="color: #c3e88d;">"{config['gdoc']['url']}gviz/tq?tqx=out:csv&amp;sheet={config['gdoc']['page_roster']}"</span>
    <span style="color: #556369;">#</span><span style="color: #556369;">return pd.read_csv(url).iloc[1:, 0:6].dropna().set_index('dtag')</span>
    <span style="color: #89DDFF;">return</span> pd.read_csv<span style="color: #c792ea;">(</span>url<span style="color: #c792ea;">)</span>.set_index<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'dtag'</span><span style="color: #c792ea;">)</span>
</pre>
</div>

<pre class="example" id="orgd859460">
                Pseudo             0           1     2           3
dtag
Chopekk#1234   Chopekk    DPS-Debuff    Mousquet  Heal  Anti-trash
Virgile#2345  virgilio      Mousquet  Anti-trash  Répa        Arti
Virgile#3456     Tezig  Lance-flamme  Anti-trash   Arc        Arti
Carlito#4567      Slua    Anti-trash        Arti  Répa       Aucun
</pre>
</div>
</div>
<div id="outline-container-org46b8150" class="outline-4">
<h4 id="org46b8150"><span class="section-number-4">2.3.7.</span> Récupération de la strat</h4>
<div class="outline-text-4" id="text-2-3-7">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">get_strat</span><span style="color: #c792ea;">(</span>config, strat=<span style="color: #f78c6c;">None</span><span style="color: #c792ea;">)</span>:
    <span style="color: #89DDFF;">if</span> strat <span style="color: #89DDFF;">is</span> <span style="color: #f78c6c;">None</span>:
        <span style="color: #ffcb6b;">url</span> = f<span style="color: #c3e88d;">"{config['gdoc']['url']}gviz/tq?tqx=out:csv&amp;sheet={config['gdoc']['page_strat']}"</span>
    <span style="color: #89DDFF;">else</span>:
        <span style="color: #ffcb6b;">url</span> = f<span style="color: #c3e88d;">"{config['gdoc']['url']}gviz/tq?tqx=out:csv&amp;sheet={config['gdoc']['page_strat']}"</span>
    <span style="color: #89DDFF;">return</span> pd.read_csv<span style="color: #c792ea;">(</span>url<span style="color: #c792ea;">)</span>.iloc<span style="color: #c792ea;">[</span>0:5, 0:12<span style="color: #c792ea;">]</span>
</pre>
</div>

<pre class="example" id="orgc937084">
     Groupe 1 Groupe 2    Groupe 3 Groupe 4    Groupe 5    Groupe 6    Groupe 7    Groupe 8 Groupe 9     Groupe 10
0  Anti-Trash      Arc  Anti-Trash      Arc  Anti-Trash    Mousquet  Anti-Trash    Mousquet     Répa  Lance-flamme
1        Heal      Arc        Heal      Arc        Heal    Mousquet        Heal    Mousquet     Répa  Lance-flamme
2  DPS-Debuff      Arc  DPS-Debuff      Arc  DPS-Debuff    Mousquet  DPS-Debuff    Mousquet     Répa  Lance-flamme
3  DPS-Debuff      Arc  DPS-Debuff      Arc  DPS-Debuff  DPS-Debuff  DPS-Debuff  DPS-Debuff     Répa  Lance-flamme
4        Arti     Arti        Arti     Arti        Arti        Arti        Arti        Arti     Répa  Lance-flamme
</pre>
</div>
</div>
</div>
</div>



<div id="outline-container-orgeaf50fe" class="outline-2">
<h2 id="orgeaf50fe"><span class="section-number-2">3.</span> Algo</h2>
<div class="outline-text-2" id="text-3">
<p>
Dépendances
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">import</span> numpy <span style="color: #89DDFF;">as</span> np
<span style="color: #89DDFF;">import</span> pandas <span style="color: #89DDFF;">as</span> pd
<span style="color: #89DDFF;">from</span> scipy.optimize <span style="color: #89DDFF;">import</span> linear_sum_assignment
</pre>
</div>

<p>
Récupération du roster de test
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">get_test_roster</span><span style="color: #c792ea;">()</span>:
    <span style="color: #ffcb6b;">page</span>= <span style="color: #c3e88d;">'Roster'</span>
    <span style="color: #ffcb6b;">url</span> = f<span style="color: #c3e88d;">"https://docs.google.com/spreadsheets/d/1FgtMvUQbLxP7qvXt2tnVwFFyX9KWnuREHu7o0RtX13M/gviz/tq?tqx=out:csv&amp;sheet={page}"</span>
    <span style="color: #556369;">#</span><span style="color: #556369;">return pd.read_csv(url).iloc[:, 0:16].dropna().set_index('dtag')</span>
    <span style="color: #89DDFF;">return</span> pd.read_csv<span style="color: #c792ea;">(</span>url<span style="color: #c792ea;">)</span>.set_index<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'dtag'</span><span style="color: #c792ea;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">get_test_strat</span><span style="color: #c792ea;">()</span>:
  <span style="color: #ffcb6b;">page</span>= <span style="color: #c3e88d;">'Strat'</span>
  <span style="color: #ffcb6b;">url</span> = f<span style="color: #c3e88d;">"https://docs.google.com/spreadsheets/d/1vDZ_p6Bq2oyyY0CV1SQ0FBRtJoGbtiurM9cOQWHJ-qo/gviz/tq?tqx=out:csv&amp;sheet={page}"</span>
  <span style="color: #89DDFF;">return</span> pd.read_csv<span style="color: #c792ea;">(</span>url<span style="color: #c792ea;">)</span>.iloc<span style="color: #c792ea;">[</span>0:5, 0:12<span style="color: #c792ea;">]</span>
</pre>
</div>

<p>
Identification des Rôles :
</p>
<div class="org-src-container">
<pre class="src src-python">
<span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">build_comp</span><span style="color: #c792ea;">(</span>roster, strat, config<span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">roles</span> = <span style="color: #c792ea;">{}</span>
    <span style="color: #89DDFF;">for</span> index, row <span style="color: #89DDFF;">in</span> strat.iterrows<span style="color: #c792ea;">()</span>:
        <span style="color: #89DDFF;">for</span> v <span style="color: #89DDFF;">in</span> row:
            <span style="color: #ffcb6b;">v</span> = v.split<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">' '</span><span style="color: #c792ea;">)[</span>0<span style="color: #c792ea;">]</span>
            <span style="color: #89DDFF;">if</span> v <span style="color: #89DDFF;">in</span> roles:
                <span style="color: #ffcb6b;">roles</span><span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span> += 1
            <span style="color: #89DDFF;">else</span>:
                <span style="color: #ffcb6b;">roles</span><span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span> = 1

    <span style="color: #ffcb6b;">max_roles</span> = <span style="color: #c792ea;">{</span>k: v.<span style="color: #82aaff;">max</span><span style="color: #f78c6c;">()</span> <span style="color: #89DDFF;">for</span> k,v <span style="color: #89DDFF;">in</span> roster.iteritems<span style="color: #f78c6c;">()</span><span style="color: #c792ea;">}</span>

    <span style="color: #ffcb6b;">cols</span> = <span style="color: #c792ea;">[</span>k <span style="color: #89DDFF;">for</span> k, v <span style="color: #89DDFF;">in</span> roles.items<span style="color: #f78c6c;">()</span> <span style="color: #89DDFF;">for</span> _ <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">range</span><span style="color: #f78c6c;">(</span>v<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">]</span>
    <span style="color: #ffcb6b;">rows</span> = roster.index

    <span style="color: #ffcb6b;">C</span> = np.zeros<span style="color: #c792ea;">(</span><span style="color: #f78c6c;">(</span><span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>rows<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>cols<span style="color: #c3e88d;">)</span><span style="color: #f78c6c;">)</span>, dtype=<span style="color: #82aaff;">int</span><span style="color: #c792ea;">)</span>

    <span style="color: #89DDFF;">for</span> i, r <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">enumerate</span><span style="color: #c792ea;">(</span>rows<span style="color: #c792ea;">)</span>:
        <span style="color: #89DDFF;">for</span> j, c <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">enumerate</span><span style="color: #c792ea;">(</span>cols<span style="color: #c792ea;">)</span>:
            <span style="color: #ffcb6b;">C</span><span style="color: #c792ea;">[</span>i, j<span style="color: #c792ea;">]</span> = roster.at<span style="color: #c792ea;">[</span>r, c<span style="color: #c792ea;">]</span>

    <span style="color: #ffcb6b;">row_ind</span>, <span style="color: #ffcb6b;">X</span> = linear_sum_assignment<span style="color: #c792ea;">(</span>C, maximize=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">score</span> = C<span style="color: #c792ea;">[</span>row_ind, X<span style="color: #c792ea;">]</span>.<span style="color: #82aaff;">sum</span><span style="color: #c792ea;">()</span>
    <span style="color: #ffcb6b;">assignent</span> = <span style="color: #c792ea;">{</span>p: cols<span style="color: #f78c6c;">[</span>t<span style="color: #f78c6c;">]</span> <span style="color: #89DDFF;">for</span> p, t <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">zip</span><span style="color: #f78c6c;">(</span>rows, X<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">}</span>

    <span style="color: #ffcb6b;">filed_roles</span> = <span style="color: #c792ea;">{}</span>
    <span style="color: #89DDFF;">for</span> k, v <span style="color: #89DDFF;">in</span> assignent.items<span style="color: #c792ea;">()</span>:
        <span style="color: #556369;">#</span><span style="color: #556369;">print(k, v)</span>
        <span style="color: #89DDFF;">if</span> v <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> filed_roles:
            <span style="color: #ffcb6b;">filed_roles</span><span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span> = <span style="color: #c792ea;">[</span>k<span style="color: #c792ea;">]</span>
        <span style="color: #89DDFF;">else</span>:
            <span style="color: #ffcb6b;">filed_roles</span><span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span> += <span style="color: #c792ea;">[</span>k<span style="color: #c792ea;">]</span>

    <span style="color: #ffcb6b;">comp</span> = strat.copy<span style="color: #c792ea;">()</span>
    <span style="color: #89DDFF;">for</span> i, row <span style="color: #89DDFF;">in</span> comp.iterrows<span style="color: #c792ea;">()</span>:
        <span style="color: #89DDFF;">for</span> j, v <span style="color: #89DDFF;">in</span> row.items<span style="color: #c792ea;">()</span>:
            <span style="color: #ffcb6b;">label</span> = <span style="color: #c3e88d;">''</span>
            <span style="color: #89DDFF;">if</span> <span style="color: #82aaff;">len</span><span style="color: #c792ea;">(</span>v.split<span style="color: #f78c6c;">(</span><span style="color: #c3e88d;">' '</span><span style="color: #f78c6c;">)</span><span style="color: #c792ea;">)</span> &gt; 1:
                <span style="color: #ffcb6b;">v</span>, <span style="color: #ffcb6b;">label</span> = v.split<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">' '</span><span style="color: #c792ea;">)</span>
            <span style="color: #89DDFF;">if</span> v <span style="color: #89DDFF;">in</span> filed_roles <span style="color: #89DDFF;">and</span> filed_roles<span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span>:
                <span style="color: #ffcb6b;">p</span> = filed_roles<span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span>.pop<span style="color: #c792ea;">()</span>
                <span style="color: #ffcb6b;">role_txt</span> = f<span style="color: #c3e88d;">"[{comp.at[i, j]}]({config['doc']['url']})"</span>
                <span style="color: #556369;">#</span><span style="color: #556369;">if role_txt in config['doc']:</span>
                <span style="color: #556369;">#    </span><span style="color: #556369;">role_txt = f"[{role_txt}]({config['doc'][url]})"</span>
                <span style="color: #ffcb6b;">comp.at</span><span style="color: #c792ea;">[</span>i, j<span style="color: #c792ea;">]</span> = f<span style="color: #c3e88d;">'{p} *{role_txt}* {roster.at[p, v] / max_roles[v]:.1f}'</span>
    <span style="color: #89DDFF;">return</span> comp
</pre>
</div>

<p>
Création des colonnes avec les noms de rôles, les lignes avec les noms
de joueurs, et de la matrice de coûts.
</p>
<div class="org-src-container">
<pre class="src src-python" id="orga9e1968">
<span style="color: #ffcb6b;">cols</span> = <span style="color: #c792ea;">[</span>k <span style="color: #89DDFF;">for</span> k, v <span style="color: #89DDFF;">in</span> roles.items<span style="color: #f78c6c;">()</span> <span style="color: #89DDFF;">for</span> _ <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">range</span><span style="color: #f78c6c;">(</span>v<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">]</span>
<span style="color: #ffcb6b;">rows</span> = roster.index

<span style="color: #ffcb6b;">C</span> = np.zeros<span style="color: #c792ea;">(</span><span style="color: #f78c6c;">(</span><span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>rows<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>cols<span style="color: #c3e88d;">)</span><span style="color: #f78c6c;">)</span>, dtype=<span style="color: #82aaff;">int</span><span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">for</span> i, r <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">enumerate</span><span style="color: #c792ea;">(</span>rows<span style="color: #c792ea;">)</span>:
    <span style="color: #89DDFF;">for</span> j, c <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">enumerate</span><span style="color: #c792ea;">(</span>cols<span style="color: #c792ea;">)</span>:
        <span style="color: #ffcb6b;">C</span><span style="color: #c792ea;">[</span>i, j<span style="color: #c792ea;">]</span> = roster.at<span style="color: #c792ea;">[</span>r, c<span style="color: #c792ea;">]</span>
</pre>
</div>


<p>
Résolution du problème d'affectation avec la maximisation suivante :
\[max \sum_{i} \sum_{j} C_{i,j} X_{i,j}\]
</p>
<div class="org-src-container">
<pre class="src src-python" id="org1d75fbc">
<span style="color: #ffcb6b;">row_ind</span>, <span style="color: #ffcb6b;">X</span> = linear_sum_assignment<span style="color: #c792ea;">(</span>C, maximize=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>
<span style="color: #ffcb6b;">score</span> = C<span style="color: #c792ea;">[</span>row_ind, X<span style="color: #c792ea;">]</span>.<span style="color: #82aaff;">sum</span><span style="color: #c792ea;">()</span>
<span style="color: #ffcb6b;">assignent</span> = <span style="color: #c792ea;">{</span>p: cols<span style="color: #f78c6c;">[</span>t<span style="color: #f78c6c;">]</span> <span style="color: #89DDFF;">for</span> p, t <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">zip</span><span style="color: #f78c6c;">(</span>rows, X<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">}</span>

</pre>
</div>

<p>
Analyse des résultats
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">for</span> k, v <span style="color: #89DDFF;">in</span> assignent.items<span style="color: #c792ea;">()</span>:
    <span style="color: #89DDFF;">print</span><span style="color: #c792ea;">(</span>k, v, roster.at<span style="color: #f78c6c;">[</span>k, v<span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>

</pre>
</div>

<p>
Remplissage du tableau
</p>
<div class="org-src-container">
<pre class="src src-python" id="org6a65046"><span style="color: #ffcb6b;">filed_roles</span> = <span style="color: #c792ea;">{}</span>
<span style="color: #89DDFF;">for</span> k, v <span style="color: #89DDFF;">in</span> assignent.items<span style="color: #c792ea;">()</span>:
    <span style="color: #556369;">#</span><span style="color: #556369;">print(k, v)</span>
    <span style="color: #89DDFF;">if</span> v <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> filed_roles:
        <span style="color: #ffcb6b;">filed_roles</span><span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span> = <span style="color: #c792ea;">[</span>k<span style="color: #c792ea;">]</span>
    <span style="color: #89DDFF;">else</span>:
        <span style="color: #ffcb6b;">filed_roles</span><span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span> += <span style="color: #c792ea;">[</span>k<span style="color: #c792ea;">]</span>

<span style="color: #ffcb6b;">comp</span> = strat.copy<span style="color: #c792ea;">()</span>
<span style="color: #89DDFF;">for</span> i, row <span style="color: #89DDFF;">in</span> comp.iterrows<span style="color: #c792ea;">()</span>:
    <span style="color: #89DDFF;">for</span> j, v <span style="color: #89DDFF;">in</span> row.items<span style="color: #c792ea;">()</span>:
        <span style="color: #ffcb6b;">label</span> = <span style="color: #c3e88d;">''</span>
        <span style="color: #89DDFF;">if</span> <span style="color: #82aaff;">len</span><span style="color: #c792ea;">(</span>v.split<span style="color: #f78c6c;">(</span><span style="color: #c3e88d;">' '</span><span style="color: #f78c6c;">)</span><span style="color: #c792ea;">)</span> &gt; 1:
            <span style="color: #ffcb6b;">v</span>, <span style="color: #ffcb6b;">label</span> = v.split<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">' '</span><span style="color: #c792ea;">)</span>
        <span style="color: #89DDFF;">if</span> v <span style="color: #89DDFF;">in</span> filed_roles <span style="color: #89DDFF;">and</span> filed_roles<span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span>:
            <span style="color: #ffcb6b;">p</span> = filed_roles<span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span>.pop<span style="color: #c792ea;">()</span>
            <span style="color: #ffcb6b;">role_txt</span> = f<span style="color: #c3e88d;">"[{comp.at[i, j]}]({config['doc']['url']})"</span>
            <span style="color: #556369;">#</span><span style="color: #556369;">if role_txt in config['doc']:</span>
            <span style="color: #556369;">#    </span><span style="color: #556369;">role_txt = f"[{role_txt}]({config['doc'][url]})"</span>
            <span style="color: #ffcb6b;">comp.at</span><span style="color: #c792ea;">[</span>i, j<span style="color: #c792ea;">]</span> = f<span style="color: #c3e88d;">'{p} *{role_txt}* {roster.at[p, v] / max_roles[v]:.1f}'</span>
<span style="color: #89DDFF;">return</span> comp
</pre>
</div>
</div>

<div id="outline-container-org0e393bb" class="outline-3">
<h3 id="org0e393bb"><span class="section-number-3">3.1.</span> Test algo</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">
<pre class="src src-python">
<span style="color: #89DDFF;">if</span> <span style="color: #82aaff;">__name__</span> == <span style="color: #c3e88d;">'__main__'</span>:
    <span style="color: #ffcb6b;">roster</span> = get_test_roster<span style="color: #c792ea;">()</span>.set_index<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'Pseudo IG'</span><span style="color: #c792ea;">)</span>
    roster.to_csv<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'roster.csv'</span><span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">print</span><span style="color: #c792ea;">(</span>roster<span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">strat</span> = get_test_strat<span style="color: #c792ea;">()</span>
    strat.to_csv<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'strat.csv'</span><span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">print</span><span style="color: #c792ea;">(</span>strat<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">print</span><span style="color: #c792ea;">(</span>build_comp<span style="color: #f78c6c;">(</span>roster, strat<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">)</span>
</pre>
</div>
</div>
<ol class="org-ol">
<li><a id="org709af9c"></a>Filtrage des joueurs<br />
<div class="outline-text-5" id="text-3-1-0-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #ffcb6b;">keys_to_extract</span> = <span style="color: #c792ea;">[]</span>
<span style="color: #ffcb6b;">a_subset</span> = <span style="color: #c792ea;">{</span>key: players<span style="color: #f78c6c;">[</span>key<span style="color: #f78c6c;">]</span> <span style="color: #89DDFF;">for</span> key <span style="color: #89DDFF;">in</span> keys_to_extract<span style="color: #c792ea;">}</span>
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>


<div id="outline-container-orgb6ac720" class="outline-2">
<h2 id="orgb6ac720"><span class="section-number-2">4.</span> <span class="todo TODO">TODO</span> bot avec Disnake</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orgeccd582" class="outline-3">
<h3 id="orgeccd582"><span class="section-number-3">4.1.</span> Corp</h3>
<div class="outline-text-3" id="text-4-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">import</span> pandas <span style="color: #89DDFF;">as</span> pd
<span style="color: #89DDFF;">from</span> algo <span style="color: #89DDFF;">import</span> build_comp

<span style="color: #89DDFF;">import</span> disnake
<span style="color: #89DDFF;">from</span> disnake.ext <span style="color: #89DDFF;">import</span> commands
<span style="color: #89DDFF;">from</span> disnake <span style="color: #89DDFF;">import</span> Embed, Emoji


&lt;&lt;dtag&gt;&gt;
&lt;&lt;get_roster&gt;&gt;
&lt;&lt;config&gt;&gt;
<span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">list_to_field</span><span style="color: #c792ea;">(</span>l<span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">f</span> = <span style="color: #c3e88d;">'aucun'</span>
    <span style="color: #89DDFF;">if</span> l:
        <span style="color: #ffcb6b;">f</span> = <span style="color: #c3e88d;">''</span>
        <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> l:
            <span style="color: #ffcb6b;">f</span> += u + <span style="color: #c3e88d;">'\n'</span>
        <span style="color: #89DDFF;">if</span> <span style="color: #82aaff;">len</span><span style="color: #c792ea;">(</span>f<span style="color: #c792ea;">)</span>&gt;1023:
            <span style="color: #89DDFF;">return</span> f<span style="color: #c792ea;">[</span>:1000<span style="color: #c792ea;">]</span>+<span style="color: #c3e88d;">'...'</span>
        <span style="color: #89DDFF;">return</span> f

<span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">unique</span><span style="color: #c792ea;">(</span>l<span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">u</span> = <span style="color: #c792ea;">[]</span>
    <span style="color: #89DDFF;">for</span> r <span style="color: #89DDFF;">in</span> l:
        <span style="color: #89DDFF;">if</span> r <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> u:
            <span style="color: #ffcb6b;">u</span> +=<span style="color: #c792ea;">[</span>r<span style="color: #c792ea;">]</span>
    <span style="color: #89DDFF;">return</span> u

<span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span>:
    <span style="color: #ffcb6b;">bot</span> = commands.Bot<span style="color: #c792ea;">(</span>
        intents=disnake.Intents<span style="color: #f78c6c;">()</span>.<span style="color: #82aaff;">all</span><span style="color: #f78c6c;">()</span>,
        test_guilds=<span style="color: #f78c6c;">[</span>906630964703289434<span style="color: #f78c6c;">]</span>, <span style="color: #556369;"># </span><span style="color: #556369;">Optional</span>
        sync_commands_debug=<span style="color: #f78c6c;">True</span>
    <span style="color: #c792ea;">)</span>
    &lt;&lt;data&gt;&gt;
    &lt;&lt;dis_transfert&gt;&gt;
    &lt;&lt;dis_inva_cmd&gt;&gt;
    &lt;&lt;dis_instance&gt;&gt;
    &lt;&lt;dis_verif&gt;&gt;
    &lt;&lt;check_user&gt;&gt;
    &lt;&lt;update_instance_add&gt;&gt;
    &lt;&lt;update_instance_rm&gt;&gt;
    &lt;&lt;on_reaction&gt;&gt;
    &lt;&lt;on_reaction_rm&gt;&gt;
    bot.run<span style="color: #c792ea;">(</span>token=<span style="color: #82aaff;">open</span><span style="color: #f78c6c;">(</span><span style="color: #c3e88d;">"bot.token"</span><span style="color: #f78c6c;">)</span>.read<span style="color: #f78c6c;">()[</span>:-1<span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">if</span> <span style="color: #82aaff;">__name__</span> == <span style="color: #c3e88d;">"__main__"</span>:
    main<span style="color: #c792ea;">()</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org2160a08" class="outline-3">
<h3 id="org2160a08"><span class="section-number-3">4.2.</span> Commande inva</h3>
<div class="outline-text-3" id="text-4-2">
<div class="org-src-container">
<pre class="src src-python" id="org220a8df"><span style="color: #ffcb6b;">villes</span> = <span style="color: #c792ea;">[</span><span style="color: #c3e88d;">"Bief de N&#233;r&#233;caille"</span>, <span style="color: #c3e88d;">"Boisclair"</span>, <span style="color: #c3e88d;">"Eaux F&#233;tides"</span>, <span style="color: #c3e88d;">"Gr&#233; du vent"</span>,
          <span style="color: #c3e88d;">"Ile des Lames"</span>, <span style="color: #c3e88d;">"Levant"</span>, <span style="color: #c3e88d;">"Haute-Chute"</span>, <span style="color: #c3e88d;">"Marais des Trames"</span>,
          <span style="color: #c3e88d;">"Rive tourment&#233;e"</span>, <span style="color: #c3e88d;">"Val des Larmes"</span>, <span style="color: #c3e88d;">"Falaise du roy"</span><span style="color: #c792ea;">]</span>

<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">autocomp_villes</span><span style="color: #c792ea;">(</span>inter: disnake.ApplicationCommandInteraction, user_input: <span style="color: #82aaff;">str</span><span style="color: #c792ea;">)</span>:
    <span style="color: #89DDFF;">return</span> <span style="color: #c792ea;">[</span>ville <span style="color: #89DDFF;">for</span> ville <span style="color: #89DDFF;">in</span> villes <span style="color: #89DDFF;">if</span> ville.lower<span style="color: #f78c6c;">()</span>.startswith<span style="color: #f78c6c;">(</span>user_input.lower<span style="color: #c3e88d;">()</span><span style="color: #f78c6c;">)</span><span style="color: #c792ea;">]</span>

<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">tags_from_id</span><span style="color: #c792ea;">(</span>ctx, msg_id<span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">msg</span> = <span style="color: #89DDFF;">await</span> ctx.channel.fetch_message<span style="color: #c792ea;">(</span>msg_id<span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">selected</span> = <span style="color: #89DDFF;">await</span> msg.reactions<span style="color: #c792ea;">[</span>0<span style="color: #c792ea;">]</span>.users<span style="color: #c792ea;">()</span>.flatten<span style="color: #c792ea;">()</span>
    <span style="color: #89DDFF;">return</span> <span style="color: #c792ea;">[</span>dtag<span style="color: #f78c6c;">(</span>u<span style="color: #f78c6c;">)</span> <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> selected<span style="color: #c792ea;">][</span>1:<span style="color: #c792ea;">]</span>

<span style="color: #89DDFF;">class</span> <span style="color: #c792ea;">CompTrigger</span><span style="color: #c792ea;">(</span>disnake.ui.View<span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">options</span> = <span style="color: #c792ea;">[</span>disnake.SelectOption<span style="color: #f78c6c;">(</span>label=k, value=v<span style="color: #f78c6c;">)</span> <span style="color: #89DDFF;">for</span> k, v <span style="color: #89DDFF;">in</span> config<span style="color: #f78c6c;">[</span><span style="color: #c3e88d;">'gdoc'</span><span style="color: #f78c6c;">][</span><span style="color: #c3e88d;">'strats'</span><span style="color: #f78c6c;">]</span>.items<span style="color: #f78c6c;">()</span><span style="color: #c792ea;">]</span>
    options<span style="color: #c792ea;">[</span>0<span style="color: #c792ea;">]</span><span style="color: #ffcb6b;">.default</span> = <span style="color: #f78c6c;">True</span>
    <span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">__init__</span><span style="color: #c792ea;">(</span><span style="color: #89DDFF;">self</span>, origin, **kwargs<span style="color: #c792ea;">)</span>:
        <span style="color: #82aaff;">super</span><span style="color: #c792ea;">()</span>.__init__<span style="color: #c792ea;">(</span>**kwargs<span style="color: #c792ea;">)</span>
        <span style="color: #89DDFF;">self</span>.origin = origin
        <span style="color: #89DDFF;">self</span>.strat = config<span style="color: #c792ea;">[</span><span style="color: #c3e88d;">'gdoc'</span><span style="color: #c792ea;">][</span><span style="color: #c3e88d;">'strats'</span><span style="color: #c792ea;">][</span><span style="color: #c3e88d;">'Principale'</span><span style="color: #c792ea;">]</span>

    <span style="color: #c792ea;">@disnake.ui.select</span><span style="color: #c792ea;">(</span>options=options<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">compo</span><span style="color: #c792ea;">(</span><span style="color: #89DDFF;">self</span>, select: disnake.ui.Select, inter: disnake.MessageInteraction<span style="color: #c792ea;">)</span>:
        <span style="color: #89DDFF;">self</span>.strat=select.values<span style="color: #c792ea;">[</span>0<span style="color: #c792ea;">]</span>
        <span style="color: #89DDFF;">await</span> inter.response.defer<span style="color: #c792ea;">()</span>

    <span style="color: #c792ea;">@disnake.ui.button</span><span style="color: #c792ea;">(</span>label=<span style="color: #c3e88d;">'CB'</span>, style=disnake.ButtonStyle.secondary<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">cb</span><span style="color: #c792ea;">(</span><span style="color: #89DDFF;">self</span>, button: disnake.ui.Button, inter: disnake.MessageInteraction<span style="color: #c792ea;">)</span>:
        <span style="color: #556369;">#</span><span style="color: #556369;">msg = await inter.original_message()</span>
        <span style="color: #556369;">#</span><span style="color: #556369;">print(inter.message.id, inter.response.is_done(), msg)</span>
        <span style="color: #ffcb6b;">selected</span> = <span style="color: #89DDFF;">await</span> tags_from_id<span style="color: #c792ea;">(</span>inter, <span style="color: #89DDFF;">self</span>.origin<span style="color: #c792ea;">)</span>
        <span style="color: #89DDFF;">print</span><span style="color: #c792ea;">(</span>inter.response.is_done<span style="color: #f78c6c;">()</span><span style="color: #c792ea;">)</span>
        <span style="color: #556369;">#</span><span style="color: #556369;">await interaction.edit_original_message(content=f'{len(selected)} Joueurs enregistr&#233;s')</span>
        <span style="color: #89DDFF;">if</span> <span style="color: #89DDFF;">not</span> inter.response.is_done<span style="color: #c792ea;">()</span>:
            <span style="color: #89DDFF;">await</span> inter.response.send_message<span style="color: #c792ea;">(</span>content=f<span style="color: #c3e88d;">'{len(selected)} Joueurs enregistr&#233;s'</span><span style="color: #c792ea;">)</span>
            <span style="color: #89DDFF;">print</span><span style="color: #c792ea;">(</span>inter.response.is_done<span style="color: #f78c6c;">()</span><span style="color: #c792ea;">)</span>
        <span style="color: #89DDFF;">else</span>:
            <span style="color: #89DDFF;">await</span> inter.edit_original_message<span style="color: #c792ea;">(</span>content=f<span style="color: #c3e88d;">'{len(selected)} Joueurs enregistr&#233;s'</span><span style="color: #c792ea;">)</span>

    <span style="color: #c792ea;">@disnake.ui.button</span><span style="color: #c792ea;">(</span>label=<span style="color: #c3e88d;">'Composition'</span>, style=disnake.ButtonStyle.blurple<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">trigger</span><span style="color: #c792ea;">(</span><span style="color: #89DDFF;">self</span>, button: disnake.ui.Button, inter: disnake.MessageInteraction<span style="color: #c792ea;">)</span>:
        <span style="color: #556369;">#</span><span style="color: #556369;">await interaction.delete_original_message()</span>
        <span style="color: #89DDFF;">await</span> inter.response.defer<span style="color: #c792ea;">()</span>
        <span style="color: #89DDFF;">self</span>.stop<span style="color: #c792ea;">()</span>


<span style="color: #c792ea;">@bot.slash_command</span><span style="color: #c792ea;">(</span>
    scope=906630964703289434,
<span style="color: #c792ea;">)</span>
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">invasion</span><span style="color: #c792ea;">(</span>
        ctx: disnake.ApplicationCommandInteraction,
        ville: <span style="color: #82aaff;">str</span>=commands.Param<span style="color: #f78c6c;">(</span>autocomplete=autocomp_villes<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">)</span>:
    <span style="color: #556369;">""" G&#233;n&#233;re un tableau d'inscription dans le channel actuel</span>

<span style="color: #556369;">        Parameters</span>
<span style="color: #556369;">        ----------</span>
<span style="color: #556369;">        ville: La ville o&#249; se d&#233;roule l'invasion</span>
<span style="color: #556369;">    """</span>

    <span style="color: #ffcb6b;">embed</span> = Embed<span style="color: #c792ea;">(</span>
        title=f<span style="color: #c3e88d;">'Invasion de {ville}'</span>,
        color=2003199,
        description=<span style="color: #c3e88d;">"R&#233;agis avec :ballot_box_with_check: &#224; ce message **uniquement si tu es d&#233;j&#224; dans le fort**. Attention, retourne vite en jeu, l'auto-AFK kick est rapide (2min). \n\n Si tu as r&#233;agi par erreur, merci de d&#233;cocher ta r&#233;action. :wink:"</span>,
    <span style="color: #c792ea;">)</span>
    embed.set_footer<span style="color: #c792ea;">(</span>text=<span style="color: #c3e88d;">'Invasion'</span><span style="color: #c792ea;">)</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">Envoi du message et ajout de la r&#233;action</span>
    <span style="color: #89DDFF;">await</span> ctx.send<span style="color: #c792ea;">(</span>embed=embed<span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">msg</span> = <span style="color: #89DDFF;">await</span> ctx.original_message<span style="color: #c792ea;">()</span>
    <span style="color: #89DDFF;">await</span> msg.add_reaction<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'&#9745;'</span><span style="color: #c792ea;">)</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">Envoi d'un message cach&#233; &#224; l'invocateur</span>
    <span style="color: #ffcb6b;">trigger</span> = CompTrigger<span style="color: #c792ea;">(</span>msg.<span style="color: #82aaff;">id</span>, timeout=10*60<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">await</span> ctx.send<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">"Calcul"</span>, view=trigger, ephemeral=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">Attente du d&#233;clanchement pas l'invocateur</span>
    <span style="color: #89DDFF;">await</span> trigger.wait<span style="color: #c792ea;">()</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">R&#233;cup&#233;ration du message originel complet</span>
    <span style="color: #ffcb6b;">msg</span> = <span style="color: #89DDFF;">await</span> ctx.channel.fetch_message<span style="color: #c792ea;">(</span>msg.<span style="color: #82aaff;">id</span><span style="color: #c792ea;">)</span>

    <span style="color: #ffcb6b;">selected</span> = <span style="color: #89DDFF;">await</span> msg.reactions<span style="color: #c792ea;">[</span>0<span style="color: #c792ea;">]</span>.users<span style="color: #c792ea;">()</span>.flatten<span style="color: #c792ea;">()</span>

    <span style="color: #ffcb6b;">selected_tags</span> = <span style="color: #c792ea;">[</span>dtag<span style="color: #f78c6c;">(</span>u<span style="color: #f78c6c;">)</span> <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> selected <span style="color: #89DDFF;">if</span> dtag<span style="color: #f78c6c;">(</span>u<span style="color: #f78c6c;">)</span> != <span style="color: #c3e88d;">'Invasion#5489'</span><span style="color: #c792ea;">]</span>
    <span style="color: #556369;">#</span><span style="color: #556369;">selected_tags = [dtag(u) for u in selected][1:]</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">R&#233;cup&#233;ration des don&#233;nes du Gdoc roster</span>
    <span style="color: #ffcb6b;">roster</span> = get_roster<span style="color: #c792ea;">(</span>config<span style="color: #c792ea;">)</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">Joueurs s&#233;l&#233;ctionn&#233;s n'ayant pas rempli le Gdoc</span>
    <span style="color: #ffcb6b;">not_registered</span> = <span style="color: #c792ea;">[</span>u <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> selected_tags <span style="color: #89DDFF;">if</span> u <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> roster.index<span style="color: #c792ea;">]</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">Filtrage du roster avec les joueurs s&#233;l&#233;ctionn&#233;s</span>
    <span style="color: #ffcb6b;">roster</span> = roster.<span style="color: #82aaff;">filter</span><span style="color: #c792ea;">(</span>items=selected_tags, axis=0<span style="color: #c792ea;">)</span>.set_index<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'Pseudo IG'</span><span style="color: #c792ea;">)</span>

    add_participation<span style="color: #c792ea;">(</span>roster.index<span style="color: #c792ea;">)</span>

    <span style="color: #ffcb6b;">strat</span>=trigger.strat

    <span style="color: #556369;"># </span><span style="color: #556369;">R&#233;cup&#233;ration de la strat</span>
    <span style="color: #ffcb6b;">url</span> = f<span style="color: #c3e88d;">"{config['gdoc']['url']}gviz/tq?tqx=out:csv&amp;sheet={strat}"</span>

    <span style="color: #ffcb6b;">page</span> = pd.read_csv<span style="color: #c792ea;">(</span>url<span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">strat_df</span> = page.iloc<span style="color: #c792ea;">[</span>0:5, 0:10<span style="color: #c792ea;">]</span>
    <span style="color: #ffcb6b;">img_url</span> = page.iat<span style="color: #c792ea;">[</span>5, 1<span style="color: #c792ea;">]</span>

    <span style="color: #ffcb6b;">comp</span> = build_comp<span style="color: #c792ea;">(</span>roster, strat_df, config<span style="color: #c792ea;">)</span>

    <span style="color: #ffcb6b;">embed</span> = gen_embed<span style="color: #c792ea;">(</span>comp<span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">embed.title</span> = f<span style="color: #c3e88d;">"Invasion de {ville}, {strat} :"</span>
    <span style="color: #556369;">#</span><span style="color: #556369;">embed.set_footer(text=ctx.author.name, icon_url = ctx.author.avatar_url)</span>
    <span style="color: #ffcb6b;">embed.color</span> = 2003199
    embed.set_thumbnail<span style="color: #c792ea;">(</span>url=img_url<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">await</span> ctx.send<span style="color: #c792ea;">(</span>embed=embed, delete_after=60*25<span style="color: #c792ea;">)</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-orgd80f999" class="outline-3">
<h3 id="orgd80f999"><span class="section-number-3">4.3.</span> Commande verif</h3>
<div class="outline-text-3" id="text-4-3">
<div class="org-src-container">
<pre class="src src-python" id="org48b8237"><span style="color: #c792ea;">@bot.slash_command</span><span style="color: #c792ea;">(</span>
    description=<span style="color: #c3e88d;">"V&#233;rification du Gdoc et mise &#224; jour des r&#244;les"</span>,
    scope=906630964703289434,
<span style="color: #c792ea;">)</span>
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">verif</span><span style="color: #c792ea;">(</span>ctx<span style="color: #c792ea;">)</span>:
    <span style="color: #556369;">""" Attribue les r&#244;les</span>
<span style="color: #556369;">    """</span>

    <span style="color: #ffcb6b;">guild</span> = ctx.guild
    <span style="color: #ffcb6b;">lead_role</span> = guild.get_role<span style="color: #c792ea;">(</span>config<span style="color: #f78c6c;">[</span><span style="color: #c3e88d;">"ids"</span><span style="color: #f78c6c;">][</span><span style="color: #c3e88d;">"leads"</span><span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">R&#233;cup&#233;ration des don&#233;nes du Gdoc roster</span>
    <span style="color: #ffcb6b;">roster_df</span> = get_roster<span style="color: #c792ea;">(</span>config<span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">roster</span> = <span style="color: #82aaff;">list</span><span style="color: #c792ea;">(</span>roster_df.index<span style="color: #c792ea;">)</span>

    <span style="color: #ffcb6b;">members</span> = <span style="color: #c792ea;">{</span>dtag<span style="color: #f78c6c;">(</span>m<span style="color: #f78c6c;">)</span>: m <span style="color: #89DDFF;">for</span> m <span style="color: #89DDFF;">in</span> guild.members<span style="color: #c792ea;">}</span>

    <span style="color: #ffcb6b;">role</span> = guild.get_role<span style="color: #c792ea;">(</span>config<span style="color: #f78c6c;">[</span><span style="color: #c3e88d;">"ids"</span><span style="color: #f78c6c;">][</span><span style="color: #c3e88d;">"role"</span><span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">verified</span> = <span style="color: #c792ea;">[</span>dtag<span style="color: #f78c6c;">(</span>m<span style="color: #f78c6c;">)</span> <span style="color: #89DDFF;">for</span> m <span style="color: #89DDFF;">in</span> role.members<span style="color: #c792ea;">]</span>

    <span style="color: #ffcb6b;">added</span> = <span style="color: #c792ea;">[]</span>
    <span style="color: #ffcb6b;">wrong</span> = <span style="color: #c792ea;">[]</span>
    <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> roster:
       <span style="color: #89DDFF;">if</span> u <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> members:
           <span style="color: #ffcb6b;">wrong</span> += <span style="color: #c792ea;">[</span>u<span style="color: #c792ea;">]</span>
       <span style="color: #89DDFF;">elif</span> u <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> verified:
           <span style="color: #89DDFF;">if</span> role <span style="color: #89DDFF;">is</span> <span style="color: #f78c6c;">None</span>:
               <span style="color: #556369;"># </span><span style="color: #556369;">Make sure the role still exists and is valid.</span>
               <span style="color: #89DDFF;">return</span>

           <span style="color: #89DDFF;">try</span>:
               <span style="color: #556369;"># </span><span style="color: #556369;">Finally, add the role.</span>
               <span style="color: #89DDFF;">await</span> members<span style="color: #c792ea;">[</span>u<span style="color: #c792ea;">]</span>.add_roles<span style="color: #c792ea;">(</span>role<span style="color: #c792ea;">)</span>
               <span style="color: #ffcb6b;">added</span> += <span style="color: #c792ea;">[</span>u<span style="color: #c792ea;">]</span>
           <span style="color: #89DDFF;">except</span> discord.HTTPException:
               <span style="color: #556369;"># </span><span style="color: #556369;">If we want to do something in case of errors we'd do it here.</span>
               <span style="color: #89DDFF;">pass</span>

    <span style="color: #ffcb6b;">removed</span> = <span style="color: #c792ea;">[]</span>
    <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> verified:
        <span style="color: #89DDFF;">if</span> u <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> roster:
            <span style="color: #89DDFF;">try</span>:
                <span style="color: #556369;"># </span><span style="color: #556369;">Finally, remove the role.</span>
                <span style="color: #89DDFF;">await</span> members<span style="color: #c792ea;">[</span>u<span style="color: #c792ea;">]</span>.remove_roles<span style="color: #c792ea;">(</span>role<span style="color: #c792ea;">)</span>
                <span style="color: #ffcb6b;">removed</span> += <span style="color: #c792ea;">[</span>u<span style="color: #c792ea;">]</span>

                <span style="color: #556369;"># </span><span style="color: #556369;">Send DM to user</span>
                <span style="color: #ffcb6b;">embed</span> = Embed.from_dict<span style="color: #c792ea;">(</span>config<span style="color: #f78c6c;">[</span><span style="color: #c3e88d;">"embeds"</span><span style="color: #f78c6c;">][</span><span style="color: #c3e88d;">"change"</span><span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>
                <span style="color: #ffcb6b;">embed.description</span> += f<span style="color: #c3e88d;">'{config["gdoc"]["form"]}) ***!***'</span>
                <span style="color: #89DDFF;">await</span> members<span style="color: #c792ea;">[</span>u<span style="color: #c792ea;">]</span>.send<span style="color: #c792ea;">(</span>embed=embed<span style="color: #c792ea;">)</span>
            <span style="color: #89DDFF;">except</span> discord.HTTPException:
                <span style="color: #556369;"># </span><span style="color: #556369;">If we want to do something in case of errors we'd do it here.</span>
                <span style="color: #89DDFF;">pass</span>

    <span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">add_IG</span><span style="color: #c792ea;">(</span>l, roster_df<span style="color: #c792ea;">)</span>:
        <span style="color: #89DDFF;">return</span> <span style="color: #c792ea;">[</span>f<span style="color: #c3e88d;">"{i} | {roster_df.loc[i]['Pseudo IG']}"</span> <span style="color: #89DDFF;">for</span> i <span style="color: #89DDFF;">in</span> l<span style="color: #c792ea;">]</span>
    <span style="color: #ffcb6b;">wrong</span> = add_IG<span style="color: #c792ea;">(</span>wrong, roster_df<span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">added</span> = add_IG<span style="color: #c792ea;">(</span>added, roster_df<span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">embed</span> = Embed<span style="color: #c792ea;">()</span>
    <span style="color: #ffcb6b;">embed.title</span> = f<span style="color: #c3e88d;">'V&#233;rification du gdoc'</span>
    <span style="color: #ffcb6b;">embed.color</span> = 2003199
    <span style="color: #556369;">#</span><span style="color: #556369;">embed.set_footer(text=ctx.author.name, icon_url = ctx.author.avatar_url)</span>

    embed.add_field<span style="color: #c792ea;">(</span>name=<span style="color: #c3e88d;">"Joueurs nouvellement v&#233;rifi&#233;s"</span>, value=list_to_field<span style="color: #f78c6c;">(</span>added<span style="color: #f78c6c;">)</span>, inline=<span style="color: #f78c6c;">False</span><span style="color: #c792ea;">)</span>
    embed.add_field<span style="color: #c792ea;">(</span>name=<span style="color: #c3e88d;">"Discord tag dans le Gdoc ne correspondant &#224; aucun membre du discord"</span>, value=list_to_field<span style="color: #f78c6c;">(</span>wrong<span style="color: #f78c6c;">)</span>, inline=<span style="color: #f78c6c;">False</span><span style="color: #c792ea;">)</span>
    embed.add_field<span style="color: #c792ea;">(</span>name=f<span style="color: #c3e88d;">"Joueurs ayant chang&#233; de Discord tag (r&#244;le {role} supprim&#233;)"</span>, value=list_to_field<span style="color: #f78c6c;">(</span>removed<span style="color: #f78c6c;">)</span>, inline=<span style="color: #f78c6c;">False</span><span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">await</span> ctx.channel.send<span style="color: #c792ea;">(</span>embed=embed, delete_after=20*60<span style="color: #c792ea;">)</span>
    <span style="color: #556369;">#</span><span style="color: #556369;">print(added, wrong)</span>


</pre>
</div>
</div>
</div>
<div id="outline-container-orgecd4efa" class="outline-3">
<h3 id="orgecd4efa"><span class="section-number-3">4.4.</span> Commande transfert</h3>
<div class="outline-text-3" id="text-4-4">
<div class="org-src-container">
<pre class="src src-python" id="orgf291ee3">
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">autocomp_sources</span><span style="color: #c792ea;">(</span>ctx: disnake.ApplicationCommandInteraction, user_input: <span style="color: #82aaff;">str</span><span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">voices</span> = <span style="color: #c792ea;">[</span>v <span style="color: #89DDFF;">for</span> v <span style="color: #89DDFF;">in</span> ctx.guild.voice_channels <span style="color: #89DDFF;">if</span> v.members<span style="color: #c792ea;">]</span>
    <span style="color: #89DDFF;">return</span> <span style="color: #c792ea;">[</span>v.name <span style="color: #89DDFF;">for</span> v <span style="color: #89DDFF;">in</span> voices <span style="color: #89DDFF;">if</span> v.name.lower<span style="color: #f78c6c;">()</span>.startswith<span style="color: #f78c6c;">(</span>user_input.lower<span style="color: #c3e88d;">()</span><span style="color: #f78c6c;">)</span><span style="color: #c792ea;">]</span>

<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">autocomp_destinations</span><span style="color: #c792ea;">(</span>ctx: disnake.ApplicationCommandInteraction, user_input: <span style="color: #82aaff;">str</span><span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">voices</span> = ctx.guild.voice_channels
    <span style="color: #89DDFF;">return</span> <span style="color: #c792ea;">[</span>v.name <span style="color: #89DDFF;">for</span> v <span style="color: #89DDFF;">in</span> voices <span style="color: #89DDFF;">if</span> v.name.lower<span style="color: #f78c6c;">()</span>.startswith<span style="color: #f78c6c;">(</span>user_input.lower<span style="color: #c3e88d;">()</span><span style="color: #f78c6c;">)</span><span style="color: #c792ea;">]</span>
    <span style="color: #556369;">#</span><span style="color: #556369;">return [ville for ville in villes if user_input.lower() in ville]</span>
<span style="color: #c792ea;">@bot.slash_command</span><span style="color: #c792ea;">()</span>
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">transfert</span><span style="color: #c792ea;">(</span>ctx: disnake.ApplicationCommandInteraction,
                    source: <span style="color: #82aaff;">str</span>=commands.Param<span style="color: #f78c6c;">(</span>autocomplete=autocomp_sources<span style="color: #f78c6c;">)</span>,
                    destination: <span style="color: #82aaff;">str</span>=commands.Param<span style="color: #f78c6c;">(</span>autocomplete=autocomp_destinations<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">)</span>:
    <span style="color: #556369;">"""D&#233;place les joueurs d'un salon vocal source &#224; un salon destinatoin</span>

<span style="color: #556369;">        Parameters</span>
<span style="color: #556369;">        ----------</span>
<span style="color: #556369;">        source: La ville o&#249; se d&#233;roule l'invasion</span>
<span style="color: #556369;">        destination: La ville o&#249; se d&#233;roule l'invasion</span>
<span style="color: #556369;">    """</span>
    <span style="color: #ffcb6b;">voices</span> = <span style="color: #c792ea;">{</span>v.name: v <span style="color: #89DDFF;">for</span> v <span style="color: #89DDFF;">in</span> ctx.guild.voice_channels<span style="color: #c792ea;">}</span>
    <span style="color: #ffcb6b;">dest</span> = voices<span style="color: #c792ea;">[</span>destination<span style="color: #c792ea;">]</span>
    <span style="color: #ffcb6b;">users</span> = voices<span style="color: #c792ea;">[</span>source<span style="color: #c792ea;">]</span>.members
    <span style="color: #89DDFF;">await</span> ctx.send<span style="color: #c792ea;">(</span>content=f<span style="color: #c3e88d;">'{len(users)} Utilisateurs vont &#234;tre d&#233;plac&#233;s dans le salon ***{destination}***'</span>, ephemeral=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>
    <span style="color: #c792ea;">[</span><span style="color: #89DDFF;">await</span> u.move_to<span style="color: #f78c6c;">(</span>dest<span style="color: #f78c6c;">)</span> <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> users<span style="color: #c792ea;">]</span>


</pre>
</div>
</div>
</div>

<div id="outline-container-org50ec56d" class="outline-3">
<h3 id="org50ec56d"><span class="section-number-3">4.5.</span> Commande Instance</h3>
<div class="outline-text-3" id="text-4-5">
<div class="org-src-container">
<pre class="src src-python" id="org3bfdbf8"><span style="color: #ffcb6b;">lieux</span> = <span style="color: #c792ea;">[</span><span style="color: #c3e88d;">"Lazarus"</span>, <span style="color: #c3e88d;">"G&#232;nese"</span>, <span style="color: #c3e88d;">"Sir&#232;ne"</span><span style="color: #c792ea;">]</span>

<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">autocomp_lieux</span><span style="color: #c792ea;">(</span>inter: disnake.ApplicationCommandInteraction, user_input: <span style="color: #82aaff;">str</span><span style="color: #c792ea;">)</span>:
    <span style="color: #89DDFF;">return</span> <span style="color: #c792ea;">[</span>l <span style="color: #89DDFF;">for</span> l <span style="color: #89DDFF;">in</span> lieux <span style="color: #89DDFF;">if</span> l.lower<span style="color: #f78c6c;">()</span>.startswith<span style="color: #f78c6c;">(</span>user_input.lower<span style="color: #c3e88d;">()</span><span style="color: #f78c6c;">)</span><span style="color: #c792ea;">]</span>

<span style="color: #c792ea;">@bot.slash_command</span><span style="color: #c792ea;">()</span>
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">instance</span><span style="color: #c792ea;">(</span>ctx: disnake.ApplicationCommandInteraction,
                   lieu: <span style="color: #82aaff;">str</span>=commands.Param<span style="color: #f78c6c;">(</span>autocomplete=autocomp_lieux<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">)</span>:
    <span style="color: #556369;">"""Cr&#233;e un panneau d'inscription &#224; une instance</span>

<span style="color: #556369;">        Parameters</span>
<span style="color: #556369;">        ----------</span>
<span style="color: #556369;">        lieu: La ville o&#249; se d&#233;roule l'invasion</span>
<span style="color: #556369;">    """</span>
    <span style="color: #ffcb6b;">embed</span> = Embed<span style="color: #c792ea;">()</span>
    <span style="color: #ffcb6b;">embed.title</span> = f<span style="color: #c3e88d;">'Instance {lieu}'</span>
    <span style="color: #ffcb6b;">embed.description</span> = f<span style="color: #c3e88d;">'Propos&#233;e par {ctx.user.mention}'</span>
    <span style="color: #ffcb6b;">embed.color</span> = 2003199

    <span style="color: #ffcb6b;">roles</span> = <span style="color: #c792ea;">[</span><span style="color: #c3e88d;">'&#128737;'</span>, <span style="color: #c3e88d;">'&#9876;'</span>, <span style="color: #c3e88d;">'&#9876;'</span>, <span style="color: #c3e88d;">'&#9876;'</span>,<span style="color: #c3e88d;">'&#9937;'</span><span style="color: #c792ea;">]</span>
    <span style="color: #ffcb6b;">players</span> = <span style="color: #c792ea;">[</span><span style="color: #c3e88d;">'libre'</span><span style="color: #c792ea;">]</span>*<span style="color: #82aaff;">len</span><span style="color: #c792ea;">(</span>roles<span style="color: #c792ea;">)</span>
    embed.add_field<span style="color: #c792ea;">(</span>name=<span style="color: #c3e88d;">"R&#244;les"</span>, value=list_to_field<span style="color: #f78c6c;">(</span>roles<span style="color: #f78c6c;">)</span>, inline=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>
    embed.add_field<span style="color: #c792ea;">(</span>name=<span style="color: #c3e88d;">"Joueurs"</span>, value=list_to_field<span style="color: #f78c6c;">(</span>players<span style="color: #f78c6c;">)</span>, inline=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>
    embed.set_footer<span style="color: #c792ea;">(</span>text=<span style="color: #c3e88d;">'Instance'</span><span style="color: #c792ea;">)</span>
    <span style="color: #556369;"># </span><span style="color: #556369;">Envoi du message et ajout de la r&#233;action</span>
    <span style="color: #89DDFF;">await</span> ctx.send<span style="color: #c792ea;">(</span>embed=embed<span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">msg</span> = <span style="color: #89DDFF;">await</span> ctx.original_message<span style="color: #c792ea;">()</span>


    <span style="color: #89DDFF;">for</span> r <span style="color: #89DDFF;">in</span> unique<span style="color: #c792ea;">(</span>roles<span style="color: #c792ea;">)</span>:
        <span style="color: #89DDFF;">await</span> msg.add_reaction<span style="color: #c792ea;">(</span>r<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">await</span> msg.add_reaction<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'&#9989;'</span><span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">await</span> msg.add_reaction<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'&#10060;'</span><span style="color: #c792ea;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org6fdafdd" class="outline-3">
<h3 id="org6fdafdd"><span class="section-number-3">4.6.</span> Gestion des réactions aux messages</h3>
<div class="outline-text-3" id="text-4-6">
<p>
Certain des messages issus des commandes du bot nécessitent une
analyse des réactions des utilisateurs.
</p>

<p>
Les réactions aux messages sont centralisées, et un <b>callback</b> unique
est appelé dès qu'une utilisateur réagit, indépendamment du
message. Or,nous ne voulons pas analyser les réactions aux messages
qui ne sont pas issus d'une commande du bot.
</p>

<p>
Il nous faut donc un mécanisme pour identifier si le message attaché
est d'un type intéressant et si oui, comment l'analyser. Il serait
possible de stocker en mémoire tous les messages issus de commandes
envoyés, mais pour me simplifier la vie je préfére embarquer cette
information dans les messages.
</p>

<p>
Malheureusement, je n'ai pas trouvé de champ non utilisé dans la
classe message. J'ai donc décidé de stocker le type directement dans
le contenu du message. Plus particulièrement dans le <b>footer</b> de
l'embed du message.
</p>
</div>
<div id="outline-container-org9ee38e8" class="outline-4">
<h4 id="org9ee38e8"><span class="section-number-4">4.6.1.</span> On reaction add</h4>
<div class="outline-text-4" id="text-4-6-1">
<div class="org-src-container">
<pre class="src src-python" id="orgf7ddc4e"><span style="color: #c792ea;">@bot.event</span>
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">on_reaction_add</span><span style="color: #c792ea;">(</span>reaction, user<span style="color: #c792ea;">)</span>:
     <span style="color: #89DDFF;">if</span> user == bot.user:
         <span style="color: #89DDFF;">return</span>
     <span style="color: #89DDFF;">if</span> <span style="color: #89DDFF;">not</span> reaction.message.embeds:
         <span style="color: #89DDFF;">return</span>
     <span style="color: #ffcb6b;">msg_type</span> = reaction.message.embeds<span style="color: #c792ea;">[</span>-1<span style="color: #c792ea;">]</span>.footer.text

     <span style="color: #89DDFF;">if</span> msg_type == <span style="color: #c3e88d;">'Invasion'</span>:
         <span style="color: #89DDFF;">await</span> check_user_role<span style="color: #c792ea;">(</span>reaction, user<span style="color: #c792ea;">)</span>
         <span style="color: #89DDFF;">return</span>
     <span style="color: #89DDFF;">if</span> msg_type == <span style="color: #c3e88d;">'Instance'</span>:
         <span style="color: #89DDFF;">await</span> update_instance<span style="color: #c792ea;">(</span>reaction, user<span style="color: #c792ea;">)</span>
         <span style="color: #89DDFF;">return</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-org7722894" class="outline-4">
<h4 id="org7722894"><span class="section-number-4">4.6.2.</span> On reaction remove</h4>
<div class="outline-text-4" id="text-4-6-2">
<div class="org-src-container">
<pre class="src src-python" id="orge690bb8"><span style="color: #c792ea;">@bot.event</span>
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">on_reaction_remove</span><span style="color: #c792ea;">(</span>reaction, user<span style="color: #c792ea;">)</span>:
     <span style="color: #89DDFF;">if</span> user == bot.user:
         <span style="color: #89DDFF;">return</span>
     <span style="color: #89DDFF;">if</span> <span style="color: #89DDFF;">not</span> reaction.message.embeds:
         <span style="color: #89DDFF;">return</span>
     <span style="color: #ffcb6b;">msg_type</span> = reaction.message.embeds<span style="color: #c792ea;">[</span>-1<span style="color: #c792ea;">]</span>.footer.text
     <span style="color: #89DDFF;">if</span> msg_type == <span style="color: #c3e88d;">'Invasion'</span>:
         <span style="color: #89DDFF;">return</span>
     <span style="color: #89DDFF;">if</span> msg_type == <span style="color: #c3e88d;">'Instance'</span>:
         <span style="color: #89DDFF;">await</span> update_instance_rm<span style="color: #c792ea;">(</span>reaction, user<span style="color: #c792ea;">)</span>
         <span style="color: #89DDFF;">return</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-org350506d" class="outline-4">
<h4 id="org350506d"><span class="section-number-4">4.6.3.</span> On s'assure que le joueur soit enregistré</h4>
<div class="outline-text-4" id="text-4-6-3">
<div class="org-src-container">
<pre class="src src-python" id="org8bf204c"><span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">check_user_role</span><span style="color: #c792ea;">(</span>reaction, user<span style="color: #c792ea;">)</span>:
    <span style="color: #556369;"># </span><span style="color: #556369;">R&#233;cup&#233;ration des don&#233;nes du Gdoc roster</span>
    <span style="color: #ffcb6b;">df</span> = get_roster<span style="color: #c792ea;">(</span>config<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">if</span> dtag<span style="color: #c792ea;">(</span>user<span style="color: #c792ea;">)</span> <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> df.index:
        <span style="color: #ffcb6b;">embed</span> = Embed.from_dict<span style="color: #c792ea;">(</span>config<span style="color: #f78c6c;">[</span><span style="color: #c3e88d;">"embeds"</span><span style="color: #f78c6c;">][</span><span style="color: #c3e88d;">"dm"</span><span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>
        <span style="color: #ffcb6b;">embed.description</span> += f<span style="color: #c3e88d;">'{config["gdoc"]["form"]}) ***!***'</span>
        <span style="color: #89DDFF;">try</span>:
            <span style="color: #89DDFF;">await</span> user.send<span style="color: #c792ea;">(</span>embed=embed<span style="color: #c792ea;">)</span>
        <span style="color: #89DDFF;">except</span> disnake.errors.HTTPException <span style="color: #89DDFF;">as</span> e:
            <span style="color: #89DDFF;">pass</span>
    <span style="color: #89DDFF;">else</span>:
        <span style="color: #ffcb6b;">guild</span> = reaction.message.guild
        <span style="color: #ffcb6b;">role</span> = guild.get_role<span style="color: #c792ea;">(</span>config<span style="color: #f78c6c;">[</span><span style="color: #c3e88d;">"ids"</span><span style="color: #f78c6c;">][</span><span style="color: #c3e88d;">"role"</span><span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>

        <span style="color: #89DDFF;">await</span> user.edit<span style="color: #c792ea;">(</span>nick=df.at<span style="color: #f78c6c;">[</span>dtag<span style="color: #c3e88d;">(</span>user<span style="color: #c3e88d;">)</span>, <span style="color: #c3e88d;">"Pseudo IG"</span><span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>
        <span style="color: #89DDFF;">if</span> role <span style="color: #89DDFF;">is</span> <span style="color: #f78c6c;">None</span>:
            <span style="color: #556369;"># </span><span style="color: #556369;">Make sure the role still exists and is valid.</span>
            <span style="color: #89DDFF;">return</span>
        <span style="color: #89DDFF;">try</span>:
            <span style="color: #556369;"># </span><span style="color: #556369;">Finally, add the role.</span>
            <span style="color: #89DDFF;">await</span> user.add_roles<span style="color: #c792ea;">(</span>role<span style="color: #c792ea;">)</span>
        <span style="color: #89DDFF;">except</span> disnake.HTTPException:
            <span style="color: #556369;"># </span><span style="color: #556369;">If we want to do something in case of errors we'd do it here.</span>
            ...
</pre>
</div>
</div>
</div>

<div id="outline-container-org6fa1a0f" class="outline-4">
<h4 id="org6fa1a0f"><span class="section-number-4">4.6.4.</span> Gestion ajout réaction message Instance</h4>
<div class="outline-text-4" id="text-4-6-4">
<div class="org-src-container">
<pre class="src src-python" id="org9d0f6d8"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">instance_data</span><span style="color: #c792ea;">(</span>reaction<span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">fields</span> = <span style="color: #c792ea;">{</span>e.name: e.value.split<span style="color: #f78c6c;">(</span><span style="color: #c3e88d;">'\n'</span><span style="color: #f78c6c;">)</span> <span style="color: #89DDFF;">for</span> e <span style="color: #89DDFF;">in</span> reaction.message.embeds<span style="color: #f78c6c;">[</span>-1<span style="color: #f78c6c;">]</span>.fields<span style="color: #c792ea;">}</span>
    <span style="color: #89DDFF;">return</span> fields<span style="color: #c792ea;">[</span><span style="color: #c3e88d;">'R&#244;les'</span><span style="color: #c792ea;">]</span>, fields<span style="color: #c792ea;">[</span><span style="color: #c3e88d;">'Joueurs'</span><span style="color: #c792ea;">]</span>

<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">update_instance_embed</span><span style="color: #c792ea;">(</span>reaction, roles, joueurs<span style="color: #c792ea;">)</span>:
    <span style="color: #556369;"># </span><span style="color: #556369;">R&#233;cup&#233;ration et mise &#224; jour du message initial</span>
    <span style="color: #ffcb6b;">embed</span> = reaction.message.embeds<span style="color: #c792ea;">[</span>-1<span style="color: #c792ea;">]</span>
    embed.clear_fields<span style="color: #c792ea;">()</span>
    embed.add_field<span style="color: #c792ea;">(</span>name=<span style="color: #c3e88d;">"R&#244;les"</span>, value=list_to_field<span style="color: #f78c6c;">(</span>roles<span style="color: #f78c6c;">)</span>, inline=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>
    embed.add_field<span style="color: #c792ea;">(</span>name=<span style="color: #c3e88d;">"Joueurs"</span>, value=list_to_field<span style="color: #f78c6c;">(</span>joueurs<span style="color: #f78c6c;">)</span>, inline=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">await</span> reaction.message.edit<span style="color: #c792ea;">(</span>embed=embed<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">update_instance</span><span style="color: #c792ea;">(</span>reaction, user, add=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">cmd_author</span> = reaction.message.interaction.user
    <span style="color: #89DDFF;">if</span> reaction.emoji == <span style="color: #c3e88d;">'&#9989;'</span>:
        <span style="color: #89DDFF;">if</span> user == cmd_author:
            <span style="color: #556369;">#</span><span style="color: #556369;">Create vocal and swap users, then</span>
            <span style="color: #556369;">#</span><span style="color: #556369;">voice = await reaction.message.channel.category.create_voice_channel('coucou')</span>
            <span style="color: #556369;">#</span><span style="color: #556369;">print(reaction.message.channel.category.name)</span>
            <span style="color: #556369;">#</span><span style="color: #556369;">await reaction.message.delete(delay=60)</span>
            <span style="color: #89DDFF;">return</span>

    <span style="color: #89DDFF;">if</span> reaction.emoji == <span style="color: #c3e88d;">'&#10060;'</span>:
        <span style="color: #89DDFF;">if</span> user == cmd_author:
            <span style="color: #89DDFF;">await</span> reaction.message.delete<span style="color: #c792ea;">()</span>
        <span style="color: #89DDFF;">return</span>

    <span style="color: #ffcb6b;">roles</span>, <span style="color: #ffcb6b;">joueurs</span> = instance_data<span style="color: #c792ea;">(</span>reaction<span style="color: #c792ea;">)</span>

    <span style="color: #89DDFF;">if</span> user.mention <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> joueurs:
        <span style="color: #89DDFF;">for</span> i, r <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">enumerate</span><span style="color: #c792ea;">(</span>roles<span style="color: #c792ea;">)</span>:
            <span style="color: #89DDFF;">if</span> reaction.emoji == r <span style="color: #89DDFF;">and</span> joueurs<span style="color: #c792ea;">[</span>i<span style="color: #c792ea;">]</span> == <span style="color: #c3e88d;">'libre'</span>:
                <span style="color: #ffcb6b;">joueurs</span><span style="color: #c792ea;">[</span>i<span style="color: #c792ea;">]</span> = user.mention
                <span style="color: #89DDFF;">break</span>

    <span style="color: #89DDFF;">await</span> update_instance_embed<span style="color: #c792ea;">(</span>reaction, roles, joueurs<span style="color: #c792ea;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7db20d9" class="outline-4">
<h4 id="org7db20d9"><span class="section-number-4">4.6.5.</span> Gestion annulation réaction message Instance</h4>
<div class="outline-text-4" id="text-4-6-5">
<div class="org-src-container">
<pre class="src src-python" id="org37bbfb1">
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">update_instance_rm</span><span style="color: #c792ea;">(</span>reaction, user<span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">roles</span>, <span style="color: #ffcb6b;">joueurs</span> = instance_data<span style="color: #c792ea;">(</span>reaction<span style="color: #c792ea;">)</span>
    <span style="color: #556369;"># </span><span style="color: #556369;">Le joueur est-il s&#233;l&#233;ctionn&#233; ?</span>
    <span style="color: #89DDFF;">if</span> user.mention <span style="color: #89DDFF;">in</span> joueurs:
        <span style="color: #556369;"># </span><span style="color: #556369;">On le supprime de la liste des joueurs en le remplacant par libre</span>
        <span style="color: #89DDFF;">for</span> i, r <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">enumerate</span><span style="color: #c792ea;">(</span>roles<span style="color: #c792ea;">)</span>:
            <span style="color: #89DDFF;">if</span> joueurs<span style="color: #c792ea;">[</span>i<span style="color: #c792ea;">]</span> == user.mention <span style="color: #89DDFF;">and</span> r==reaction.emoji:
                <span style="color: #ffcb6b;">joueurs</span><span style="color: #c792ea;">[</span>i<span style="color: #c792ea;">]</span> = <span style="color: #c3e88d;">'libre'</span>
                <span style="color: #89DDFF;">break</span>

        <span style="color: #89DDFF;">for</span> i, r <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">enumerate</span><span style="color: #c792ea;">(</span>roles<span style="color: #c792ea;">)</span>:
            <span style="color: #89DDFF;">if</span> joueurs<span style="color: #c792ea;">[</span>i<span style="color: #c792ea;">]</span> == <span style="color: #c3e88d;">'libre'</span>:
                <span style="color: #ffcb6b;">disponibles</span> = <span style="color: #c792ea;">[</span>d <span style="color: #89DDFF;">for</span> d <span style="color: #89DDFF;">in</span> reaction.message.reactions <span style="color: #89DDFF;">if</span> d.emoji == r<span style="color: #c792ea;">][</span>-1<span style="color: #c792ea;">]</span>
                <span style="color: #556369;"># </span><span style="color: #556369;">On r&#233;cup&#233;re les utilisateurs en prennat soint de filtrer le bot</span>
                <span style="color: #ffcb6b;">disponibles</span> = <span style="color: #c792ea;">[</span>u <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> <span style="color: #89DDFF;">await</span> disponibles.users<span style="color: #f78c6c;">()</span>.flatten<span style="color: #f78c6c;">()</span> <span style="color: #89DDFF;">if</span> u != bot.user <span style="color: #89DDFF;">and</span> u.mention <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> joueurs<span style="color: #c792ea;">]</span>
                <span style="color: #89DDFF;">if</span> disponibles:
                    <span style="color: #ffcb6b;">joueurs</span><span style="color: #c792ea;">[</span>i<span style="color: #c792ea;">]</span> = disponibles<span style="color: #c792ea;">[</span>0<span style="color: #c792ea;">]</span>.mention

    <span style="color: #89DDFF;">await</span> update_instance_embed<span style="color: #c792ea;">(</span>reaction, roles, joueurs<span style="color: #c792ea;">)</span>

</pre>
</div>


<p>
<a href="https://github.com/DisnakeDev/disnake">https://github.com/DisnakeDev/disnake</a>
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: ipsum</p>
<p class="date">Created: 2022-02-25 ven. 16:28</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
