<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-05 mer. 17:20 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Invabot</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Virgile Daugé" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<style type="text/css">
 pre.src {background-color: #263238; color: #EEFFFF;}</style>
<style type="text/css">
 pre.src {background-color: #263238; color: #EEFFFF;}</style>
<style type="text/css">
 pre.src {background-color: #263238; color: #EEFFFF;}</style>
<style type="text/css">
 pre.src {background-color: #263238; color: #EEFFFF;}</style>
<style type="text/css">
 pre.src {background-color: #263238; color: #EEFFFF;}</style>
<style type="text/css">
 pre.src {background-color: #263238; color: #EEFFFF;}</style>
<style type="text/css">
 pre.src {background-color: #263238; color: #EEFFFF;}</style>
<style type="text/css">
 pre.src {background-color: #263238; color: #EEFFFF;}</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Invabot</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org4f6e4e4">1. Documentation des rôles</a>
<ul>
<li><a href="#org7425a3e">1.1. Arc</a></li>
<li><a href="#org44eeeda">1.2. Mousquet</a></li>
<li><a href="#orgba78ce8">1.3. Anti-Trash</a></li>
<li><a href="#org7b19e18">1.4. DPS debuff</a></li>
<li><a href="#org1a96288">1.5. Pustule boy</a></li>
<li><a href="#org7ebcd5e">1.6. Réparateur</a></li>
<li><a href="#org573bfa7">1.7. Artilleur</a></li>
<li><a href="#org55b289d">1.8. Heal</a></li>
<li><a href="#org9b55e4d">1.9. Mage AOE</a></li>
</ul>
</li>
<li><a href="#org8d53813">2. Bot Discord</a>
<ul>
<li><a href="#org8dbeaf7">2.1. Concept :</a></li>
<li><a href="#org4dc5550">2.2. Configuration</a></li>
<li><a href="#orgd643e94">2.3. Utilitaires</a>
<ul>
<li><a href="#org77a6c0f">2.3.1. Dépendances</a></li>
<li><a href="#org214cef6">2.3.2. Chargement de la config</a></li>
<li><a href="#orga65be22">2.3.3. Chargement du token</a></li>
<li><a href="#orgc064361">2.3.4. Identifiant</a></li>
<li><a href="#orgdbe84bf">2.3.5. Récupération du roster</a></li>
<li><a href="#orge65bc47">2.3.6. Récupération de la strat</a></li>
</ul>
</li>
<li><a href="#orgc481b72">2.4. Bot avec discord.py</a>
<ul>
<li><a href="#org9ade877">2.4.1. DM des joueurs qui n'ont pas renseigné leurs rôles</a></li>
<li><a href="#orgd321ce6">2.4.2. Vérification des enregistrés</a></li>
<li><a href="#org92233f4">2.4.3. Run</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org49198b2">3. Algo</a>
<ul>
<li><a href="#org6966ed3">3.1. Test algo</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org4f6e4e4" class="outline-2">
<h2 id="org4f6e4e4"><span class="section-number-2">1</span> Documentation des rôles</h2>
<div class="outline-text-2" id="text-1">
<script async src="https://nwdb.info/embed.js"></script>
<p>
Cette section a pour objectif de présenter les différents rôles utiles
en invasion. Chaque rôle comporte des composantes indispensables,
illustrées par le sigle suivant : <i>(obligatoire)</i>. Afin de mieux
maîtriser la répartition des rôles, il sera demandé aux joueurs
d'évaluer leur pertinence pour chacun de ces rôles.
</p>

<p>
Un joueur peut s'estimer :
</p>

<dl class="org-dl">
<dt>Capable</dt><dd>S'il répond à tous les critères tagués <b><i>(obligatoire)</i></b></dd>
<dt>Opti</dt><dd>S'il répond a tous les critères tagués <b><i>(obligatoire)</i></b> <b>ET</b> <b><i>(recommandé)</i></b>.</dd>
</dl>
</div>

<div id="outline-container-org7425a3e" class="outline-3">
<h3 id="org7425a3e"><span class="section-number-3">1.1</span> Arc</h3>
<div class="outline-text-3" id="text-1-1">
<dl class="org-dl">
<dt><b>Objectif</b></dt><dd>DPS les <b>têtes</b> et les <b>boss</b>, dans cet ordre de priorité.</dd>
<dt><b>Arme principale</b></dt><dd>Arc <a href="https://nwdb.info/db/perk/perkid_weapon_dmgcorrupted">Corrupted Bane</a> <b><i>(obligatoire)</i></b> et <a href="https://nwdb.info/db/perk/perkid_weapon_empoweroncrit">Keenly
Empowered</a> <b><i>(recommandé)</i></b>. <a href="https://nwdb.info/build?skills=4-iw75uo-ngewxw">Build arc</a> <b><i>(recommandé)</i></b></dd>
<dt><b>Arme secondaire</b></dt><dd>Arme débuff distance comme la hachette ou la lance avec <a href="https://nwdb.info/db/perk/perkid_ability_spear_javelin">Sundering Javelin</a> sur pièce d'armure <b><i>(recommandé)</i></b></dd>
<dt><b>Armure</b></dt><dd>Légère avec perks pour l'arc<a href="https://nwdb.info/db/perk/perkid_ability_bow_poisonshot"> Enfeebling Poison Shot</a> et <a href="https://nwdb.info/db/perk/perkid_ability_bow_rapidshot">Penetrating Rapid Shot</a> <b><i>(recommandé)</i></b></dd>
</dl>
<p>
<a href="https://nwdb.info/db/perk/perkid_ability_spear_javelin">      Sundering Javelin</a> <b><i>(recommandé)</i></b>
</p>
</div>
</div>

<div id="outline-container-org44eeeda" class="outline-3">
<h3 id="org44eeeda"><span class="section-number-3">1.2</span> Mousquet</h3>
<div class="outline-text-3" id="text-1-2">
<dl class="org-dl">
<dt><b>Objectif</b></dt><dd>DPS les <b>têtes</b> et les <b>boss</b>, dans cet ordre de priorité.</dd>
<dt><b>Arme principale</b></dt><dd>Mousquet <a href="https://nwdb.info/db/perk/perkid_weapon_dmgcorrupted">Corrupted Bane</a> <b><i>(obligatoire)</i></b> et
<a href="https://nwdb.info/db/perk/perkid_weapon_dmgbasic">Enchanted</a> <b><i>(recommandé)</i></b>  <a href="https://nwdb.info/build?skills=6-nm5y04-qtbfgg">Build Mousquet</a> <b><i>(recommandé)</i></b></dd>
<dt><b>Arme secondaire</b></dt><dd>Arme débuff distance comme la hachette ou la lance avec <a href="https://nwdb.info/db/perk/perkid_ability_spear_javelin">Sundering Javelin</a> sur pièce d'armure <b><i>(recommandé)</i></b></dd>
<dt><b>Armure</b></dt><dd>Légère avec perks pour le mousquet <a href="https://nwdb.info/db/perk/perkid_ability_musket_shootersstance">Empowering Shooter's
Stance</a> et <a href="https://nwdb.info/db/perk/perkid_ability_musket_powderburn">Crippling Powder Burn</a> <b><i>(recommandé)</i></b>. Perk <a href="https://nwdb.info/db/perk/perkid_ability_spear_javelin">Sundering Javelin</a> <b><i>(recommandé)</i></b></dd>
</dl>
</div>
</div>
<div id="outline-container-orgba78ce8" class="outline-3">
<h3 id="orgba78ce8"><span class="section-number-3">1.3</span> Anti-Trash</h3>
<div class="outline-text-3" id="text-1-3">
<dl class="org-dl">
<dt><b>Objectif</b></dt><dd>Empêcher les <b>trash-mobs</b> d'atteindre les autres joueurs et les portes.</dd>
<dt><b>Arme principale</b></dt><dd>Hache double avec <a href="https://nwdb.info/db/perk/perkid_weapon_dmgcorrupted">Corrupted Bane</a> <b><i>(obligatoire)</i></b>
<a href="https://nwdb.info/db/item/sapphirecutt4">Pristine Sapphire</a> <b><i>(obligatoire)</i></b> et <a href="https://nwdb.info/db/item/sapphirecutt4%20%5B%5Bhttps://nwdb.info/db/perk/perkid_weapon_empoweroncrit">Keenly Empowered</a> (recommandé).
<a href="https://nwdb.info/build?skills=8-j1mxog-kc3hhg">Build Hache double</a> <b><i>(obligatoire)</i></b></dd>
<dt><b>Arme secondaire</b></dt><dd>Arme CàC, Marteau pour le contrôle ?</dd>
<dt><b>Armure</b></dt><dd>Lourde avec perks <a href="https://nwdb.info/db/perk/perkid_ability_greataxe_gravitywell">Insatiable Gravity Well</a> (obligatoire)
<a href="https://nwdb.info/db/perk/perkid_ability_greataxe_maelstrom">Enfeebling Maelstrom</a> et <a href="https://nwdb.info/db/perk/perkid_ability_greataxe_whirlwind">Fortifying Whirlwind</a> <b><i>(recommandé)</i></b> et pour de
la survivabilité <a href="https://nwdb.info/db/perk/perkid_armor_defcorrupted">Corrupted Ward</a> sur quelques pièces <b><i>(recommandé)</i></b></dd>
</dl>
</div>
</div>

<div id="outline-container-org7b19e18" class="outline-3">
<h3 id="org7b19e18"><span class="section-number-3">1.4</span> DPS debuff</h3>
<div class="outline-text-3" id="text-1-4">
<dl class="org-dl">
<dt><b>Objectif</b></dt><dd>Appliquer <b><i>rend</i></b> et <b><i>weaken</i></b> aux boss et les DPS</dd>
<dt><b>Arme principale</b></dt><dd>Lance avec <a href="https://nwdb.info/db/perk/perkid_weapon_dmgcorrupted">Corrupted Bane</a> <b><i>(obligatoire)</i></b> et
<a href="https://nwdb.info/db/perk/perkid_weapon_empoweroncrit">Keenly Empowered</a> ou <a href="https://nwdb.info/db/perk/perkid_weaponmelee_dmgback">Rogue</a> <b><i>(recommandé)</i></b>. <a href="https://nwdb.info/build?skills=10-l71p4w-tsmm2s">Build lance</a>
<b><i>(obligatoire)</i></b></dd>
<dt><b>Arme secondaire</b></dt><dd>Arc préféré, mais peut être une arme de CàC</dd>
<dt><b>Armure</b></dt><dd>Légère avec perks <a href="https://nwdb.info/db/perk/perkid_ability_spear_javelin">Sundering Javelin</a> <b><i>(obligatoire)</i></b>
<a href="https://nwdb.info/db/perk/perkid_ability_spear_skewer">Enfeebling Skewer</a> <b><i>(obligatoire)</i></b> <a href="https://nwdb.info/db/perk/perkid_ability_spear_perforate">Fortifying Perforate</a> <b><i>(recommandé)</i></b>
et pour de la survivabilité <a href="https://nwdb.info/db/perk/perkid_armor_defcorrupted">Corrupted Ward</a> sur quelques pièces <b><i>(recommandé)</i></b></dd>
</dl>
</div>
</div>

<div id="outline-container-org1a96288" class="outline-3">
<h3 id="org1a96288"><span class="section-number-3">1.5</span> Pustule boy</h3>
<div class="outline-text-3" id="text-1-5">
<dl class="org-dl">
<dt><b>Objectif</b></dt><dd>Tirer en <b>priorité sur les pustules</b> qui se forment
lors de l'impact d'un bison à l'intérieur du fort. Aider au centre.</dd>

<dt><b>Arme principale</b></dt><dd>Arme distante <b><i>(obligatoire)</i></b>, les armes
Néant/Arc/Feu <b><i>(recommandé)</i></b> sont plus efficaces dans ce rôle
grâce à une meilleure cadence de tir.</dd>
<dt><b>Arme secondaire</b></dt><dd>Arc/Mousquet <b><i>(recommandé)</i></b></dd>
</dl>
</div>
</div>

<div id="outline-container-org7ebcd5e" class="outline-3">
<h3 id="org7ebcd5e"><span class="section-number-3">1.6</span> Réparateur</h3>
<div class="outline-text-3" id="text-1-6">
<dl class="org-dl">
<dt><b>Objectif</b></dt><dd>Gérer les ressources et <b>réparer les portes</b>. Certains
voient ce rôle comme ingrat mais la victoire est inenvisageable sans
eux.</dd>

<dt><b>Arme principale</b></dt><dd>Hachette avec <a href="https://nwdb.info/db/ability/ult_passive_hatchet_immortalwhen0hp">Defy Death</a> <b><i>(recommandé)</i></b></dd>
<dt><b>Arme secondaire</b></dt><dd>Arme avec mobilité <b><i>(recommandé)</i></b></dd>
</dl>

<p>
PS: Si vous n'avez jamais joué Hachette, il suffit de débloquer 12
points de compétence. C'est assez rapide et vous n'avez pas besoin
d'une arme haut niveau/particulière.
</p>
</div>
</div>

<div id="outline-container-org573bfa7" class="outline-3">
<h3 id="org573bfa7"><span class="section-number-3">1.7</span> Artilleur</h3>
<div class="outline-text-3" id="text-1-7">
<dl class="org-dl">
<dt><b>Objectif</b></dt><dd>Tuer les bombers, les tireurs, les artilleries
ennemies et les trash mob, en respectant cet ordre de priorité.</dd>

<dt><b>Arme principale</b></dt><dd>Épée avec la compétence <a href="https://nwdb.info/db/ability/ultimate_sword_swordmaster">Leadership</a> <b><i>(obligatoire)</i></b></dd>
<dt><b>Arme secondaire</b></dt><dd>Bâton de feu/vie <b><i>(recommandé)</i></b></dd>
</dl>

<p>
PS: Si vous n'avez jamais joué l'épée, il suffit de débloquer 12
points de compétence. C'est assez rapide et vous n'avez pas besoin
d'une arme haut niveau/particulière.
</p>
</div>
</div>
<div id="outline-container-org55b289d" class="outline-3">
<h3 id="org55b289d"><span class="section-number-3">1.8</span> Heal</h3>
<div class="outline-text-3" id="text-1-8">
<dl class="org-dl">
<dt><b>Objectif</b></dt><dd>Maintenir l'équipe <b>Anti-trash</b> en vie en priorité
puis empêcher les <b>trash-mobs</b> d'atteindre les autres joueurs et les
portes.</dd>
<dt><b>Arme principale</b></dt><dd>Bâton de vie <b><i>(obligatoire)</i></b> avec <a href="https://nwdb.info/db/perk/perkid_weaponlife_healoutgoing">Blessed</a>
<b><i>(recommandé)</i></b></dd>
<dt><b>Arme secondaire</b></dt><dd>Hache double avec <a href="https://nwdb.info/db/perk/perkid_weapon_dmgcorrupted">Corrupted Bane</a> et <a href="https://nwdb.info/db/item/ambercutt4">Pristine
Amber</a> <b><i>(recommandé)</i></b> <a href="https://nwdb.info/build?skills=8-j1mxog-kc3hhg">Build Hache double</a> <b><i>(recommandé)</i></b></dd>
<dt><b>Armure</b></dt><dd><a href="https://nwdb.info/db/perk/perkid_armor_defcorrupted">Corrupted Ward</a> sur quelques pièces <b><i>(recommandé)</i></b></dd>
</dl>
</div>
</div>


<div id="outline-container-org9b55e4d" class="outline-3">
<h3 id="org9b55e4d"><span class="section-number-3">1.9</span> Mage AOE</h3>
<div class="outline-text-3" id="text-1-9">
<dl class="org-dl">
<dt><b>Objectif</b></dt><dd>DPS les <b>boss</b> dans les phases de fin, quand ils
s'accumulent sur les portes.</dd>
<dt><b>Arme principale</b></dt><dd>Bâton de feu <a href="https://nwdb.info/db/perk/perkid_weapon_dmgcorrupted">Corrupted Bane</a> avec <a href="https://nwdb.info/db/item/sapphirecutt4">Pristine Sapphire</a> <b><i>(obligatoire)</i></b>
et <a href="https://nwdb.info/db/perk/perkid_weapon_empoweroncrit">Keenly Empowered</a> <b><i>(recommandé)</i></b>.</dd>
<dt><b>Arme secondaire</b></dt><dd>Mousquet <a href="https://nwdb.info/db/perk/perkid_weapon_dmgcorrupted">Corrupted Bane</a> et <a href="https://nwdb.info/db/perk/perkid_weapon_dmgbasic">Enchanted</a> avec
<a href="https://nwdb.info/db/item/sapphirecutt4">Pristine Sapphire</a> <b><i>(recommandé)</i></b></dd>
<dt><b>Armure</b></dt><dd>Légère avec perks pour le lance flamme <a href="https://nwdb.info/db/perk/perkid_ability_firestaff_flamethrower">Accelerating
Flamethrower</a> <b><i>(recommandé)</i></b></dd>
</dl>
</div>
</div>
</div>

<div id="outline-container-org8d53813" class="outline-2">
<h2 id="org8d53813"><span class="section-number-2">2</span> Bot Discord</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org8dbeaf7" class="outline-3">
<h3 id="org8dbeaf7"><span class="section-number-3">2.1</span> Concept :</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Le bot à pour objectif de générer une composition d'armée à partir des
50 joueurs sélectionnés aléatoirement par le jeu.
</p>
</div>
</div>

<div id="outline-container-org4dc5550" class="outline-3">
<h3 id="org4dc5550"><span class="section-number-3">2.2</span> Configuration</h3>
<div class="outline-text-3" id="text-2-2">
<p>
La configuration du bot passera par un fichier json unique, contenant
le corps des différents messages à transmettre ainsi que les adresses
des Gdoc à lire.
</p>
<div class="org-src-container">
<pre class="src src-json"><span style="color: #c792ea;">{</span>
<span style="color: #89DDFF;">"ids"</span>: <span style="color: #f78c6c;">{</span>
    <span style="color: #89DDFF;">"role"</span>: <span style="color: #f78c6c;">917546013248606238</span>,
    <span style="color: #89DDFF;">"leads"</span>: <span style="color: #f78c6c;">928316217297612810</span>
<span style="color: #f78c6c;">}</span>,
<span style="color: #89DDFF;">"embeds"</span>: <span style="color: #f78c6c;">{</span>
    <span style="color: #89DDFF;">"panneau"</span>: <span style="color: #c3e88d;">{</span>
        <span style="color: #89DDFF;">"title"</span>: <span style="color: #c3e88d;">"Confirme ta s&#233;l&#233;ction &#224; l'invasion de"</span>,
        <span style="color: #89DDFF;">"color"</span>: <span style="color: #f78c6c;">2003199</span>,
        <span style="color: #89DDFF;">"description"</span>: <span style="color: #c3e88d;">"R&#233;agis avec :ballot_box_with_check: &#224; ce message **uniquement si tu es d&#233;j&#224; dans le fort**. Attention, retourne vite en jeu, l'auto-AFK kick est rapide (2min). \n\n Si tu as r&#233;agi par erreur, merci de d&#233;cocher ta r&#233;action. :wink: \n\n*(Et si vous aussi vous pensez que bakhu est la meilleure guilde)*"</span>
    <span style="color: #c3e88d;">}</span>,
    <span style="color: #89DDFF;">"dm"</span>: <span style="color: #c3e88d;">{</span>
        <span style="color: #89DDFF;">"title"</span>: <span style="color: #c3e88d;">"Dis nous tout !"</span>,
        <span style="color: #89DDFF;">"color"</span>: <span style="color: #f78c6c;">2003199</span>,
        <span style="color: #89DDFF;">"description"</span>: <span style="color: #c3e88d;">"Tu es inscrit en invasion, mais tu n'as pas renseign&#233; **les r&#244;les** que tu peux jouer. Il n'est donc par cons&#233;quent pas possible de t'assigner un poste automatiquement. Allez, file remplir [ce document]("</span>
    <span style="color: #c3e88d;">}</span>,
    <span style="color: #89DDFF;">"change"</span>: <span style="color: #c3e88d;">{</span>
        <span style="color: #89DDFF;">"title"</span>: <span style="color: #c3e88d;">"Tu as chang&#233; ton discord TAG :/"</span>,
        <span style="color: #89DDFF;">"color"</span>: <span style="color: #f78c6c;">2003199</span>,
        <span style="color: #89DDFF;">"description"</span>: <span style="color: #c3e88d;">"Il faut mettre &#224; jour tes infos. Allez, file remplir [ce document]("</span>
    <span style="color: #c3e88d;">}</span>,
    <span style="color: #89DDFF;">"help"</span>: <span style="color: #c3e88d;">{</span>
        <span style="color: #89DDFF;">"title"</span>: <span style="color: #c3e88d;">"Manuel d'utilisation d'invabot"</span>,
        <span style="color: #89DDFF;">"color"</span>: <span style="color: #f78c6c;">2003199</span>,
        <span style="color: #89DDFF;">"fields"</span>: <span style="color: #89DDFF;">[</span><span style="color: #bb80b3;">{</span><span style="color: #89DDFF;">"name"</span>: <span style="color: #c3e88d;">"Blue Team"</span>, <span style="color: #89DDFF;">"value"</span>: <span style="color: #c3e88d;">"Something"</span>, <span style="color: #89DDFF;">"inline"</span> : <span style="color: #c3e88d;">"True"</span><span style="color: #bb80b3;">}</span><span style="color: #89DDFF;">]</span>
    <span style="color: #c3e88d;">}</span>
<span style="color: #f78c6c;">}</span>,
<span style="color: #89DDFF;">"gdoc"</span>: <span style="color: #f78c6c;">{</span>
    <span style="color: #89DDFF;">"url"</span>: <span style="color: #c3e88d;">"https://docs.google.com/spreadsheets/d/1FgtMvUQbLxP7qvXt2tnVwFFyX9KWnuREHu7o0RtX13M/"</span>,
    <span style="color: #89DDFF;">"page_strat"</span>: <span style="color: #c3e88d;">"Strat_principale"</span>,
    <span style="color: #89DDFF;">"page_roster"</span>: <span style="color: #c3e88d;">"Roster"</span>,
    <span style="color: #89DDFF;">"form"</span>: <span style="color: #c3e88d;">"https://forms.gle/G9LizybajjVxCw6JA"</span>
<span style="color: #f78c6c;">}</span>
<span style="color: #c792ea;">}</span>
</pre>
</div>
</div>
</div>



<div id="outline-container-orgd643e94" class="outline-3">
<h3 id="orgd643e94"><span class="section-number-3">2.3</span> Utilitaires</h3>
<div class="outline-text-3" id="text-2-3">
</div>
<div id="outline-container-org77a6c0f" class="outline-4">
<h4 id="org77a6c0f"><span class="section-number-4">2.3.1</span> Dépendances</h4>
<div class="outline-text-4" id="text-2-3-1">
<div class="org-src-container">
<pre class="src src-python">
<span style="color: #89DDFF;">import</span> pandas <span style="color: #89DDFF;">as</span> pd
<span style="color: #89DDFF;">from</span> algo <span style="color: #89DDFF;">import</span> build_comp

<span style="color: #89DDFF;">import</span> discord
<span style="color: #89DDFF;">from</span> discord.ext <span style="color: #89DDFF;">import</span> commands
</pre>
</div>
</div>
</div>
<div id="outline-container-org214cef6" class="outline-4">
<h4 id="org214cef6"><span class="section-number-4">2.3.2</span> Chargement de la config</h4>
<div class="outline-text-4" id="text-2-3-2">
<p>
Le chargement de cette config se fera pour l'instant une seule fois au
démarrage du bot.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #556369;"># </span><span style="color: #556369;">Chargement de la config du bot</span>
<span style="color: #89DDFF;">import</span> json
<span style="color: #89DDFF;">with</span> <span style="color: #82aaff;">open</span><span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'config.json'</span>, <span style="color: #c3e88d;">'r'</span><span style="color: #c792ea;">)</span> <span style="color: #89DDFF;">as</span> datafile:
    <span style="color: #ffcb6b;">config</span> = json.load<span style="color: #c792ea;">(</span>datafile<span style="color: #c792ea;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga65be22" class="outline-4">
<h4 id="orga65be22"><span class="section-number-4">2.3.3</span> Chargement du token</h4>
<div class="outline-text-4" id="text-2-3-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #556369;"># </span><span style="color: #556369;">Chargement du token</span>
<span style="color: #89DDFF;">with</span> <span style="color: #82aaff;">open</span><span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'bot.token'</span>, <span style="color: #c3e88d;">'r'</span><span style="color: #c792ea;">)</span> <span style="color: #89DDFF;">as</span> datafile:
    <span style="color: #ffcb6b;">token</span> = datafile.read<span style="color: #c792ea;">()</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc064361" class="outline-4">
<h4 id="orgc064361"><span class="section-number-4">2.3.4</span> Identifiant</h4>
<div class="outline-text-4" id="text-2-3-4">
<p>
Il est nécessaire d'avoir un identifiant unique entre discord et le
gdoc pour faire le lien. Discord gère les identifiants sous forme d'un
entier appelé <i>snowflake</i>. Toutefois, il est difficilement accessible
pour les joueurs, et ce sont les joueurs qui vont devoir renseigner
leur identifiant unique sur le gdoc. Il est donc plus simple
d'utiliser ici le <b>discord tag</b>, par exemple `Virgile#1234`.
</p>

<p>
Je propose ici une rapide fonction d'aide pour récupérer le dtag
depuis un objet <i>discord.User</i> :
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">dtag</span><span style="color: #c792ea;">(</span>user<span style="color: #c792ea;">)</span>:
    <span style="color: #89DDFF;">return</span> f<span style="color: #c3e88d;">'{user.name}#{user.discriminator}'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdbe84bf" class="outline-4">
<h4 id="orgdbe84bf"><span class="section-number-4">2.3.5</span> Récupération du roster</h4>
<div class="outline-text-4" id="text-2-3-5">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">import</span> pandas <span style="color: #89DDFF;">as</span> pd
<span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">get_roster</span><span style="color: #c792ea;">(</span>config<span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">url</span> = f<span style="color: #c3e88d;">"{config['gdoc']['url']}gviz/tq?tqx=out:csv&amp;sheet={config['gdoc']['page_roster']}"</span>
    <span style="color: #556369;">#</span><span style="color: #556369;">return pd.read_csv(url).iloc[1:, 0:6].dropna().set_index('dtag')</span>
    <span style="color: #89DDFF;">return</span> pd.read_csv<span style="color: #c792ea;">(</span>url<span style="color: #c792ea;">)</span>.set_index<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'dtag'</span><span style="color: #c792ea;">)</span>
</pre>
</div>

<pre class="example">
                Pseudo             0           1     2           3
dtag
Chopekk#1234   Chopekk    DPS-Debuff    Mousquet  Heal  Anti-trash
Virgile#2345  virgilio      Mousquet  Anti-trash  Répa        Arti
Virgile#3456     Tezig  Lance-flamme  Anti-trash   Arc        Arti
Carlito#4567      Slua    Anti-trash        Arti  Répa       Aucun
</pre>
</div>
</div>
<div id="outline-container-orge65bc47" class="outline-4">
<h4 id="orge65bc47"><span class="section-number-4">2.3.6</span> Récupération de la strat</h4>
<div class="outline-text-4" id="text-2-3-6">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">get_strat</span><span style="color: #c792ea;">(</span>config<span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">url</span> = f<span style="color: #c3e88d;">"{config['gdoc']['url']}gviz/tq?tqx=out:csv&amp;sheet={config['gdoc']['page_strat']}"</span>
    <span style="color: #89DDFF;">return</span> pd.read_csv<span style="color: #c792ea;">(</span>url<span style="color: #c792ea;">)</span>.iloc<span style="color: #c792ea;">[</span>0:5, 0:12<span style="color: #c792ea;">]</span>
</pre>
</div>

<pre class="example">
     Groupe 1 Groupe 2    Groupe 3 Groupe 4    Groupe 5    Groupe 6    Groupe 7    Groupe 8 Groupe 9     Groupe 10
0  Anti-Trash      Arc  Anti-Trash      Arc  Anti-Trash    Mousquet  Anti-Trash    Mousquet     Répa  Lance-flamme
1        Heal      Arc        Heal      Arc        Heal    Mousquet        Heal    Mousquet     Répa  Lance-flamme
2  DPS-Debuff      Arc  DPS-Debuff      Arc  DPS-Debuff    Mousquet  DPS-Debuff    Mousquet     Répa  Lance-flamme
3  DPS-Debuff      Arc  DPS-Debuff      Arc  DPS-Debuff  DPS-Debuff  DPS-Debuff  DPS-Debuff     Répa  Lance-flamme
4        Arti     Arti        Arti     Arti        Arti        Arti        Arti        Arti     Répa  Lance-flamme
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc481b72" class="outline-3">
<h3 id="orgc481b72"><span class="section-number-3">2.4</span> Bot avec discord.py</h3>
<div class="outline-text-3" id="text-2-4">
<p>
<a href="https://discordpy.readthedocs.io/en/stable/">https://discordpy.readthedocs.io/en/stable/</a>
</p>

<p>
Création du bot
</p>
<div class="org-src-container">
<pre class="src src-python">
<span style="color: #ffcb6b;">intents</span> = discord.Intents.default<span style="color: #c792ea;">()</span>
<span style="color: #ffcb6b;">intents.reactions</span> = <span style="color: #f78c6c;">True</span>
<span style="color: #ffcb6b;">intents.members</span> = <span style="color: #f78c6c;">True</span>
<span style="color: #ffcb6b;">bot</span> = commands.Bot<span style="color: #c792ea;">(</span>command_prefix=<span style="color: #c3e88d;">"!"</span>, intents=intents<span style="color: #c792ea;">)</span>

<span style="color: #ffcb6b;">msgs</span> = <span style="color: #c792ea;">{}</span>
<span style="color: #ffcb6b;">msgs_ids</span> = <span style="color: #c792ea;">[]</span>

<span style="color: #c792ea;">@bot.event</span>
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">on_ready</span><span style="color: #c792ea;">()</span>:
    <span style="color: #89DDFF;">print</span><span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'We have logged in as {0.user}'</span>.<span style="color: #82aaff;">format</span><span style="color: #f78c6c;">(</span>bot<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">game</span> = discord.Game<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">"Venez chez Bakhu"</span><span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">await</span> bot.change_presence<span style="color: #c792ea;">(</span>status=discord.Status.online, activity=game<span style="color: #c792ea;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #c792ea;">@bot.command</span><span style="color: #c792ea;">()</span>
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">help</span><span style="color: #c792ea;">(</span>ctx<span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">embed</span> = discord.Embed.from_dict<span style="color: #c792ea;">(</span>config<span style="color: #f78c6c;">[</span><span style="color: #c3e88d;">"embeds"</span><span style="color: #f78c6c;">][</span><span style="color: #c3e88d;">"help"</span><span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">await</span> ctx.channel.send<span style="color: #c792ea;">(</span>embed=embed<span style="color: #c792ea;">)</span>
</pre>
</div>

<p>
Commande d'ajout du panneau d'inscription, sur lequel les joueurs dans
le fort doivent se signaler sera `!inva nomVille`
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #c792ea;">@bot.command</span><span style="color: #c792ea;">()</span>
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">inva</span><span style="color: #c792ea;">(</span>ctx, arg=<span style="color: #c3e88d;">"NomVille"</span><span style="color: #c792ea;">)</span>:
    <span style="color: #556369;">""" G&#233;n&#233;re un tableau d'inscription dans le channel</span>
<span style="color: #556369;">    """</span>
    <span style="color: #ffcb6b;">embed</span> = discord.Embed.from_dict<span style="color: #c792ea;">(</span>config<span style="color: #f78c6c;">[</span><span style="color: #c3e88d;">"embeds"</span><span style="color: #f78c6c;">][</span><span style="color: #c3e88d;">"panneau"</span><span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">embed.title</span> += f<span style="color: #c3e88d;">' {arg}'</span>
    embed.set_footer<span style="color: #c792ea;">(</span>text=ctx.author.name, icon_url = ctx.author.avatar_url<span style="color: #c792ea;">)</span>

    <span style="color: #ffcb6b;">msg</span> = <span style="color: #89DDFF;">await</span> ctx.channel.send<span style="color: #c792ea;">(</span>embed=embed<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">await</span> msg.add_reaction<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'&#9745;'</span><span style="color: #c792ea;">)</span>

    <span style="color: #ffcb6b;">author_id</span> = dtag<span style="color: #c792ea;">(</span>ctx.author<span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">msgs</span><span style="color: #c792ea;">[</span>author_id<span style="color: #c792ea;">]</span> = msg.<span style="color: #82aaff;">id</span>
    <span style="color: #89DDFF;">global</span> msgs_ids
    <span style="color: #ffcb6b;">msgs_ids</span> += <span style="color: #c792ea;">[</span>msg.<span style="color: #82aaff;">id</span><span style="color: #c792ea;">]</span>
</pre>
</div>

<p>
La commande de demande de <b>composition</b> sera la suivante `!comp`. La
fonction associée doit récupérer le message <i>panneau</i> à partir de
l'identité de l'appelant. Puis, récupérer la liste des joueurs qui ont
réagi sur le panneau.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #c792ea;">@bot.command</span><span style="color: #c792ea;">()</span>
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">comp</span><span style="color: #c792ea;">(</span>ctx<span style="color: #c792ea;">)</span>:
    <span style="color: #556369;">""" G&#233;n&#233;re une composition d'arm&#233;e</span>
<span style="color: #556369;">    """</span>
    <span style="color: #ffcb6b;">author_dtag</span> = dtag<span style="color: #c792ea;">(</span>ctx.author<span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">channel</span> = ctx.channel

    <span style="color: #556369;"># </span><span style="color: #556369;">On s'assure que l'utilisateur qui demande le calcul ait d&#233;j&#224; fait la commande principale</span>
    <span style="color: #89DDFF;">if</span> author_dtag <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> msgs:
        <span style="color: #89DDFF;">await</span> channel.send<span style="color: #c792ea;">(</span>f<span style="color: #c3e88d;">"Pas de messages trouv&#233;s pour {author_dtag}. Commencez par utiliser la commande :\n $inva nomVille"</span><span style="color: #c792ea;">)</span>
        <span style="color: #89DDFF;">return</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">R&#233;cup&#233;ration du message avec les r&#233;acs</span>
    <span style="color: #ffcb6b;">msg_id</span> = msgs<span style="color: #c792ea;">[</span>author_dtag<span style="color: #c792ea;">]</span>
    <span style="color: #ffcb6b;">main_msg</span> = <span style="color: #89DDFF;">await</span> channel.fetch_message<span style="color: #c792ea;">(</span>msg_id<span style="color: #c792ea;">)</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">R&#233;cup&#233;ration de la liste des users</span>
    <span style="color: #ffcb6b;">selected</span> = <span style="color: #89DDFF;">await</span> main_msg.reactions<span style="color: #c792ea;">[</span>0<span style="color: #c792ea;">]</span>.users<span style="color: #c792ea;">()</span>.flatten<span style="color: #c792ea;">()</span>
    <span style="color: #ffcb6b;">selected_tags</span> = <span style="color: #c792ea;">[</span>dtag<span style="color: #f78c6c;">(</span>u<span style="color: #f78c6c;">)</span> <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> selected<span style="color: #c792ea;">][</span>1:<span style="color: #c792ea;">]</span>
    <span style="color: #ffcb6b;">selected_snow</span> = <span style="color: #c792ea;">{</span>t: u.<span style="color: #82aaff;">id</span> <span style="color: #89DDFF;">for</span> t, u <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">zip</span><span style="color: #f78c6c;">(</span>selected_tags, selected<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">}</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">R&#233;cup&#233;ration des don&#233;nes du Gdoc roster</span>
    <span style="color: #ffcb6b;">roster</span> = get_roster<span style="color: #c792ea;">(</span>config<span style="color: #c792ea;">)</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">Joueurs s&#233;l&#233;ctionn&#233;s n'ayant pas rempli le Gdoc</span>
    <span style="color: #ffcb6b;">not_registered</span> = <span style="color: #c792ea;">[</span>u <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> selected_tags <span style="color: #89DDFF;">if</span> u <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> roster.index<span style="color: #c792ea;">]</span>

    <span style="color: #556369;"># </span><span style="color: #556369;">Filtrage du roster avec les joueurs s&#233;l&#233;ctionn&#233;s</span>
    <span style="color: #ffcb6b;">roster</span> = roster.<span style="color: #82aaff;">filter</span><span style="color: #c792ea;">(</span>items=selected_tags, axis=0<span style="color: #c792ea;">)</span>.set_index<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'Pseudo IG'</span><span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">print</span><span style="color: #c792ea;">(</span>roster<span style="color: #c792ea;">)</span>
    <span style="color: #556369;"># </span><span style="color: #556369;">R&#233;cup&#233;ration de la strat</span>
    <span style="color: #ffcb6b;">strat</span> = get_strat<span style="color: #c792ea;">(</span>config<span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">comp</span> = build_comp<span style="color: #c792ea;">(</span>roster, strat<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">gen_embed</span><span style="color: #c792ea;">(</span>comp<span style="color: #c792ea;">)</span>:
       <span style="color: #ffcb6b;">e</span> = discord.Embed<span style="color: #c792ea;">(</span>title=<span style="color: #c3e88d;">"Composition d'arm&#233;e"</span><span style="color: #c792ea;">)</span>
       <span style="color: #89DDFF;">for</span> k, v <span style="color: #89DDFF;">in</span> comp.iteritems<span style="color: #c792ea;">()</span>:
           <span style="color: #ffcb6b;">f</span> = <span style="color: #c3e88d;">''</span>
           <span style="color: #89DDFF;">for</span> p <span style="color: #89DDFF;">in</span> v.to_list<span style="color: #c792ea;">()</span>:
               <span style="color: #ffcb6b;">f</span> += p + <span style="color: #c3e88d;">'\n'</span>
           e.add_field<span style="color: #c792ea;">(</span>name=k, value=f, inline=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>
       <span style="color: #89DDFF;">return</span> e


    <span style="color: #89DDFF;">await</span> channel.send<span style="color: #c792ea;">(</span>embed=gen_embed<span style="color: #f78c6c;">(</span>comp<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org35264af"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">gen_embed</span><span style="color: #c792ea;">(</span>comp<span style="color: #c792ea;">)</span>:
   <span style="color: #ffcb6b;">e</span> = discord.Embed<span style="color: #c792ea;">(</span>title=<span style="color: #c3e88d;">"Composition d'arm&#233;e"</span><span style="color: #c792ea;">)</span>
   <span style="color: #89DDFF;">for</span> k, v <span style="color: #89DDFF;">in</span> comp.iteritems<span style="color: #c792ea;">()</span>:
       <span style="color: #ffcb6b;">f</span> = <span style="color: #c3e88d;">''</span>
       <span style="color: #89DDFF;">for</span> p <span style="color: #89DDFF;">in</span> v.to_list<span style="color: #c792ea;">()</span>:
           <span style="color: #ffcb6b;">f</span> += p + <span style="color: #c3e88d;">'\n'</span>
       e.add_field<span style="color: #c792ea;">(</span>name=k, value=f, inline=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>
   <span style="color: #89DDFF;">return</span> e


</pre>
</div>
</div>


<div id="outline-container-org9ade877" class="outline-4">
<h4 id="org9ade877"><span class="section-number-4">2.4.1</span> DM des joueurs qui n'ont pas renseigné leurs rôles</h4>
<div class="outline-text-4" id="text-2-4-1">
<p>
Cette phase n'est pas absolument nécessaire, mais elle permet de
notifier directement en message privé les utilisateurs qui se
signalent dans le fort mais qui n'ont pas correctement rempli le
gdoc. Cela leur laisse potentiellement le temps de le faire avant que
le lead demande le calcul de la composition du groupement de défense.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #c792ea;">@bot.event</span>
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">on_reaction_add</span><span style="color: #c792ea;">(</span>reaction, user<span style="color: #c792ea;">)</span>:
     <span style="color: #556369;"># </span><span style="color: #556369;">On v&#233;rifie que la r&#233;action est sur un message panneau</span>
     <span style="color: #89DDFF;">if</span> reaction.message.<span style="color: #82aaff;">id</span> <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> msgs_ids:
         <span style="color: #89DDFF;">return</span>
     <span style="color: #89DDFF;">if</span> user == bot.user:
         <span style="color: #89DDFF;">return</span>

     <span style="color: #556369;"># </span><span style="color: #556369;">R&#233;cup&#233;ration des don&#233;nes du Gdoc roster</span>
     <span style="color: #ffcb6b;">df</span> = get_roster<span style="color: #c792ea;">(</span>config<span style="color: #c792ea;">)</span>
     <span style="color: #89DDFF;">if</span> dtag<span style="color: #c792ea;">(</span>user<span style="color: #c792ea;">)</span> <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> df.index:
         <span style="color: #ffcb6b;">embed</span> = discord.Embed.from_dict<span style="color: #c792ea;">(</span>config<span style="color: #f78c6c;">[</span><span style="color: #c3e88d;">"embeds"</span><span style="color: #f78c6c;">][</span><span style="color: #c3e88d;">"dm"</span><span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>
         <span style="color: #ffcb6b;">embed.description</span> += f<span style="color: #c3e88d;">'{config["gdoc"]["form"]}) ***!***'</span>
         <span style="color: #89DDFF;">try</span>:
             <span style="color: #89DDFF;">await</span> user.send<span style="color: #c792ea;">(</span>embed=embed<span style="color: #c792ea;">)</span>
         <span style="color: #89DDFF;">except</span> discord.errors.HTTPException <span style="color: #89DDFF;">as</span> e:
             <span style="color: #89DDFF;">pass</span>
     <span style="color: #89DDFF;">else</span>:
         <span style="color: #ffcb6b;">guild</span> = reaction.message.guild
         <span style="color: #ffcb6b;">role</span> = guild.get_role<span style="color: #c792ea;">(</span>config<span style="color: #f78c6c;">[</span><span style="color: #c3e88d;">"ids"</span><span style="color: #f78c6c;">][</span><span style="color: #c3e88d;">"role"</span><span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>
         <span style="color: #89DDFF;">if</span> role <span style="color: #89DDFF;">is</span> <span style="color: #f78c6c;">None</span>:
             <span style="color: #556369;"># </span><span style="color: #556369;">Make sure the role still exists and is valid.</span>
             <span style="color: #89DDFF;">return</span>

         <span style="color: #89DDFF;">try</span>:
             <span style="color: #556369;"># </span><span style="color: #556369;">Finally, add the role.</span>
             <span style="color: #89DDFF;">await</span> user.add_roles<span style="color: #c792ea;">(</span>role<span style="color: #c792ea;">)</span>
         <span style="color: #89DDFF;">except</span> discord.HTTPException:
             <span style="color: #556369;"># </span><span style="color: #556369;">If we want to do something in case of errors we'd do it here.</span>
             <span style="color: #89DDFF;">pass</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-orgd321ce6" class="outline-4">
<h4 id="orgd321ce6"><span class="section-number-4">2.4.2</span> Vérification des enregistrés</h4>
<div class="outline-text-4" id="text-2-4-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #c792ea;">@bot.command</span><span style="color: #c792ea;">()</span>
<span style="color: #89DDFF;">async def</span> <span style="color: #82aaff;">verif</span><span style="color: #c792ea;">(</span>ctx<span style="color: #c792ea;">)</span>:
    <span style="color: #556369;">""" Attribue les r&#244;les</span>
<span style="color: #556369;">    """</span>
    <span style="color: #89DDFF;">print</span><span style="color: #c792ea;">(</span>f<span style="color: #c3e88d;">'!verif command invoked by {dtag(ctx.author)}'</span><span style="color: #c792ea;">)</span>

    <span style="color: #ffcb6b;">guild</span> = ctx.guild
    <span style="color: #ffcb6b;">lead_role</span> = guild.get_role<span style="color: #c792ea;">(</span>config<span style="color: #f78c6c;">[</span><span style="color: #c3e88d;">"ids"</span><span style="color: #f78c6c;">][</span><span style="color: #c3e88d;">"leads"</span><span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>

    <span style="color: #89DDFF;">if</span> ctx.author <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> lead_role.members:
        <span style="color: #ffcb6b;">embed</span> = discord.Embed<span style="color: #c792ea;">(</span>title=<span style="color: #c3e88d;">'Droits insuffisants'</span><span style="color: #c792ea;">)</span>
        <span style="color: #ffcb6b;">embed.color</span> = 16748319
        <span style="color: #ffcb6b;">embed.description</span> = f<span style="color: #c3e88d;">'R&#244;le ***{lead_role}*** requis'</span>
        <span style="color: #89DDFF;">await</span> ctx.channel.send<span style="color: #c792ea;">(</span>embed=embed<span style="color: #c792ea;">)</span>
        <span style="color: #89DDFF;">return</span>
    <span style="color: #556369;"># </span><span style="color: #556369;">R&#233;cup&#233;ration des don&#233;nes du Gdoc roster</span>
    <span style="color: #ffcb6b;">roster</span> = get_roster<span style="color: #c792ea;">(</span>config<span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">roster</span> = <span style="color: #82aaff;">list</span><span style="color: #c792ea;">(</span>roster.index<span style="color: #c792ea;">)</span>


    <span style="color: #ffcb6b;">members</span> = <span style="color: #c792ea;">{</span>dtag<span style="color: #f78c6c;">(</span>m<span style="color: #f78c6c;">)</span>: m <span style="color: #89DDFF;">for</span> m <span style="color: #89DDFF;">in</span> guild.members<span style="color: #c792ea;">}</span>

    <span style="color: #ffcb6b;">role</span> = guild.get_role<span style="color: #c792ea;">(</span>config<span style="color: #f78c6c;">[</span><span style="color: #c3e88d;">"ids"</span><span style="color: #f78c6c;">][</span><span style="color: #c3e88d;">"role"</span><span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">verified</span> = <span style="color: #c792ea;">[</span>dtag<span style="color: #f78c6c;">(</span>m<span style="color: #f78c6c;">)</span> <span style="color: #89DDFF;">for</span> m <span style="color: #89DDFF;">in</span> role.members<span style="color: #c792ea;">]</span>

    <span style="color: #ffcb6b;">added</span> = <span style="color: #c792ea;">[]</span>
    <span style="color: #ffcb6b;">wrong</span> = <span style="color: #c792ea;">[]</span>
    <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> roster:
       <span style="color: #89DDFF;">if</span> u <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> members:
           <span style="color: #ffcb6b;">wrong</span> += <span style="color: #c792ea;">[</span>u<span style="color: #c792ea;">]</span>
       <span style="color: #89DDFF;">elif</span> u <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> verified:
           <span style="color: #89DDFF;">if</span> role <span style="color: #89DDFF;">is</span> <span style="color: #f78c6c;">None</span>:
               <span style="color: #556369;"># </span><span style="color: #556369;">Make sure the role still exists and is valid.</span>
               <span style="color: #89DDFF;">return</span>

           <span style="color: #89DDFF;">try</span>:
               <span style="color: #556369;"># </span><span style="color: #556369;">Finally, add the role.</span>
               <span style="color: #89DDFF;">await</span> members<span style="color: #c792ea;">[</span>u<span style="color: #c792ea;">]</span>.add_roles<span style="color: #c792ea;">(</span>role<span style="color: #c792ea;">)</span>
               <span style="color: #ffcb6b;">added</span> += <span style="color: #c792ea;">[</span>u<span style="color: #c792ea;">]</span>
           <span style="color: #89DDFF;">except</span> discord.HTTPException:
               <span style="color: #556369;"># </span><span style="color: #556369;">If we want to do something in case of errors we'd do it here.</span>
               <span style="color: #89DDFF;">pass</span>

    <span style="color: #ffcb6b;">removed</span> = <span style="color: #c792ea;">[]</span>
    <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> verified:
        <span style="color: #89DDFF;">if</span> u <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> roster:
            <span style="color: #89DDFF;">try</span>:
                <span style="color: #556369;"># </span><span style="color: #556369;">Finally, remove the role.</span>
                <span style="color: #89DDFF;">await</span> members<span style="color: #c792ea;">[</span>u<span style="color: #c792ea;">]</span>.remove_roles<span style="color: #c792ea;">(</span>role<span style="color: #c792ea;">)</span>
                <span style="color: #ffcb6b;">removed</span> += <span style="color: #c792ea;">[</span>u<span style="color: #c792ea;">]</span>

                <span style="color: #556369;"># </span><span style="color: #556369;">Send DM to user</span>
                <span style="color: #ffcb6b;">embed</span> = discord.Embed.from_dict<span style="color: #c792ea;">(</span>config<span style="color: #f78c6c;">[</span><span style="color: #c3e88d;">"embeds"</span><span style="color: #f78c6c;">][</span><span style="color: #c3e88d;">"change"</span><span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>
                <span style="color: #ffcb6b;">embed.description</span> += f<span style="color: #c3e88d;">'{config["gdoc"]["form"]}) ***!***'</span>
                <span style="color: #89DDFF;">await</span> members<span style="color: #c792ea;">[</span>u<span style="color: #c792ea;">]</span>.send<span style="color: #c792ea;">(</span>embed=embed<span style="color: #c792ea;">)</span>
            <span style="color: #89DDFF;">except</span> discord.HTTPException:
                <span style="color: #556369;"># </span><span style="color: #556369;">If we want to do something in case of errors we'd do it here.</span>
                <span style="color: #89DDFF;">pass</span>

    <span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">list_to_field</span><span style="color: #c792ea;">(</span>l<span style="color: #c792ea;">)</span>:
        <span style="color: #ffcb6b;">f</span> = <span style="color: #c3e88d;">'aucun'</span>
        <span style="color: #89DDFF;">if</span> l:
            <span style="color: #ffcb6b;">f</span> = <span style="color: #c3e88d;">''</span>
            <span style="color: #89DDFF;">for</span> u <span style="color: #89DDFF;">in</span> l:
                <span style="color: #ffcb6b;">f</span> += u + <span style="color: #c3e88d;">'\n'</span>
        <span style="color: #89DDFF;">return</span> f

    <span style="color: #ffcb6b;">embed</span> = discord.Embed<span style="color: #c792ea;">()</span>
    <span style="color: #ffcb6b;">embed.title</span> = f<span style="color: #c3e88d;">'V&#233;rification du gdoc'</span>
    <span style="color: #ffcb6b;">embed.color</span> = 2003199
    embed.set_footer<span style="color: #c792ea;">(</span>text=ctx.author.name, icon_url = ctx.author.avatar_url<span style="color: #c792ea;">)</span>

    embed.add_field<span style="color: #c792ea;">(</span>name=<span style="color: #c3e88d;">"Joueurs V&#233;rifi&#233;s"</span>, value=list_to_field<span style="color: #f78c6c;">(</span>added<span style="color: #f78c6c;">)</span>, inline=<span style="color: #f78c6c;">False</span><span style="color: #c792ea;">)</span>
    embed.add_field<span style="color: #c792ea;">(</span>name=<span style="color: #c3e88d;">"Mauvais Discord tag rentr&#233;s"</span>, value=list_to_field<span style="color: #f78c6c;">(</span>wrong<span style="color: #f78c6c;">)</span>, inline=<span style="color: #f78c6c;">False</span><span style="color: #c792ea;">)</span>
    embed.add_field<span style="color: #c792ea;">(</span>name=<span style="color: #c3e88d;">"Joueurs ayant chang&#233; de Discord tag (r&#244;le supprim&#233;)"</span>, value=list_to_field<span style="color: #f78c6c;">(</span>removed<span style="color: #f78c6c;">)</span>, inline=<span style="color: #f78c6c;">False</span><span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">await</span> ctx.channel.send<span style="color: #c792ea;">(</span>embed=embed<span style="color: #c792ea;">)</span>
    <span style="color: #556369;">#</span><span style="color: #556369;">print(added, wrong)</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-org92233f4" class="outline-4">
<h4 id="org92233f4"><span class="section-number-4">2.4.3</span> Run</h4>
<div class="outline-text-4" id="text-2-4-3">
<div class="org-src-container">
<pre class="src src-python">bot.run<span style="color: #c792ea;">(</span>token<span style="color: #c792ea;">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org49198b2" class="outline-2">
<h2 id="org49198b2"><span class="section-number-2">3</span> Algo</h2>
<div class="outline-text-2" id="text-3">
<p>
Dépendances
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">import</span> numpy <span style="color: #89DDFF;">as</span> np
<span style="color: #89DDFF;">import</span> pandas <span style="color: #89DDFF;">as</span> pd
<span style="color: #89DDFF;">from</span> scipy.optimize <span style="color: #89DDFF;">import</span> linear_sum_assignment
</pre>
</div>

<p>
Récupération du roster de test
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">get_test_roster</span><span style="color: #c792ea;">()</span>:
    <span style="color: #ffcb6b;">page</span>= <span style="color: #c3e88d;">'Roster'</span>
    <span style="color: #ffcb6b;">url</span> = f<span style="color: #c3e88d;">"https://docs.google.com/spreadsheets/d/1FgtMvUQbLxP7qvXt2tnVwFFyX9KWnuREHu7o0RtX13M/gviz/tq?tqx=out:csv&amp;sheet={page}"</span>
    <span style="color: #556369;">#</span><span style="color: #556369;">return pd.read_csv(url).iloc[:, 0:16].dropna().set_index('dtag')</span>
    <span style="color: #89DDFF;">return</span> pd.read_csv<span style="color: #c792ea;">(</span>url<span style="color: #c792ea;">)</span>.set_index<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'dtag'</span><span style="color: #c792ea;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">get_test_strat</span><span style="color: #c792ea;">()</span>:
  <span style="color: #ffcb6b;">page</span>= <span style="color: #c3e88d;">'Strat'</span>
  <span style="color: #ffcb6b;">url</span> = f<span style="color: #c3e88d;">"https://docs.google.com/spreadsheets/d/1vDZ_p6Bq2oyyY0CV1SQ0FBRtJoGbtiurM9cOQWHJ-qo/gviz/tq?tqx=out:csv&amp;sheet={page}"</span>
  <span style="color: #89DDFF;">return</span> pd.read_csv<span style="color: #c792ea;">(</span>url<span style="color: #c792ea;">)</span>.iloc<span style="color: #c792ea;">[</span>0:5, 0:12<span style="color: #c792ea;">]</span>
</pre>
</div>

<p>
Identification des Rôles :
</p>
<div class="org-src-container">
<pre class="src src-python">
<span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">build_comp</span><span style="color: #c792ea;">(</span>roster, strat<span style="color: #c792ea;">)</span>:
    <span style="color: #ffcb6b;">roles</span> = <span style="color: #c792ea;">{}</span>
    <span style="color: #89DDFF;">for</span> index, row <span style="color: #89DDFF;">in</span> strat.iterrows<span style="color: #c792ea;">()</span>:
        <span style="color: #89DDFF;">for</span> v <span style="color: #89DDFF;">in</span> row:
            <span style="color: #89DDFF;">if</span> v <span style="color: #89DDFF;">in</span> roles:
                <span style="color: #ffcb6b;">roles</span><span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span> += 1
            <span style="color: #89DDFF;">else</span>:
                <span style="color: #ffcb6b;">roles</span><span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span> = 1

    <span style="color: #ffcb6b;">max_roles</span> = <span style="color: #c792ea;">{</span>k: v.<span style="color: #82aaff;">max</span><span style="color: #f78c6c;">()</span> <span style="color: #89DDFF;">for</span> k,v <span style="color: #89DDFF;">in</span> roster.iteritems<span style="color: #f78c6c;">()</span><span style="color: #c792ea;">}</span>

    <span style="color: #ffcb6b;">cols</span> = <span style="color: #c792ea;">[</span>k <span style="color: #89DDFF;">for</span> k, v <span style="color: #89DDFF;">in</span> roles.items<span style="color: #f78c6c;">()</span> <span style="color: #89DDFF;">for</span> _ <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">range</span><span style="color: #f78c6c;">(</span>v<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">]</span>
    <span style="color: #ffcb6b;">rows</span> = roster.index

    <span style="color: #ffcb6b;">C</span> = np.zeros<span style="color: #c792ea;">(</span><span style="color: #f78c6c;">(</span><span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>rows<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>cols<span style="color: #c3e88d;">)</span><span style="color: #f78c6c;">)</span>, dtype=<span style="color: #82aaff;">int</span><span style="color: #c792ea;">)</span>

    <span style="color: #89DDFF;">for</span> i, r <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">enumerate</span><span style="color: #c792ea;">(</span>rows<span style="color: #c792ea;">)</span>:
        <span style="color: #89DDFF;">for</span> j, c <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">enumerate</span><span style="color: #c792ea;">(</span>cols<span style="color: #c792ea;">)</span>:
            <span style="color: #ffcb6b;">C</span><span style="color: #c792ea;">[</span>i, j<span style="color: #c792ea;">]</span> = roster.at<span style="color: #c792ea;">[</span>r, c<span style="color: #c792ea;">]</span>

    <span style="color: #ffcb6b;">row_ind</span>, <span style="color: #ffcb6b;">X</span> = linear_sum_assignment<span style="color: #c792ea;">(</span>C, maximize=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">score</span> = C<span style="color: #c792ea;">[</span>row_ind, X<span style="color: #c792ea;">]</span>.<span style="color: #82aaff;">sum</span><span style="color: #c792ea;">()</span>
    <span style="color: #ffcb6b;">assignent</span> = <span style="color: #c792ea;">{</span>p: cols<span style="color: #f78c6c;">[</span>t<span style="color: #f78c6c;">]</span> <span style="color: #89DDFF;">for</span> p, t <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">zip</span><span style="color: #f78c6c;">(</span>rows, X<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">}</span>

    <span style="color: #ffcb6b;">filed_roles</span> = <span style="color: #c792ea;">{}</span>
    <span style="color: #89DDFF;">for</span> k, v <span style="color: #89DDFF;">in</span> assignent.items<span style="color: #c792ea;">()</span>:
        <span style="color: #556369;">#</span><span style="color: #556369;">print(k, v)</span>
        <span style="color: #89DDFF;">if</span> v <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> filed_roles:
            <span style="color: #ffcb6b;">filed_roles</span><span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span> = <span style="color: #c792ea;">[</span>k<span style="color: #c792ea;">]</span>
        <span style="color: #89DDFF;">else</span>:
            <span style="color: #ffcb6b;">filed_roles</span><span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span> += <span style="color: #c792ea;">[</span>k<span style="color: #c792ea;">]</span>

    <span style="color: #ffcb6b;">comp</span> = strat.copy<span style="color: #c792ea;">()</span>
    <span style="color: #89DDFF;">for</span> i, row <span style="color: #89DDFF;">in</span> comp.iterrows<span style="color: #c792ea;">()</span>:
        <span style="color: #89DDFF;">for</span> j, v <span style="color: #89DDFF;">in</span> row.items<span style="color: #c792ea;">()</span>:
            <span style="color: #89DDFF;">if</span> v <span style="color: #89DDFF;">in</span> filed_roles <span style="color: #89DDFF;">and</span> filed_roles<span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span>:
                <span style="color: #ffcb6b;">p</span> = filed_roles<span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span>.pop<span style="color: #c792ea;">()</span>
                <span style="color: #ffcb6b;">comp.at</span><span style="color: #c792ea;">[</span>i, j<span style="color: #c792ea;">]</span> = f<span style="color: #c3e88d;">'**{p}** *{comp.at[i, j]}* {roster.at[p, v] / max_roles[v]:.1f}'</span>
    <span style="color: #89DDFF;">return</span> comp
</pre>
</div>

<p>
Création des colonnes avec les noms de rôles, les lignes avec les noms
de joueurs, et de la matrice de coûts.
</p>
<div class="org-src-container">
<pre class="src src-python" id="orge46c180">
<span style="color: #ffcb6b;">cols</span> = <span style="color: #c792ea;">[</span>k <span style="color: #89DDFF;">for</span> k, v <span style="color: #89DDFF;">in</span> roles.items<span style="color: #f78c6c;">()</span> <span style="color: #89DDFF;">for</span> _ <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">range</span><span style="color: #f78c6c;">(</span>v<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">]</span>
<span style="color: #ffcb6b;">rows</span> = roster.index

<span style="color: #ffcb6b;">C</span> = np.zeros<span style="color: #c792ea;">(</span><span style="color: #f78c6c;">(</span><span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>rows<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>cols<span style="color: #c3e88d;">)</span><span style="color: #f78c6c;">)</span>, dtype=<span style="color: #82aaff;">int</span><span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">for</span> i, r <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">enumerate</span><span style="color: #c792ea;">(</span>rows<span style="color: #c792ea;">)</span>:
    <span style="color: #89DDFF;">for</span> j, c <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">enumerate</span><span style="color: #c792ea;">(</span>cols<span style="color: #c792ea;">)</span>:
        <span style="color: #ffcb6b;">C</span><span style="color: #c792ea;">[</span>i, j<span style="color: #c792ea;">]</span> = roster.at<span style="color: #c792ea;">[</span>r, c<span style="color: #c792ea;">]</span>
</pre>
</div>


<p>
Résolution du problème d'affectation avec la maximisation suivante :
\[max \sum_{i} \sum_{j} C_{i,j} X_{i,j}\]
</p>
<div class="org-src-container">
<pre class="src src-python" id="org7a0bb15">
<span style="color: #ffcb6b;">row_ind</span>, <span style="color: #ffcb6b;">X</span> = linear_sum_assignment<span style="color: #c792ea;">(</span>C, maximize=<span style="color: #f78c6c;">True</span><span style="color: #c792ea;">)</span>
<span style="color: #ffcb6b;">score</span> = C<span style="color: #c792ea;">[</span>row_ind, X<span style="color: #c792ea;">]</span>.<span style="color: #82aaff;">sum</span><span style="color: #c792ea;">()</span>
<span style="color: #ffcb6b;">assignent</span> = <span style="color: #c792ea;">{</span>p: cols<span style="color: #f78c6c;">[</span>t<span style="color: #f78c6c;">]</span> <span style="color: #89DDFF;">for</span> p, t <span style="color: #89DDFF;">in</span> <span style="color: #82aaff;">zip</span><span style="color: #f78c6c;">(</span>rows, X<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">}</span>

</pre>
</div>

<p>
Analyse des résultats
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">for</span> k, v <span style="color: #89DDFF;">in</span> assignent.items<span style="color: #c792ea;">()</span>:
    <span style="color: #89DDFF;">print</span><span style="color: #c792ea;">(</span>k, v, roster.at<span style="color: #f78c6c;">[</span>k, v<span style="color: #f78c6c;">]</span><span style="color: #c792ea;">)</span>

</pre>
</div>

<p>
Remplissage du tableau
</p>
<div class="org-src-container">
<pre class="src src-python" id="orgf91c98a"><span style="color: #ffcb6b;">filed_roles</span> = <span style="color: #c792ea;">{}</span>
<span style="color: #89DDFF;">for</span> k, v <span style="color: #89DDFF;">in</span> assignent.items<span style="color: #c792ea;">()</span>:
    <span style="color: #556369;">#</span><span style="color: #556369;">print(k, v)</span>
    <span style="color: #89DDFF;">if</span> v <span style="color: #89DDFF;">not</span> <span style="color: #89DDFF;">in</span> filed_roles:
        <span style="color: #ffcb6b;">filed_roles</span><span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span> = <span style="color: #c792ea;">[</span>k<span style="color: #c792ea;">]</span>
    <span style="color: #89DDFF;">else</span>:
        <span style="color: #ffcb6b;">filed_roles</span><span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span> += <span style="color: #c792ea;">[</span>k<span style="color: #c792ea;">]</span>

<span style="color: #ffcb6b;">comp</span> = strat.copy<span style="color: #c792ea;">()</span>
<span style="color: #89DDFF;">for</span> i, row <span style="color: #89DDFF;">in</span> comp.iterrows<span style="color: #c792ea;">()</span>:
    <span style="color: #89DDFF;">for</span> j, v <span style="color: #89DDFF;">in</span> row.items<span style="color: #c792ea;">()</span>:
        <span style="color: #89DDFF;">if</span> v <span style="color: #89DDFF;">in</span> filed_roles <span style="color: #89DDFF;">and</span> filed_roles<span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span>:
            <span style="color: #ffcb6b;">p</span> = filed_roles<span style="color: #c792ea;">[</span>v<span style="color: #c792ea;">]</span>.pop<span style="color: #c792ea;">()</span>
            <span style="color: #ffcb6b;">comp.at</span><span style="color: #c792ea;">[</span>i, j<span style="color: #c792ea;">]</span> = f<span style="color: #c3e88d;">'**{p}** *{comp.at[i, j]}* {roster.at[p, v] / max_roles[v]:.1f}'</span>
<span style="color: #89DDFF;">return</span> comp
</pre>
</div>
</div>

<div id="outline-container-org6966ed3" class="outline-3">
<h3 id="org6966ed3"><span class="section-number-3">3.1</span> Test algo</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">
<pre class="src src-python">
<span style="color: #89DDFF;">if</span> <span style="color: #82aaff;">__name__</span> == <span style="color: #c3e88d;">'__main__'</span>:
    <span style="color: #ffcb6b;">roster</span> = get_test_roster<span style="color: #c792ea;">()</span>.set_index<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'Pseudo IG'</span><span style="color: #c792ea;">)</span>
    roster.to_csv<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'roster.csv'</span><span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">print</span><span style="color: #c792ea;">(</span>roster<span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">strat</span> = get_test_strat<span style="color: #c792ea;">()</span>
    strat.to_csv<span style="color: #c792ea;">(</span><span style="color: #c3e88d;">'strat.csv'</span><span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">print</span><span style="color: #c792ea;">(</span>strat<span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">print</span><span style="color: #c792ea;">(</span>build_comp<span style="color: #f78c6c;">(</span>roster, strat<span style="color: #f78c6c;">)</span><span style="color: #c792ea;">)</span>
</pre>
</div>
</div>
<ol class="org-ol">
<li><a id="org1930c52"></a>Filtrage des joueurs<br />
<div class="outline-text-5" id="text-3-1-0-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #ffcb6b;">keys_to_extract</span> = <span style="color: #c792ea;">[]</span>
<span style="color: #ffcb6b;">a_subset</span> = <span style="color: #c792ea;">{</span>key: players<span style="color: #f78c6c;">[</span>key<span style="color: #f78c6c;">]</span> <span style="color: #89DDFF;">for</span> key <span style="color: #89DDFF;">in</span> keys_to_extract<span style="color: #c792ea;">}</span>
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Virgile Daugé</p>
<p class="date">Created: 2022-01-05 mer. 17:20</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
